{% extends 'base.html' %}

{% block page_title %}Inserisci Nuovo Trattamento{% endblock %}
{% block page_icon %}<i class="fas fa-plus-circle"></i>{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #007bff;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --danger-color: #dc3545;
        --light-bg: #f8f9fa;
        --border-color: #dee2e6;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .page-header {
        background: var(--gradient-primary);
        color: white;
        padding: 2rem 0;
        margin: -2rem -2rem 3rem -2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="white" opacity="0.1"><polygon points="1000,100 1000,0 0,100"/></svg>');
        background-size: cover;
    }

    .page-header-content {
        position: relative;
        z-index: 2;
    }

    .page-header h1 {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .page-header p {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 300;
    }

    /* Main Form Container */
    .form-container {
        background: white;
        border-radius: 20px;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .form-header {
        background: var(--gradient-success);
        color: white;
        padding: 1.5rem 2rem;
        text-align: center;
    }

    .form-header h2 {
        margin: 0;
        font-weight: 600;
        font-size: 1.4rem;
    }

    .form-content {
        padding: 2.5rem;
    }

    /* Step Indicator - Aggiornato per 3 step */
    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 3rem;
        position: relative;
        max-width: 450px;
        margin-left: auto;
        margin-right: auto;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        flex: 1;
    }

    .step-number {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
        position: relative;
        z-index: 2;
    }

    .step.active .step-number {
        background: var(--primary-color);
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0,123,255,0.3);
    }

    .step.completed .step-number {
        background: var(--success-color);
        color: white;
    }

    .step-label {
        font-size: 0.95rem;
        color: #6c757d;
        text-align: center;
        font-weight: 500;
        line-height: 1.3;
    }

    .step.active .step-label {
        color: var(--primary-color);
        font-weight: 600;
    }

    .step-connector {
        position: absolute;
        top: 30px;
        left: 60%;
        right: -60%;
        height: 3px;
        background: #e9ecef;
        z-index: 1;
        border-radius: 1.5px;
    }

    .step.completed .step-connector {
        background: var(--success-color);
    }

    .step:last-child .step-connector {
        display: none;
    }

    /* Form Steps */
    .form-step {
        display: none;
        animation: fadeInRight 0.5s ease-out;
    }

    .form-step.active {
        display: block;
    }

    @keyframes fadeInRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* Form Styling */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-label.required::after {
        content: ' *';
        color: var(--danger-color);
    }

    .form-control, .form-select {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        outline: none;
    }

    /* Selection Cards - LAYOUT ORIZZONTALE FORZATO */
    .selection-cards {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .selection-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        flex: 1;
        min-height: 180px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .selection-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,123,255,0.15);
    }

    .selection-card.selected {
        border-color: var(--success-color);
        background: linear-gradient(135deg, #f0fff4 0%, #e8f5e8 100%);
        box-shadow: 0 8px 25px rgba(40,167,69,0.2);
    }

    .selection-icon {
        font-size: 2.5rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }

    .selection-card.selected .selection-icon {
        color: var(--success-color);
    }

    .selection-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .selection-description {
        color: #6c757d;
        line-height: 1.4;
        margin-bottom: 1rem;
        font-size: 0.85rem;
        flex-grow: 1;
    }

    .selection-badge {
        background: var(--primary-color);
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }

    .selection-card.selected .selection-badge {
        background: var(--success-color);
    }

    /* Nascondi le card dopo la selezione */
    .selection-cards.hidden {
        display: none;
        animation: fadeOut 0.3s ease-out;
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-20px);
        }
    }

    /* Product List */
.product-list > * + * {
    margin-top: 1rem;
}

    .product-item {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        border: 2px solid #e9ecef;
        position: relative;
        margin-bottom: 1rem;
    }

    .product-remove {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: var(--danger-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .product-remove:hover {
        transform: scale(1.1);
    }

    .add-product-btn {
        background: linear-gradient(135deg, #e3f2fd 0%, #f1f8e9 100%);
        border: 2px dashed var(--primary-color);
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1rem;
    }

    .add-product-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,123,255,0.15);
    }

    /* Summary */
    .summary-box {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 2rem;
        border: 2px solid #e9ecef;
    }

    .summary-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #dee2e6;
    }

    .summary-item:last-child {
        border-bottom: none;
    }

    .summary-label {
        font-weight: 600;
        color: #6c757d;
    }

    .summary-value {
        color: #333;
        text-align: right;
    }

    /* Navigation */
    .form-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 2px solid #e9ecef;
    }

    .btn {
        padding: 0.75rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-size: 1rem;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-success {
        background: var(--success-color);
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Loading */
    .loading {
        display: none;
        text-align: center;
        padding: 2rem;
        color: var(--primary-color);
    }

    .loading.show {
        display: block;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Form Row */
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    .input-group {
        display: flex;
        position: relative;
    }

    .input-group .form-control {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }

    .input-group-text {
        background: #e9ecef;
        border: 2px solid #e9ecef;
        border-left: none;
        border-top-right-radius: 10px;
        border-bottom-right-radius: 10px;
        padding: 0.75rem 1rem;
        font-weight: 600;
        color: #6c757d;
    }

    /* Interface Header */
    .interface-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
    }

    .interface-header h5 {
        margin: 0;
        color: #333;
    }

    /* Search and Filter Styling */
    .search-box {
        max-width: 400px;
        margin: 0 auto;
    }

    .filters-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        border: 1px solid #e9ecef;
    }

    .filters-row .form-group {
        margin-bottom: 0;
    }

    .filters-row .form-label {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        color: #495057;
    }

    /* Selection Interface */
    .selection-interface {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 2rem;
        border: 2px solid #e9ecef;
        animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .clients-grid,
    .cascine-grid,
    .terreni-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        max-height: 400px;
        overflow-y: auto;
        padding: 0.5rem;
        border-radius: 10px;
        background: white;
        border: 1px solid #e9ecef;
    }

    .selection-item {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 1rem;
        position: relative;
    }

    .selection-item:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,123,255,0.15);
    }

    .selection-item.selected {
        border-color: var(--success-color);
        background: linear-gradient(135deg, #f0fff4 0%, #e8f5e8 100%);
    }

    .selection-checkbox {
        width: 30px;
        height: 30px;
        border: 2px solid #dee2e6;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .selection-item.selected .selection-checkbox {
        background: var(--success-color);
        border-color: var(--success-color);
        color: white;
    }

    .selection-item:not(.selected) .selection-checkbox i {
        display: none;
    }

    .selection-content {
        flex: 1;
    }

    .selection-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.25rem;
    }

    .selection-info {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.125rem;
    }

    .selection-extra {
        font-size: 0.8rem;
        color: #adb5bd;
        font-style: italic;
    }

    .selection-item.selected .selection-name {
        color: var(--success-color);
        margin-bottom: 0.25rem;
    }

    .selection-info {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.125rem;
    }

    .selection-extra {
        font-size: 0.8rem;
        color: #adb5bd;
        font-style: italic;
    }

    .selection-item.selected .selection-name {
        color: var(--success-color);
    }
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .selection-cards {
            grid-template-columns: 1fr;
        }
        
        .step-indicator {
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .step {
            flex: none;
            min-width: 120px;
        }
        
        .step-connector {
            display: none;
        }

        .form-navigation {
            flex-direction: column;
            gap: 1rem;
        }

        .btn {
            width: 100%;
        }

        .selection-item.selected {
    border-color: #28a745 !important;
    background: linear-gradient(135deg, #f0fff4 0%, #e8f5e8 100%) !important;
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2) !important;
}

.selection-item.selected .selection-checkbox {
    background: #28a745 !important;
    border-color: #28a745 !important;
    color: white !important;
}

.selection-item.selected .selection-name {
    color: #28a745 !important;
    font-weight: 700 !important;
}
.suggestions-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #e9ecef;
    border-top: none;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
}

.suggestion-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
    transition: background-color 0.2s ease;
    display: flex;
    align-items: center;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.search-step {
    position: relative;
}

.search-step .search-box {
    position: relative;
}


/* Animazione quando viene selezionata */
.selection-item.selected {
    animation: selectedPulse 0.4s ease-out;
}

@keyframes selectedPulse {
    0% { 
        transform: translateY(0) scale(1); 
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.1);
    }
    50% { 
        transform: translateY(-4px) scale(1.02); 
        box-shadow: 0 8px 16px rgba(40, 167, 69, 0.3);
    }
    100% { 
        transform: translateY(-2px) scale(1); 
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
    }
}

/* 2. ✅ STILI PER DROPDOWN SUGGERIMENTI */
.suggestions-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #e9ecef;
    border-top: none;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    animation: dropdownSlide 0.2s ease-out;
}

@keyframes dropdownSlide {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.suggestion-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
    transform: translateX(4px);
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-item.text-muted {
    cursor: default;
    font-style: italic;
    justify-content: center;
}

.suggestion-item.text-muted:hover {
    background-color: transparent;
    transform: none;
}

/* 3. ✅ LAYOUT MIGLIORATO PER SEARCH STEPS */
.search-step {
    position: relative;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border-left: 4px solid #007bff;
}

.search-step h6 {
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #495057;
}

.search-step .search-box {
    position: relative;
}

.search-step .input-group {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-radius: 6px;
    overflow: hidden;
}

.search-step .form-control {
    border: none;
    padding: 0.75rem;
    font-size: 0.95rem;
}

.search-step .form-control:focus {
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.search-step .input-group-text {
    background: #007bff;
    color: white;
    border: none;
    padding: 0.75rem 1rem;
}

/* 4. ✅ STILI PER STEP SEQUENZIALI */
#cascina-selection-step,
#terreni-selection-area {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border-left: 4px solid #28a745;
    margin-top: 1rem;
    animation: stepSlideIn 0.3s ease-out;
}

@keyframes stepSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#cascina-selection-step h6,
#terreni-selection-area h6 {
    color: #28a745;
    font-weight: 600;
}

/* 5. ✅ MIGLIORAMENTI SELECT PER CASCINE */
#cascina-select-terreni {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    padding: 0.75rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#cascina-select-terreni:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
}

#cascina-select-terreni option {
    padding: 0.5rem;
}

/* 6. ✅ RESPONSIVE IMPROVEMENTS */
@media (max-width: 768px) {
    .selection-interface {
        padding: 1rem 0.5rem;
    }
    
    .clients-grid,
    .cascine-grid,
    .terreni-grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }
    
    .selection-item {
        padding: 0.75rem;
    }
    
    .suggestion-item {
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
    }
    
    .search-step {
        padding: 0.75rem;
        margin-bottom: 1rem;
    }
}

/* 7. ✅ LOADING STATES */
.loading-spinner {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #6c757d;
    font-size: 0.9rem;
}

.loading-spinner i {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* 8. ✅ ERROR STATES */
.error-message {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
    padding: 1rem;
    border-radius: 6px;
    text-align: center;
    margin: 1rem 0;
}

.info-message {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
    padding: 1rem;
    border-radius: 6px;
    text-align: center;
    margin: 1rem 0;
}

/* 9. ✅ ANIMATION UTILITIES */
.fade-in {
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.slide-up {
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 10. ✅ ACCESSIBILITY IMPROVEMENTS */
.selection-item:focus {
    outline: 2px solid #007bff;
    outline-offset: 2px;
}

.suggestion-item:focus {
    outline: 2px solid #007bff;
    outline-offset: -2px;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    .selection-item.selected {
        border-width: 3px;
        border-color: #000 !important;
    }
    
    .selection-item.selected .selection-checkbox {
        background: #000 !important;
        border-color: #000 !important;
    }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
    .selection-item,
    .suggestion-item,
    .suggestions-dropdown {
        animation: none;
        transition: none;
    }
    
    .selection-item.selected {
        transform: none;
    }
}

/* 11. ✅ PRINT STYLES */
@media print {
    .suggestions-dropdown,
    .search-step {
        display: none;
    }
    
    .selection-item {
        border: 1px solid #000;
        break-inside: avoid;
    }
    
    .selection-item.selected {
        background: #f0f0f0 !important;
    }
}

.suggestion-highlighted {
    background-color: #007bff !important;
    color: white !important;
}

.suggestion-highlighted i {
    color: white !important;
}

.suggestion-highlighted small {
    color: rgba(255, 255, 255, 0.8) !important;
}

.suggestion-item {
    transition: all 0.2s ease;
    cursor: pointer;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
}

.suggestion-item.suggestion-highlighted:hover {
    background-color: #0056b3 !important;
}

/* Indicatori visivi per istruzioni tastiera */
.search-step small {
    display: block;
    margin-top: 0.5rem;
    font-size: 0.8rem;
    color: #6c757d;
}

.search-step small i {
    color: #007bff;
}


</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="page-header-content">
        <h1><i class="fas fa-seedling me-3"></i>Nuovo Trattamento</h1>
        <p>Programmazione semplice e veloce - Solo 3 passaggi</p>
    </div>
</div>

<!-- Main Form -->
<div class="form-container">
    <div class="form-header">
        <h2><i class="fas fa-plus-circle me-2"></i>Creazione Rapida Trattamento</h2>
    </div>
    
    <div class="form-content">
        <!-- Step Indicator - Solo 3 step -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-label">Selezione<br>Target</div>
                <div class="step-connector"></div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-label">Prodotti<br>& Quantità</div>
                <div class="step-connector"></div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-label">Conferma<br>& Crea</div>
            </div>
        </div>

        <!-- Form -->
        <form id="trattamentoForm">
            {% csrf_token %}
            
            <!-- Step 1: Target Selection -->
            <div class="form-step active" id="form-step-1">
                <h3><i class="fas fa-crosshairs text-primary me-2"></i>Seleziona il Target del Trattamento</h3>
                <p class="text-muted mb-4">Scegli se il trattamento riguarda un'intera azienda, una cascina specifica o terreni selezionati.</p>
                
                <div class="selection-cards">
                    <div class="selection-card" onclick="selectTarget('cliente')">
                        <div class="selection-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="selection-title">Intera Azienda</div>
                        <div class="selection-description">
                            Applica il trattamento a tutti i terreni dell'azienda selezionata
                        </div>
                        <div class="selection-badge">
                            <i class="fas fa-users"></i> Per Cliente
                        </div>
                    </div>
                    
                    <div class="selection-card" onclick="selectTarget('cascina')">
                        <div class="selection-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <div class="selection-title">Cascina Specifica</div>
                        <div class="selection-description">
                            Applica il trattamento a tutti i terreni di una cascina
                        </div>
                        <div class="selection-badge">
                            <i class="fas fa-map-marker-alt"></i> Per Cascina
                        </div>
                    </div>
                    
                    <div class="selection-card" onclick="selectTarget('terreno')">
                        <div class="selection-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="selection-title">Terreni Specifici</div>
                        <div class="selection-description">
                            Seleziona manualmente i terreni da trattare
                        </div>
                        <div class="selection-badge">
                            <i class="fas fa-list-check"></i> Selezione Manuale
                        </div>
                    </div>
                </div>
                
                <!-- Dynamic content area -->
                <div id="target-selection-area" class="mt-4">
                    <!-- Content will be populated based on selection -->
                </div>
            </div>

            <!-- Step 2: Products -->
            <div class="form-step" id="form-step-2">
                <h3><i class="fas fa-flask text-primary me-2"></i>Prodotti e Quantità per Ettaro</h3>
                <p class="text-muted mb-4">Seleziona i prodotti da utilizzare e specifica le quantità per ettaro. Il sistema calcolerà automaticamente la quantità totale.</p>
                
                <div class="product-list" id="products-container">
                    <!-- I prodotti verranno aggiunti dinamicamente -->
                </div>
                
                <div class="add-product-btn" onclick="addProduct()">
                    <i class="fas fa-plus"></i>
                    <strong>Aggiungi Prodotto</strong>
                    <div class="text-muted">Clicca per aggiungere un nuovo prodotto al trattamento</div>
                </div>
            </div>

            <!-- Step 3: Summary (era step 4) -->
            <div class="form-step" id="form-step-3">
                <h3><i class="fas fa-check-circle text-success me-2"></i>Riepilogo e Conferma</h3>
                <p class="text-muted mb-4">Verifica tutti i dettagli del trattamento prima di confermarlo. Il trattamento verrà creato con stato "Programmato".</p>
                
                <div class="summary-box">
                    <div class="summary-title">
                        <i class="fas fa-clipboard-list"></i>
                        Dettagli Trattamento
                    </div>
                    <div id="final-summary">
                        <!-- Verrà popolato dinamicamente -->
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Creazione trattamento in corso...</p>
                </div>
            </div>

            <!-- Navigation -->
            <div class="form-navigation">
                <button type="button" class="btn btn-secondary" id="prev-btn" onclick="previousStep()" style="display: none;">
                    <i class="fas fa-arrow-left"></i> Indietro
                </button>
                
                <div></div> <!-- Spacer -->
                
                <button type="button" class="btn btn-primary" id="next-btn" onclick="nextStep()">
                    Avanti <i class="fas fa-arrow-right"></i>
                </button>
                
                <button type="button" class="btn btn-success" id="submit-btn" onclick="submitForm()" style="display: none;">
                    <i class="fas fa-check"></i> Crea Trattamento
                </button>
            </div>
        </form>
    </div>
</div>

<div id="keyboard-shortcuts" class="keyboard-shortcuts">
    <h6><i class="fas fa-keyboard me-1"></i>Scorciatoie Tastiera</h6>
    <div class="shortcut">
        <span>Naviga su/giù</span>
        <span class="key">↑ ↓</span>
    </div>
    <div class="shortcut">
        <span>Seleziona</span>
        <span class="key">Enter</span>
    </div>
    <div class="shortcut">
        <span>Chiudi</span>
        <span class="key">Esc</span>
    </div>
    <div class="shortcut">
        <span>Torna indietro</span>
        <span class="key">Alt + ←</span>
    </div>
</div>

<script>
// === GLOBAL VARIABLES ===
let currentStep = 1;
let maxSteps = 3; // ✅ Aggiornato a 3 step
let selectedTarget = null;
let selectedData = {
    clienti: [],
    cascine: [],
    terreni: []
};
let productCounter = 0;

// === STEP MANAGEMENT ===
function nextStep() {
    if (!validateCurrentStep()) return;
    
    if (currentStep < maxSteps) {
        currentStep++;
        updateStepDisplay();
        if (currentStep === 3) { // ✅ Aggiornato
            generateSummary();
        }
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
    }
}

function updateStepDisplay() {
    // Update step indicator
    for (let i = 1; i <= maxSteps; i++) {
        const step = document.getElementById(`step${i}`);
        const formStep = document.getElementById(`form-step-${i}`);
        
        step.classList.remove('active', 'completed');
        formStep.classList.remove('active');
        
        if (i < currentStep) {
            step.classList.add('completed');
        } else if (i === currentStep) {
            step.classList.add('active');
            formStep.classList.add('active');
        }
    }
    
    // Update navigation buttons
    document.getElementById('prev-btn').style.display = currentStep > 1 ? 'inline-flex' : 'none';
    document.getElementById('next-btn').style.display = currentStep < maxSteps ? 'inline-flex' : 'none';
    document.getElementById('submit-btn').style.display = currentStep === maxSteps ? 'inline-flex' : 'none';
}

// === VALIDATION ===
function validateCurrentStep() {
    if (currentStep === 1) {
        return validateStep1();
    } else if (currentStep === 2) {
        return validateStep2();
    } else if (currentStep === 3) { // ✅ Aggiornato
        return true; // Summary step
    }
    return false;
}

function validateStep1() {
    if (!selectedTarget) {
        showError('Seleziona un tipo di target per il trattamento');
        return false;
    }
    
    if (selectedTarget === 'cliente' && selectedData.clienti.length === 0) {
        showError('Seleziona almeno un cliente');
        return false;
    }
    
    if (selectedTarget === 'cascina' && selectedData.cascine.length === 0) {
        showError('Seleziona almeno una cascina');
        return false;
    }
    
    if (selectedTarget === 'terreno' && selectedData.terreni.length === 0) {
        showError('Seleziona almeno un terreno');
        return false;
    }
    
    return true;
}

function validateStep2() {
    const productItems = document.querySelectorAll('.product-item');
    
    if (productItems.length === 0) {
        showError('Aggiungi almeno un prodotto al trattamento');
        return false;
    }
    
    let hasValidProduct = false;
    productItems.forEach(item => {
        const select = item.querySelector('.product-select');
        const quantity = item.querySelector('.quantity-input');
        
        if (select.value && quantity.value && parseFloat(quantity.value) > 0) {
            hasValidProduct = true;
        }
    });
    
    if (!hasValidProduct) {
        showError('Specifica almeno un prodotto con quantità valida');
        return false;
    }
    
    return true;
}

// === SUMMARY GENERATION (SEMPLIFICATA) ===
function generateSummary() {
    console.log('Generazione riepilogo finale semplificato...');
    const summaryContainer = document.getElementById('final-summary');
    let summaryHTML = '';
    
    // Target info
    summaryHTML += `
        <div class="summary-item">
            <span class="summary-label">Target:</span>
            <span class="summary-value">${getTargetDescription()}</span>
        </div>
    `;
    
    // Surface info
    const superficie = getSuperficieTotale();
    summaryHTML += `
        <div class="summary-item">
            <span class="summary-label">Superficie Totale:</span>
            <span class="summary-value">${superficie.toFixed(2)} ettari</span>
        </div>
    `;
    
    // Products info
    const productItems = document.querySelectorAll('.product-item');
    productItems.forEach((item, index) => {
        const select = item.querySelector('.product-select');
        const quantity = item.querySelector('.quantity-input');
        
        if (select.value && quantity.value) {
            const productName = select.options[select.selectedIndex].text;
            const unita = select.options[select.selectedIndex].dataset.unita || '';
            const quantitaTotale = parseFloat(quantity.value) * superficie;
            
            summaryHTML += `
                <div class="summary-item">
                    <span class="summary-label">Prodotto ${index + 1}:</span>
                    <span class="summary-value">
                        ${productName} - ${quantity.value} ${unita}/ha
                        ${superficie > 0 ? ` = <strong>${quantitaTotale.toFixed(3)} ${unita} totali</strong>` : ''}
                    </span>
                </div>
            `;
        }
    });
    
    summaryHTML += `
        <div class="summary-item">
            <span class="summary-label">Stato:</span>
            <span class="summary-value">Programmato</span>
        </div>
    `;
    
    summaryContainer.innerHTML = summaryHTML;
}

// === SUBMIT FORM (SEMPLIFICATO) ===
function submitForm() {
     console.log('=== INIZIO SALVATAGGIO TRATTAMENTI ===');
    
    // Verifica selezioni
    if (!selectedTarget) {
        showError('Devi selezionare un tipo di trattamento');
        return;
    }
    
    let selectedCount = 0;
    if (selectedTarget === 'cliente') selectedCount = selectedData.clienti.length;
    else if (selectedTarget === 'cascina') selectedCount = selectedData.cascine.length;
    else if (selectedTarget === 'terreno') selectedCount = selectedData.terreni.length;
    
    if (selectedCount === 0) {
        showError('Devi selezionare almeno un elemento per il trattamento');
        return;
    }
    
    // ✅ RACCOLTA PRODOTTI CORRETTA
    const productContainers = document.querySelectorAll('.product-item');
    if (productContainers.length === 0) {
        showError('Devi aggiungere almeno un prodotto');
        return;
    }
    
    const prodottiData = [];
    let prodottiValidi = true;
    
    productContainers.forEach((container, index) => {
        const productSelect = container.querySelector('.product-select');
        const quantityInput = container.querySelector('.quantity-input');
        
        const prodotto_id = productSelect ? productSelect.value : '';
        const quantita_per_ettaro = quantityInput ? quantityInput.value : '';
        
        console.log(`Prodotto ${index + 1}:`, {
            prodotto_id,
            quantita_per_ettaro,
            valid: prodotto_id && quantita_per_ettaro && parseFloat(quantita_per_ettaro) > 0
        });
        
        if (!prodotto_id || !quantita_per_ettaro || parseFloat(quantita_per_ettaro) <= 0) {
            prodottiValidi = false;
        } else {
            // ✅ USA LA CHIAVE CORRETTA
            prodottiData.push({
                prodotto_id: parseInt(prodotto_id),
                quantita_per_ettaro: parseFloat(quantita_per_ettaro)
            });
        }
    });
    
    if (!prodottiValidi) {
        showError('Tutti i prodotti devono avere una quantità valida');
        return;
    }
    
    console.log('✅ Prodotti validati:', prodottiData);
    
    // Creazione trattamenti
    let trattamentiDaCreare = [];
    const noteAutomatiche = 'Trattamento programmato';
    
    if (selectedTarget === 'cliente') {
        selectedData.clienti.forEach(cliente => {
            trattamentiDaCreare.push({
                livello_applicazione: 'cliente',
                cliente: cliente.id,
                cascina: null,
                terreni_selezionati: [],
                prodotti_data: JSON.stringify(prodottiData), // ✅ STRINGIFY CORRETTO
                data_esecuzione_prevista: null,
                note: noteAutomatiche + ` [${cliente.nome}]`
            });
        });
    } else if (selectedTarget === 'cascina') {
        selectedData.cascine.forEach(cascina => {
            trattamentiDaCreare.push({
                livello_applicazione: 'cascina',
                cliente: cascina.cliente_id,
                cascina: cascina.id,
                terreni_selezionati: [],
                prodotti_data: JSON.stringify(prodottiData), // ✅ STRINGIFY CORRETTO
                data_esecuzione_prevista: null,
                note: noteAutomatiche + ` [${cascina.nome}]`
            });
        });
    } else if (selectedTarget === 'terreno') {
        trattamentiDaCreare.push({
            livello_applicazione: 'terreno',
            cliente: selectedData.terreni[0].cliente_id,
            cascina: selectedData.terreni[0].cascina_id,
            terreni_selezionati: selectedData.terreni.map(t => t.id),
            prodotti_data: JSON.stringify(prodottiData), // ✅ STRINGIFY CORRETTO
            data_esecuzione_prevista: null,
            note: noteAutomatiche + ` [${selectedData.terreni.length} terreni]`
        });
    }
    
    console.log('✅ Trattamenti da creare:', trattamentiDaCreare);
    createTrattamentiSequentially(trattamentiDaCreare);
}

// === UTILITY FUNCTIONS ===
function showError(message) {
    alert(message); // Sostituisci con una notifica più elegante se preferisci
}

function getTargetDescription() {
    if (selectedTarget === 'cliente') {
        return `${selectedData.clienti.length} Cliente${selectedData.clienti.length > 1 ? 'i' : ''}`;
    } else if (selectedTarget === 'cascina') {
        return `${selectedData.cascine.length} Cascina${selectedData.cascine.length > 1 ? 'e' : ''}`;
    } else if (selectedTarget === 'terreno') {
        return `${selectedData.terreni.length} Terreno${selectedData.terreni.length > 1 ? 'i' : ''}`;
    }
    return 'Non selezionato';
}

function getSuperficieTotale() {
    let superficie = 0;
    if (selectedTarget === 'terreno') {
        superficie = selectedData.terreni.reduce((sum, terreno) => sum + parseFloat(terreno.superficie || 0), 0);
    } else if (selectedTarget === 'cascina') {
        superficie = selectedData.cascine.reduce((sum, cascina) => sum + parseFloat(cascina.superficie_totale || 0), 0);
    } else if (selectedTarget === 'cliente') {
        superficie = selectedData.clienti.reduce((sum, cliente) => sum + parseFloat(cliente.superficie_totale || 0), 0);
    }
    return superficie;
}

// === TARGET SELECTION ===
function selectTarget(type) {
    selectedTarget = type;
    
    // Reset previous selections
    selectedData = {
        clienti: [],
        cascine: [],
        terreni: []
    };
    
    // Update UI
    document.querySelectorAll('.selection-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
    // Nascondi le card dopo 500ms per permettere di vedere la selezione
    setTimeout(() => {
        document.querySelector('.selection-cards').classList.add('hidden');
        
        // Mostra l'interfaccia di selezione appropriata
        setTimeout(() => {
            loadTargetSelection(type);
        }, 300);
    }, 500);
}

function loadTargetSelection(type) {
    const container = document.getElementById('target-selection-area');
    
    if (type === 'cliente') {
        container.innerHTML = `
            <div class="selection-interface">
                <div class="interface-header">
                    <h5><i class="fas fa-building text-primary me-2"></i>Seleziona Clienti con Terreni</h5>
                    <button class="btn btn-outline-secondary btn-sm" onclick="resetTargetSelection()">
                        <i class="fas fa-arrow-left me-1"></i>Cambia Tipo
                    </button>
                </div>
                
                <!-- Ricerca Clienti -->
                <div class="search-box mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="search-clienti" placeholder="Cerca cliente per nome..." onkeyup="filterClients()">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>
                
                <div class="clients-grid" id="clients-container">
                    {% for cliente in clienti %}
                    {% if cliente.get_superficie_totale > 0 %}
                    <div class="selection-item" 
                         data-name="{{ cliente.nome|lower }}" 
                         data-cliente-id="{{ cliente.id }}"
                         data-cliente-nome="{{ cliente.nome }}"
                         data-superficie="{{ cliente.get_superficie_totale }}"
                         onclick="toggleClienteSelectionSafe(this)">
                        <div class="selection-checkbox">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="selection-content">
                            <div class="selection-name">{{ cliente.nome }}</div>
                            <div class="selection-info">{{ cliente.get_superficie_totale|floatformat:2 }} ha totali</div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        `;
    } else if (type === 'cascina') {
        container.innerHTML = `
            <div class="selection-interface">
                <div class="interface-header">
                    <h5><i class="fas fa-home text-primary me-2"></i>Seleziona Cascine per Trattamento</h5>
                    <button class="btn btn-outline-secondary btn-sm" onclick="resetTargetSelection()">
                        <i class="fas fa-arrow-left me-1"></i>Cambia Tipo
                    </button>
                </div>
                
                <!-- Step 1: Ricerca Cliente -->
                <div class="search-step">
                    <h6><i class="fas fa-search"></i>1. Cerca e Seleziona Cliente</h6>
                    <div class="search-box">
                        <div class="input-group">
                            <input type="text" 
                                class="form-control" 
                                id="search-cliente-cascine" 
                                placeholder="Digita il nome del cliente..." 
                                autocomplete="off"
                                onkeyup="searchClienteForCascine()"
                                onkeydown="handleSearchKeydown(event)">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                        </div>
                        <div id="cliente-suggestions" class="suggestions-dropdown" style="display: none;"></div>
                    </div>
                    <small>
                        <i class="fas fa-keyboard"></i>
                        <strong>Scorciatoie:</strong> ↑/↓ naviga • Enter seleziona • Esc chiude
                    </small>
                </div>
                
                <!-- Step 2: Area Cascine (inizialmente nascosta) -->
                <div id="cascine-selection-area" style="display: none;">
                    <!-- Contenuto popolato dinamicamente da loadCascineForCliente -->
                </div>
            </div>
        `;
        
        // ✅ CARICA CLIENTI E INIZIALIZZA EVENTI
        loadClientiForSuggestions();
        
        // ✅ FOCUS AUTOMATICO SUL CAMPO RICERCA
        setTimeout(() => {
            const searchInput = document.getElementById('search-cliente-cascine');
            if (searchInput) {
                searchInput.focus();
            }
        }, 300);
    } else if (type === 'terreno') {
        container.innerHTML = `
            <div class="selection-interface">
                <div class="interface-header">
                    <h5><i class="fas fa-seedling text-primary me-2"></i>Seleziona Terreni per Trattamento</h5>
                    <button class="btn btn-outline-secondary btn-sm" onclick="resetTargetSelection()">
                        <i class="fas fa-arrow-left me-1"></i>Cambia Tipo
                    </button>
                </div>
                
                <!-- Step 1: Ricerca Cliente MIGLIORATA -->
                <div class="search-step">
                    <h6><i class="fas fa-search"></i>1. Cerca e Seleziona Cliente</h6>
                    <div class="search-box">
                        <div class="input-group">
                            <input type="text" 
                                class="form-control" 
                                id="search-cliente-terreni" 
                                placeholder="Digita il nome del cliente..." 
                                autocomplete="off"
                                onkeyup="searchClienteForTerreni()"
                                onkeydown="handleSearchKeydown(event)"
                                onfocus="showKeyboardShortcuts()"
                                onblur="hideKeyboardShortcuts()">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                        </div>
                        <div id="cliente-suggestions-terreni" class="suggestions-dropdown" style="display: none;"></div>
                    </div>
                    <small>
                        <i class="fas fa-keyboard"></i>
                        <strong>Scorciatoie:</strong> ↑/↓ naviga • Enter seleziona • Esc chiude
                    </small>
                </div>
                
                <!-- Step 2: Selezione Cascina -->
                <div id="cascina-selection-step" style="display: none;">
                    <div class="search-step">
                        <h6><i class="fas fa-home"></i>2. Seleziona la Cascina</h6>
                        <select class="form-select" id="cascina-select-terreni" onchange="selectCascinaForTerreni()">
                            <option value="">-- Seleziona una cascina --</option>
                        </select>
                    </div>
                </div>
                
                <!-- Step 3: Selezione Terreni -->
                <div id="terreni-selection-area" style="display: none;">
                    <div class="search-step">
                        <h6><i class="fas fa-seedling"></i>3. Seleziona i Terreni Desiderati</h6>
                        <div class="terreni-grid" id="terreni-container">
                            <!-- Popolato dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Carica clienti e inizializza eventi
        loadClientiForSuggestions();
        initializeSearchEvents();
    }
}

// === FUNZIONE PER TORNARE ALLA SELEZIONE DEL TIPO ===
function resetTargetSelection() {
    selectedTarget = null;
    selectedData = {
        clienti: [],
        cascine: [],
        terreni: []
    };
    
    // Mostra di nuovo le card
    const selectionCards = document.querySelector('.selection-cards');
    selectionCards.classList.remove('hidden');
    
    // Rimuovi selezioni
    document.querySelectorAll('.selection-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Pulisci l'area di selezione
    document.getElementById('target-selection-area').innerHTML = '';
}

// === SELECTION TOGGLES SICURE (leggono da data attributes) ===
function toggleClienteSelectionSafe(element) {
    const id = parseInt(element.dataset.clienteId);
    const nome = element.dataset.clienteNome;
    const superficie = parseFloat(element.dataset.superficie);
    
    console.log('Toggle cliente sicuro:', id, nome, superficie);
    
    const index = selectedData.clienti.findIndex(c => c.id === id);
    if (index > -1) {
        selectedData.clienti.splice(index, 1);
        element.classList.remove('selected');
    } else {
        selectedData.clienti.push({id, nome, superficie_totale: superficie});
        element.classList.add('selected');
    }
    
    updateSelectionUI();
    console.log('Clienti selezionati:', selectedData.clienti);
}

function toggleCascinaSelectionSafe(element) {
    const id = parseInt(element.dataset.cascinaId);
    const nome = element.dataset.cascinaNome;
    const clienteId = parseInt(element.dataset.clienteId);
    const clienteNome = element.dataset.clienteNome;
    const superficie = parseFloat(element.dataset.superficie);
    
    console.log('Toggle cascina sicuro:', id, nome, clienteId, clienteNome, superficie);
    
    const index = selectedData.cascine.findIndex(c => c.id === id);
    if (index > -1) {
        selectedData.cascine.splice(index, 1);
        element.classList.remove('selected');
    } else {
        selectedData.cascine.push({
            id, 
            nome, 
            cliente_id: clienteId, 
            cliente_nome: clienteNome,
            superficie_totale: superficie
        });
        element.classList.add('selected');
    }
    
    updateSelectionUI();
    console.log('Cascine selezionate:', selectedData.cascine);
}

function toggleTerrenoSelectionSafe(element) {
    const id = parseInt(element.dataset.terrenoId);
    const nome = element.dataset.terrenoNome;
    const cascinaId = parseInt(element.dataset.cascinaId);
    const clienteId = parseInt(element.dataset.clienteId);
    const superficie = parseFloat(element.dataset.superficie);
    
    console.log('Toggle terreno sicuro:', id, nome, cascinaId, clienteId, superficie);
    
    const index = selectedData.terreni.findIndex(t => t.id === id);
    if (index > -1) {
        selectedData.terreni.splice(index, 1);
        element.classList.remove('selected');
    } else {
        selectedData.terreni.push({
            id, 
            nome, 
            cascina_id: cascinaId, 
            cliente_id: clienteId, 
            superficie
        });
        element.classList.add('selected');
    }
    
    updateSelectionUI();
    console.log('Terreni selezionati:', selectedData.terreni);
}

// === SELECTION TOGGLES LEGACY (mantieni per compatibilità) ===
function toggleClienteSelection(id, nome, superficie) {
    console.log('ATTENZIONE: Usando metodo legacy per cliente', id, nome);
    const index = selectedData.clienti.findIndex(c => c.id === id);
    if (index > -1) {
        selectedData.clienti.splice(index, 1);
    } else {
        selectedData.clienti.push({id, nome, superficie_totale: superficie});
    }
    updateSelectionUI();
}

function toggleCascinaSelection(id, nome, clienteId, clienteNome, superficie) {
    console.log('ATTENZIONE: Usando metodo legacy per cascina', id, nome);
    const index = selectedData.cascine.findIndex(c => c.id === id);
    if (index > -1) {
        selectedData.cascine.splice(index, 1);
    } else {
        selectedData.cascine.push({
            id, 
            nome, 
            cliente_id: clienteId, 
            cliente_nome: clienteNome,
            superficie_totale: superficie
        });
    }
    updateSelectionUI();
}

function toggleTerrenoSelection(id, nome, cascinaId, clienteId, superficie) {
    console.log('ATTENZIONE: Usando metodo legacy per terreno', id, nome);
    const index = selectedData.terreni.findIndex(t => t.id === id);
    if (index > -1) {
        selectedData.terreni.splice(index, 1);
    } else {
        selectedData.terreni.push({
            id, 
            nome, 
            cascina_id: cascinaId, 
            cliente_id: clienteId, 
            superficie
        });
    }
    updateSelectionUI();
}

function updateSelectionUI() {
    document.querySelectorAll('.selection-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Mark selected items
    if (selectedTarget === 'cliente') {
        selectedData.clienti.forEach(cliente => {
            const item = document.querySelector(`[onclick*="toggleClienteSelection(${cliente.id}"]`);
            if (item) item.classList.add('selected');
        });
    } else if (selectedTarget === 'cascina') {
        selectedData.cascine.forEach(cascina => {
            const item = document.querySelector(`[onclick*="toggleCascinaSelection(${cascina.id}"]`);
            if (item) item.classList.add('selected');
        });
    } else if (selectedTarget === 'terreno') {
        selectedData.terreni.forEach(terreno => {
            const item = document.querySelector(`[onclick*="toggleTerrenoSelection(${terreno.id}"]`);
            if (item) item.classList.add('selected');
        });
    }
}

// === PRODUCT MANAGEMENT ===
function addProduct() {
    productCounter++;
    console.log('Aggiunta prodotto #', productCounter);
    
    const productItem = document.createElement('div');
    productItem.className = 'product-item';
    productItem.id = `product-${productCounter}`;
    productItem.innerHTML = `
        <button type="button" class="product-remove" onclick="removeProduct(${productCounter})">
            <i class="fas fa-times"></i>
        </button>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label required">Prodotto</label>
                <select class="form-select product-select" data-product-id="${productCounter}" onchange="updateProductInfo(${productCounter})">
                    <option value="">Seleziona un prodotto...</option>
                    {% for prodotto in prodotti %}
                    <option value="{{ prodotto.id }}" data-unita="{{ prodotto.unita_misura }}">{{ prodotto.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label required">Quantità per Ettaro</label>
                <div class="input-group">
                    <input type="number" class="form-control quantity-input" step="0.001" min="0.001" placeholder="0.000" onchange="updateQuantityCalculation(${productCounter})">
                    <span class="input-group-text" id="unit-${productCounter}">-</span>
                    <span class="input-group-text">/ha</span>
                </div>
                <div class="quantity-calculation" id="calc-${productCounter}" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                    <!-- Calcolo automatico apparirà qui -->
                </div>
            </div>
        </div>
        <div class="product-info" id="product-info-${productCounter}">
            <!-- Info prodotto verranno mostrate qui -->
        </div>
    `;
    
    document.getElementById('products-container').appendChild(productItem);
}

function removeProduct(id) {
    const productItem = document.getElementById(`product-${id}`);
    if (productItem) {
        productItem.remove();
    }
}

function updateProductInfo(productId) {
    const select = document.querySelector(`[data-product-id="${productId}"]`);
    const selectedOption = select.options[select.selectedIndex];
    const unitSpan = document.getElementById(`unit-${productId}`);
    
    if (selectedOption.value) {
        const unita = selectedOption.dataset.unita || '';
        unitSpan.textContent = unita;
        updateQuantityCalculation(productId);
    } else {
        unitSpan.textContent = '-';
        document.getElementById(`calc-${productId}`).innerHTML = '';
    }
}

function updateQuantityCalculation(productId) {
    const quantityInput = document.querySelector(`#product-${productId} .quantity-input`);
    const calcDiv = document.getElementById(`calc-${productId}`);
    const unitSpan = document.getElementById(`unit-${productId}`);
    
    const quantityPerHa = parseFloat(quantityInput.value) || 0;
    const superficie = getSuperficieTotale();
    const unita = unitSpan.textContent;
    
    if (quantityPerHa > 0 && superficie > 0) {
        const quantityTotal = quantityPerHa * superficie;
        calcDiv.innerHTML = `
            <i class="fas fa-calculator text-info me-1"></i>
            <strong>Totale: ${quantityTotal.toFixed(3)} ${unita}</strong>
            <small class="text-muted"> (${superficie.toFixed(2)} ha)</small>
        `;
    } else {
        calcDiv.innerHTML = '';
    }
}

// === SEQUENTIAL CREATION ===
function createTrattamentiSequentially(trattamentiDaCreare) {
    let createdCount = 0;
    let errors = [];
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    function createNext(index) {
        if (index >= trattamentiDaCreare.length) {
            // Tutti i trattamenti processati
            document.getElementById('loading').classList.remove('show');
            document.getElementById('submit-btn').disabled = false;
            
            if (createdCount > 0) {
                alert(`✅ Creati ${createdCount} trattamenti con successo!`);
                // Redirect alla pagina trattamenti
                window.location.href = '/trattamenti/?view=programmati';
            } else {
                alert('❌ Nessun trattamento è stato creato. Errori: ' + errors.join(', '));
            }
            return;
        }
        
        const trattamento = trattamentiDaCreare[index];
        const formData = new FormData();
        
        // Aggiungi tutti i dati del trattamento
        Object.keys(trattamento).forEach(key => {
            if (trattamento[key] !== null && trattamento[key] !== undefined) {
                formData.append(key, trattamento[key]);
            }
        });
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        fetch('/api/trattamenti/', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                createdCount++;
                console.log(`✅ Trattamento ${index + 1} creato:`, data);
            } else {
                errors.push(data.error || 'Errore sconosciuto');
                console.error(`❌ Errore trattamento ${index + 1}:`, data.error);
            }
            
            // Procedi al prossimo
            createNext(index + 1);
        })
        .catch(error => {
            errors.push(error.message);
            console.error(`❌ Errore rete trattamento ${index + 1}:`, error);
            createNext(index + 1);
        });
    }
    
    createNext(0);
}

// === FILTER FUNCTIONS ===
function filterClients() {
    const searchTerm = document.getElementById('search-clienti').value.toLowerCase();
    const items = document.querySelectorAll('#clients-container .selection-item');
    
    items.forEach(item => {
        const name = item.dataset.name;
        if (name.includes(searchTerm)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function filterCascineByCliente() {
    const selectedClienteId = document.getElementById('filter-cliente-cascine').value;
    const searchTerm = document.getElementById('search-cascine').value.toLowerCase();
    const items = document.querySelectorAll('#cascine-container .selection-item');
    
    items.forEach(item => {
        const clienteId = item.dataset.clienteId;
        const name = item.dataset.name;
        
        let showByCliente = !selectedClienteId || clienteId === selectedClienteId;
        let showBySearch = !searchTerm || name.includes(searchTerm);
        
        if (showByCliente && showBySearch) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function filterCascine() {
    filterCascineByCliente(); // Riusa la logica combinata
}

function filterTerreniByCliente() {
    const selectedClienteId = document.getElementById('filter-cliente-terreni').value;
    const selectedCascinaId = document.getElementById('filter-cascina-terreni').value;
    const searchTerm = document.getElementById('search-terreni').value.toLowerCase();
    const items = document.querySelectorAll('#terreni-container .selection-item');
    
    // Aggiorna il filtro cascine basato sul cliente selezionato
    if (selectedClienteId) {
        const cascinaOptions = document.querySelectorAll('#filter-cascina-terreni option[data-cliente-id]');
        cascinaOptions.forEach(option => {
            if (option.dataset.clienteId === selectedClienteId) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        });
        
        // Reset cascina selection se non più valida
        const cascinaSelect = document.getElementById('filter-cascina-terreni');
        const currentCascina = cascinaSelect.querySelector(`option[value="${cascinaSelect.value}"]`);
        if (currentCascina && currentCascina.dataset.clienteId !== selectedClienteId) {
            cascinaSelect.value = '';
        }
    } else {
        // Mostra tutte le cascine
        const cascinaOptions = document.querySelectorAll('#filter-cascina-terreni option[data-cliente-id]');
        cascinaOptions.forEach(option => {
            option.style.display = 'block';
        });
    }
    
    // Filtra i terreni
    items.forEach(item => {
        const clienteId = item.dataset.clienteId;
        const cascinaId = item.dataset.cascinaId;
        const name = item.dataset.name;
        
        let showByCliente = !selectedClienteId || clienteId === selectedClienteId;
        let showByCascina = !selectedCascinaId || cascinaId === selectedCascinaId;
        let showBySearch = !searchTerm || name.includes(searchTerm);
        
        if (showByCliente && showByCascina && showBySearch) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function filterTerreni() {
    filterTerreniByCliente(); // Riusa la logica combinata
}
function debugCurrentState() {
    console.log('🔍 DEBUG - Stato corrente:');
    console.log('Step corrente:', currentStep);
    console.log('Target selezionato:', selectedTarget);
    console.log('Dati selezionati:', selectedData);
    console.log('Superficie totale:', getSuperficieTotale());
    
    const productItems = document.querySelectorAll('.product-item');
    console.log('Prodotti configurati:', productItems.length);
}

let allClienti = [];
let selectedClienteForCascine = null;
let selectedClienteForTerreni = null;
let selectedCascinaForTerreni = null;

function loadClientiForSuggestions() {
    fetch('/api/clienti/')
    .then(response => response.json())
    .then(data => {
        allClienti = data;
        console.log('Clienti caricati per suggerimenti:', allClienti.length);
    })
    .catch(error => {
        console.error('Errore caricamento clienti:', error);
        showError('Errore nel caricamento dei clienti');
    });
}

function searchClienteForCascine() {
    const searchInput = document.getElementById('search-cliente-cascine');
    const query = searchInput.value.toLowerCase().trim();
    const suggestionsDiv = document.getElementById('cliente-suggestions');
    
    if (query.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
    }
    
    // Filtra clienti
    const filteredClienti = allClienti.filter(cliente => 
        cliente.nome.toLowerCase().includes(query)
    ).slice(0, 8); // Massimo 8 suggerimenti
    
    if (filteredClienti.length === 0) {
        suggestionsDiv.innerHTML = '<div class="suggestion-item text-muted">Nessun cliente trovato</div>';
        suggestionsDiv.style.display = 'block';
        return;
    }
    
    // Genera HTML suggerimenti con indice per navigazione
    const suggestionsHTML = filteredClienti.map((cliente, index) => `
        <div class="suggestion-item ${index === 0 ? 'suggestion-highlighted' : ''}" 
             data-cliente-id="${cliente.id}" 
             data-cliente-nome="${cliente.nome}"
             data-suggestion-index="${index}"
             onclick="selectClienteForCascine(${cliente.id}, '${cliente.nome}')">
            <i class="fas fa-building text-primary me-2"></i>
            <strong>${cliente.nome}</strong>
            <small class="text-muted ms-2">${cliente.cascine?.length || 0} cascine</small>
        </div>
    `).join('');
    
    suggestionsDiv.innerHTML = suggestionsHTML;
    suggestionsDiv.style.display = 'block';
    
    // ✅ MEMORIZZA I SUGGERIMENTI PER NAVIGAZIONE CON FRECCE
    window.currentSuggestions = {
        type: 'cliente-cascine',
        items: filteredClienti,
        selectedIndex: 0
    };
}



function loadCascineForCliente(clienteId) {
    console.log(`🔍 Caricamento cascine per cliente ${clienteId}`);
    
    // ✅ VERIFICA ESISTENZA ELEMENTI DOM
    const cascineArea = document.getElementById('cascine-selection-area');
    if (!cascineArea) {
        console.error('❌ Elemento cascine-selection-area non trovato');
        return;
    }
    
    // ✅ CREA LA STRUTTURA HTML CORRETTA
    cascineArea.style.display = 'block';
    cascineArea.innerHTML = `
        <div class="search-step">
            <h6><i class="fas fa-home text-primary"></i>2. Seleziona le Cascine Desiderate</h6>
            <div class="cascine-grid" id="cascine-container">
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Caricamento cascine...</span>
                    </div>
                    <p class="mt-2 text-muted">Caricamento cascine per ${selectedClienteForCascine?.nome || 'cliente selezionato'}...</p>
                </div>
            </div>
        </div>
    `;
    
    // ✅ ADESSO IL CONTAINER ESISTE, POSSIAMO UTILIZZARLO
    const cascineContainer = document.getElementById('cascine-container');
    if (!cascineContainer) {
        console.error('❌ Elemento cascine-container non trovato dopo la creazione');
        return;
    }
    
    console.log('✅ Container cascine creato correttamente');
    
    // ✅ FETCH CASCINE DEL CLIENTE
    fetch(`/api/clienti/${clienteId}/cascine/`)
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(cascine => {
        console.log(`✅ Ricevute ${cascine.length} cascine per cliente ${clienteId}:`, cascine);
        
        if (cascine.length === 0) {
            cascineContainer.innerHTML = `
                <div class="text-center p-4 text-muted">
                    <i class="fas fa-info-circle mb-3" style="font-size: 2rem;"></i>
                    <h6>Nessuna cascina trovata</h6>
                    <p>Il cliente selezionato non ha cascine associate.</p>
                    <button class="btn btn-outline-secondary btn-sm" onclick="resetTargetSelection()">
                        <i class="fas fa-arrow-left me-1"></i>Seleziona altro cliente
                    </button>
                </div>
            `;
            return;
        }
        
        // ✅ GENERA HTML CASCINE CON GESTIONE ERRORI
        const cascineHTML = cascine.map(cascina => {
            const superficie = cascina.superficie_totale || 0;
            const terreniCount = cascina.terreni_count || (cascina.terreni ? cascina.terreni.length : 0);
            const contoterzista = cascina.contoterzista || 'Nessun contoterzista';
            
            return `
                <div class="selection-item" 
                     data-cascina-id="${cascina.id}"
                     data-cascina-nome="${cascina.nome}"
                     data-cliente-id="${cascina.cliente_id || clienteId}"
                     data-cliente-nome="${selectedClienteForCascine.nome}"
                     data-superficie="${superficie}"
                     onclick="toggleCascinaSelectionSafe(this)">
                    
                    <div class="selection-checkbox">
                        <i class="fas fa-check"></i>
                    </div>
                    
                    <div class="selection-content">
                        <div class="selection-name">${cascina.nome}</div>
                        <div class="selection-info">
                            <i class="fas fa-map me-1"></i>${superficie.toFixed(2)} ha
                        </div>
                        <div class="selection-extra">
                            ${terreniCount} terreni • ${contoterzista}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        // ✅ INSERISCI L'HTML GENERATO
        cascineContainer.innerHTML = cascineHTML;
        
        console.log(`✅ Visualizzate ${cascine.length} cascine per ${selectedClienteForCascine.nome}`);
        
        // ✅ AGGIUNGI MESSAGGIO INFORMATIVO
        const infoMessage = document.createElement('div');
        infoMessage.className = 'alert alert-info mt-3';
        infoMessage.innerHTML = `
            <i class="fas fa-info-circle me-2"></i>
            <strong>Cliente selezionato:</strong> ${selectedClienteForCascine.nome}<br>
            <strong>Cascine disponibili:</strong> ${cascine.length} • 
            <strong>Superficie totale:</strong> ${cascine.reduce((sum, c) => sum + (c.superficie_totale || 0), 0).toFixed(2)} ha
        `;
        cascineArea.appendChild(infoMessage);
        
    })
    .catch(error => {
        console.error('❌ Errore caricamento cascine:', error);
        
        // ✅ VERIFICA CHE IL CONTAINER ESISTA ANCORA
        const currentContainer = document.getElementById('cascine-container');
        if (currentContainer) {
            currentContainer.innerHTML = `
                <div class="text-center p-4 text-danger">
                    <i class="fas fa-exclamation-triangle mb-3" style="font-size: 2rem;"></i>
                    <h6>Errore nel caricamento</h6>
                    <p>Non è stato possibile caricare le cascine per questo cliente.</p>
                    <small class="text-muted">Errore: ${error.message}</small>
                    <div class="mt-3">
                        <button class="btn btn-outline-danger btn-sm me-2" onclick="loadCascineForCliente(${clienteId})">
                            <i class="fas fa-redo me-1"></i>Riprova
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="resetTargetSelection()">
                            <i class="fas fa-arrow-left me-1"></i>Torna indietro
                        </button>
                    </div>
                </div>
            `;
        }
    });
}


function searchClienteForTerreni() {
    const searchInput = document.getElementById('search-cliente-terreni');
    const query = searchInput.value.toLowerCase().trim();
    const suggestionsDiv = document.getElementById('cliente-suggestions-terreni');
    
    if (query.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
    }
    
    const filteredClienti = allClienti.filter(cliente => 
        cliente.nome.toLowerCase().includes(query)
    ).slice(0, 8);
    
    if (filteredClienti.length === 0) {
        suggestionsDiv.innerHTML = '<div class="suggestion-item text-muted">Nessun cliente trovato</div>';
        suggestionsDiv.style.display = 'block';
        return;
    }
    
    // Genera HTML suggerimenti con indice per navigazione
    const suggestionsHTML = filteredClienti.map((cliente, index) => `
        <div class="suggestion-item ${index === 0 ? 'suggestion-highlighted' : ''}" 
             data-cliente-id="${cliente.id}" 
             data-cliente-nome="${cliente.nome}"
             data-suggestion-index="${index}"
             onclick="selectClienteForTerreni(${cliente.id}, '${cliente.nome}')">
            <i class="fas fa-building text-primary me-2"></i>
            <strong>${cliente.nome}</strong>
            <small class="text-muted ms-2">${cliente.cascine?.length || 0} cascine</small>
        </div>
    `).join('');
    
    suggestionsDiv.innerHTML = suggestionsHTML;
    suggestionsDiv.style.display = 'block';
    
    // ✅ MEMORIZZA I SUGGERIMENTI PER NAVIGAZIONE CON FRECCE
    window.currentSuggestions = {
        type: 'cliente-terreni',
        items: filteredClienti,
        selectedIndex: 0
    };
}

function loadCascineSelectForTerreni(clienteId) {
    const cascinaStep = document.getElementById('cascina-selection-step');
    const cascinaSelect = document.getElementById('cascina-select-terreni');
    
    cascinaStep.style.display = 'block';
    cascinaSelect.innerHTML = '<option value="">Caricamento...</option>';
    
    fetch(`/api/clienti/${clienteId}/cascine/`)
    .then(response => response.json())
    .then(cascine => {
        if (cascine.length === 0) {
            cascinaSelect.innerHTML = '<option value="">Nessuna cascina disponibile</option>';
            return;
        }
        
        let optionsHTML = '<option value="">-- Seleziona una cascina --</option>';
        cascine.forEach(cascina => {
            optionsHTML += `<option value="${cascina.id}" data-nome="${cascina.nome}">${cascina.nome} (${cascina.superficie_totale?.toFixed(2) || '0.00'} ha)</option>`;
        });
        
        cascinaSelect.innerHTML = optionsHTML;
        console.log(`✅ Caricate ${cascine.length} cascine nel select per terreni`);
    })
    .catch(error => {
        console.error('Errore caricamento cascine per terreni:', error);
        cascinaSelect.innerHTML = '<option value="">Errore caricamento</option>';
    });
}

function selectCascinaForTerreni() {
    const cascinaSelect = document.getElementById('cascina-select-terreni');
    const cascinaId = cascinaSelect.value;
    const cascinaNome = cascinaSelect.selectedOptions[0]?.dataset.nome;
    
    if (!cascinaId) {
        document.getElementById('terreni-selection-area').style.display = 'none';
        return;
    }
    
    selectedCascinaForTerreni = { id: parseInt(cascinaId), nome: cascinaNome };
    
    // Carica terreni della cascina selezionata
    loadTerreniForCascina(cascinaId);
    
    console.log(`Cascina selezionata per terreni: ${cascinaNome} (${cascinaId})`);
}

function loadTerreniForCascina(cascinaId) {
    const terreniArea = document.getElementById('terreni-selection-area');
    const terreniContainer = document.getElementById('terreni-container');
    
    terreniContainer.innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Caricamento terreni...</div>';
    terreniArea.style.display = 'block';
    
    fetch(`/api/cascine/${cascinaId}/terreni/`)
    .then(response => response.json())
    .then(terreni => {
        if (terreni.length === 0) {
            terreniContainer.innerHTML = `
                <div class="text-center p-4 text-muted">
                    <i class="fas fa-info-circle mb-2"></i>
                    <p>Nessun terreno trovato per questa cascina</p>
                </div>
            `;
            return;
        }
        
        const terreniHTML = terreni.map(terreno => `
            <div class="selection-item" 
                 data-terreno-id="${terreno.id}"
                 data-terreno-nome="${terreno.nome}"
                 data-cascina-id="${selectedCascinaForTerreni.id}"
                 data-cliente-id="${selectedClienteForTerreni.id}"
                 data-superficie="${terreno.superficie}"
                 onclick="toggleTerrenoSelectionSafe(this)">
                
                <div class="selection-checkbox">
                    <i class="fas fa-check"></i>
                </div>
                
                <div class="selection-content">
                    <div class="selection-name">${terreno.nome}</div>
                    <div class="selection-info">
                        <i class="fas fa-map me-1"></i>${terreno.superficie} ha
                    </div>
                    <div class="selection-extra">
                        Cascina: ${selectedCascinaForTerreni.nome}
                    </div>
                </div>
            </div>
        `).join('');
        
        terreniContainer.innerHTML = terreniHTML;
        
        console.log(`✅ Caricati ${terreni.length} terreni per cascina ${selectedCascinaForTerreni.nome}`);
    })
    .catch(error => {
        console.error('Errore caricamento terreni:', error);
        terreniContainer.innerHTML = `
            <div class="text-center p-4 text-danger">
                <i class="fas fa-exclamation-triangle mb-2"></i>
                <p>Errore nel caricamento dei terreni</p>
            </div>
        `;
    });
}

// Reset delle selezioni quando si cambia target
function resetAllSelections() {
    selectedClienteForCascine = null;
    selectedClienteForTerreni = null;
    selectedCascinaForTerreni = null;
    
    // Reset dati di selezione
    selectedData = {
        clienti: [],
        cascine: [],
        terreni: []
    };
}

// 3. ✅ MIGLIORA LA FUNZIONE resetTargetSelection
function resetTargetSelection() {
    selectedTarget = null;
    selectedData = {
        clienti: [],
        cascine: [],
        terreni: []
    };
    
    // Reset variabili per selezioni dinamiche  
    selectedClienteForCascine = null;
    selectedClienteForTerreni = null;
    selectedCascinaForTerreni = null;
    
    // Mostra di nuovo le card
    const selectionCards = document.querySelector('.selection-cards');
    selectionCards.classList.remove('hidden');
    
    // Rimuovi selezioni
    document.querySelectorAll('.selection-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Pulisci l'area di selezione
    document.getElementById('target-selection-area').innerHTML = '';
    
    console.log('✅ Reset completo delle selezioni');
}

// 4. ✅ MIGLIORA LA FUNZIONE updateSelectionUI
function updateSelectionUI() {
    // Rimuovi tutte le selezioni precedenti
    document.querySelectorAll('.selection-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Evidenzia elementi selezionati
    if (selectedTarget === 'cliente') {
        selectedData.clienti.forEach(cliente => {
            const element = document.querySelector(`[data-cliente-id="${cliente.id}"]`);
            if (element) {
                element.classList.add('selected');
            }
        });
    } else if (selectedTarget === 'cascina') {
        selectedData.cascine.forEach(cascina => {
            const element = document.querySelector(`[data-cascina-id="${cascina.id}"]`);
            if (element) {
                element.classList.add('selected');
            }
        });
    } else if (selectedTarget === 'terreno') {
        selectedData.terreni.forEach(terreno => {
            const element = document.querySelector(`[data-terreno-id="${terreno.id}"]`);
            if (element) {
                element.classList.add('selected');
            }
        });
    }
    
    // Aggiorna summary se esiste
    updateSelectionSummary();
}

// 5. ✅ NUOVA FUNZIONE PER AGGIORNARE IL SUMMARY
function updateSelectionSummary() {
    const summaryArea = document.getElementById('selection-summary');
    if (!summaryArea) return;
    
    let count = 0;
    let totalSuperficie = 0;
    let description = '';
    
    if (selectedTarget === 'cliente') {
        count = selectedData.clienti.length;
        totalSuperficie = selectedData.clienti.reduce((sum, c) => sum + (c.superficie_totale || 0), 0);
        description = `${count} cliente${count !== 1 ? 'i' : ''}`;
    } else if (selectedTarget === 'cascina') {
        count = selectedData.cascine.length;
        totalSuperficie = selectedData.cascine.reduce((sum, c) => sum + (c.superficie_totale || 0), 0);
        description = `${count} cascina${count !== 1 ? 'e' : ''}`;
    } else if (selectedTarget === 'terreno') {
        count = selectedData.terreni.length;
        totalSuperficie = selectedData.terreni.reduce((sum, t) => sum + (t.superficie || 0), 0);
        description = `${count} terreno${count !== 1 ? 'i' : ''}`;
    }
    
    if (count > 0) {
        summaryArea.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Selezionati:</strong> ${description} 
                <span class="ms-2">(<strong>${totalSuperficie.toFixed(2)} ha</strong>)</span>
            </div>
        `;
        summaryArea.style.display = 'block';
    } else {
        summaryArea.style.display = 'none';
    }
}

// 6. ✅ GESTIONE ERRORI MIGLIORATA
function showError(message, duration = 5000) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger alert-dismissible fade show';
    errorDiv.style.position = 'fixed';
    errorDiv.style.top = '20px';
    errorDiv.style.right = '20px';
    errorDiv.style.zIndex = '10000';
    errorDiv.style.minWidth = '300px';
    
    errorDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Errore:</strong> ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(errorDiv);
    
    // Rimuovi automaticamente
    setTimeout(() => {
        if (errorDiv.parentElement) {
            errorDiv.classList.remove('show');
            setTimeout(() => errorDiv.remove(), 300);
        }
    }, duration);
}

function showSuccess(message, duration = 3000) {
    const successDiv = document.createElement('div');
    successDiv.className = 'alert alert-success alert-dismissible fade show';
    successDiv.style.position = 'fixed';
    successDiv.style.top = '20px';
    successDiv.style.right = '20px';
    successDiv.style.zIndex = '10000';
    successDiv.style.minWidth = '300px';
    
    successDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        <strong>Successo:</strong> ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
        if (successDiv.parentElement) {
            successDiv.classList.remove('show');
            setTimeout(() => successDiv.remove(), 300);
        }
    }, duration);
}


function saveTrattamenti() {
    console.log('=== INIZIO SALVATAGGIO TRATTAMENTI ===');
    
    // Verifica selezioni
    if (!selectedTarget) {
        showError('Devi selezionare un tipo di trattamento');
        return;
    }
    
    let selectedCount = 0;
    if (selectedTarget === 'cliente') selectedCount = selectedData.clienti.length;
    else if (selectedTarget === 'cascina') selectedCount = selectedData.cascine.length;
    else if (selectedTarget === 'terreno') selectedCount = selectedData.terreni.length;
    
    if (selectedCount === 0) {
        showError('Devi selezionare almeno un elemento per il trattamento');
        return;
    }
    
    // ✅ RACCOLTA PRODOTTI CORRETTA
    const productContainers = document.querySelectorAll('.product-item');
    if (productContainers.length === 0) {
        showError('Devi aggiungere almeno un prodotto');
        return;
    }
    
    const prodottiData = [];
    let prodottiValidi = true;
    
    productContainers.forEach((container, index) => {
        const productSelect = container.querySelector('.product-select');
        const quantityInput = container.querySelector('.quantity-input');
        
        const prodotto_id = productSelect ? productSelect.value : '';
        const quantita_per_ettaro = quantityInput ? quantityInput.value : '';
        
        console.log(`Prodotto ${index + 1}:`, {
            prodotto_id,
            quantita_per_ettaro,
            valid: prodotto_id && quantita_per_ettaro && parseFloat(quantita_per_ettaro) > 0
        });
        
        if (!prodotto_id || !quantita_per_ettaro || parseFloat(quantita_per_ettaro) <= 0) {
            prodottiValidi = false;
        } else {
            // ✅ USA LA CHIAVE CORRETTA
            prodottiData.push({
                prodotto_id: parseInt(prodotto_id),
                quantita_per_ettaro: parseFloat(quantita_per_ettaro)
            });
        }
    });
    
    if (!prodottiValidi) {
        showError('Tutti i prodotti devono avere una quantità valida');
        return;
    }
    
    console.log('✅ Prodotti validati:', prodottiData);
    
    // Creazione trattamenti
    let trattamentiDaCreare = [];
    const noteAutomatiche = 'Trattamento programmato';
    
    if (selectedTarget === 'cliente') {
        selectedData.clienti.forEach(cliente => {
            trattamentiDaCreare.push({
                livello_applicazione: 'cliente',
                cliente: cliente.id,
                cascina: null,
                terreni_selezionati: [],
                prodotti_data: JSON.stringify(prodottiData), // ✅ STRINGIFY CORRETTO
                data_esecuzione_prevista: null,
                note: noteAutomatiche + ` [${cliente.nome}]`
            });
        });
    } else if (selectedTarget === 'cascina') {
        selectedData.cascine.forEach(cascina => {
            trattamentiDaCreare.push({
                livello_applicazione: 'cascina',
                cliente: cascina.cliente_id,
                cascina: cascina.id,
                terreni_selezionati: [],
                prodotti_data: JSON.stringify(prodottiData), // ✅ STRINGIFY CORRETTO
                data_esecuzione_prevista: null,
                note: noteAutomatiche + ` [${cascina.nome}]`
            });
        });
    } else if (selectedTarget === 'terreno') {
        trattamentiDaCreare.push({
            livello_applicazione: 'terreno',
            cliente: selectedData.terreni[0].cliente_id,
            cascina: selectedData.terreni[0].cascina_id,
            terreni_selezionati: selectedData.terreni.map(t => t.id),
            prodotti_data: JSON.stringify(prodottiData), // ✅ STRINGIFY CORRETTO
            data_esecuzione_prevista: null,
            note: noteAutomatiche + ` [${selectedData.terreni.length} terreni]`
        });
    }
    
    console.log('✅ Trattamenti da creare:', trattamentiDaCreare);
    createTrattamentiSequentially(trattamentiDaCreare);
}


function handleSearchKeydown(event) {
    const suggestionsDiv = event.target.nextElementSibling?.classList.contains('suggestions-dropdown') 
        ? event.target.nextElementSibling 
        : document.querySelector('.suggestions-dropdown[style*="block"]');
    
    if (!suggestionsDiv || suggestionsDiv.style.display === 'none') {
        return;
    }
    
    const suggestions = suggestionsDiv.querySelectorAll('.suggestion-item:not(.text-muted)');
    
    if (suggestions.length === 0) {
        return;
    }
    
    switch (event.key) {
        case 'Enter':
            event.preventDefault(); // ✅ IMPEDISCE IL SUBMIT DEL FORM
            
            // Seleziona il primo suggerimento evidenziato
            const highlighted = suggestionsDiv.querySelector('.suggestion-highlighted');
            if (highlighted) {
                highlighted.click();
            } else {
                // Fallback: seleziona il primo suggerimento
                suggestions[0].click();
            }
            break;
            
        case 'ArrowDown':
            event.preventDefault();
            navigateSuggestions('down', suggestions);
            break;
            
        case 'ArrowUp':
            event.preventDefault();
            navigateSuggestions('up', suggestions);
            break;
            
        case 'Escape':
            event.preventDefault();
            suggestionsDiv.style.display = 'none';
            event.target.blur();
            break;
    }
}

function navigateSuggestions(direction, suggestions) {
    const currentHighlighted = document.querySelector('.suggestion-highlighted');
    let currentIndex = 0;
    
    if (currentHighlighted) {
        currentIndex = Array.from(suggestions).indexOf(currentHighlighted);
        currentHighlighted.classList.remove('suggestion-highlighted');
    }
    
    if (direction === 'down') {
        currentIndex = (currentIndex + 1) % suggestions.length;
    } else {
        currentIndex = currentIndex <= 0 ? suggestions.length - 1 : currentIndex - 1;
    }
    
    suggestions[currentIndex].classList.add('suggestion-highlighted');
    
    // Scroll automatico se necessario
    suggestions[currentIndex].scrollIntoView({
        block: 'nearest',
        behavior: 'smooth'
    });
}

// Migliora l'evento click esterno esistente:

document.addEventListener('click', function(event) {
    // Nascondi suggerimenti quando si clicca fuori
    const suggestions = document.querySelectorAll('.suggestions-dropdown');
    suggestions.forEach(dropdown => {
        if (!dropdown.contains(event.target) && !event.target.closest('.search-box')) {
            dropdown.style.display = 'none';
        }
    });
    
    // Reset evidenziazione
    document.querySelectorAll('.suggestion-highlighted').forEach(item => {
        item.classList.remove('suggestion-highlighted');
    });
});


// Funzioni per mostrare/nascondere le scorciatoie tastiera
function showKeyboardShortcuts() {
    const shortcuts = document.getElementById('keyboard-shortcuts');
    if (shortcuts) {
        shortcuts.classList.add('show');
    }
}

function hideKeyboardShortcuts() {
    setTimeout(() => {
        const shortcuts = document.getElementById('keyboard-shortcuts');
        if (shortcuts && !document.querySelector('input:focus')) {
            shortcuts.classList.remove('show');
        }
    }, 200);
}

// Inizializza gli eventi di ricerca per ogni input
function initializeSearchEvents() {
    // Trova tutti gli input di ricerca e aggiungi gli eventi
    const searchInputs = document.querySelectorAll('input[id*="search-"]');
    
    searchInputs.forEach(input => {
        // Rimuovi eventi esistenti per evitare duplicati
        input.removeEventListener('keydown', handleSearchKeydown);
        input.removeEventListener('focus', showKeyboardShortcuts);
        input.removeEventListener('blur', hideKeyboardShortcuts);
        
        // Aggiungi nuovi eventi
        input.addEventListener('keydown', handleSearchKeydown);
        input.addEventListener('focus', showKeyboardShortcuts);
        input.addEventListener('blur', hideKeyboardShortcuts);
        
        console.log(`✅ Eventi inizializzati per: ${input.id}`);
    });
}

// Migliora la funzione di selezione clienti con feedback visivo
function selectClienteForCascine(clienteId, clienteNome) {
    console.log(`🎯 Selezione cliente per cascine: ${clienteNome} (${clienteId})`);
    
    selectedClienteForCascine = { id: clienteId, nome: clienteNome };
    
    // ✅ AGGIORNA INPUT CON VERIFICA ESISTENZA
    const searchInput = document.getElementById('search-cliente-cascine');
    const suggestionsDiv = document.getElementById('cliente-suggestions');
    
    if (searchInput) {
        searchInput.value = clienteNome;
        searchInput.classList.add('success');
        setTimeout(() => searchInput.classList.remove('success'), 1000);
    }
    
    if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
    }
    
    // ✅ CARICA CASCINE CON DELAY PER ASSICURARE DOM READY
    setTimeout(() => {
        loadCascineForCliente(clienteId);
    }, 100);
    
    console.log(`✅ Cliente ${clienteNome} selezionato, caricamento cascine in corso...`);
}

function selectClienteForTerreni(clienteId, clienteNome) {
    selectedClienteForTerreni = { id: clienteId, nome: clienteNome };
    
    const searchInput = document.getElementById('search-cliente-terreni');
    const suggestionsDiv = document.getElementById('cliente-suggestions-terreni');
    
    // Aggiorna input con animazione
    searchInput.value = clienteNome;
    searchInput.classList.add('success');
    setTimeout(() => searchInput.classList.remove('success'), 1000);
    
    // Nascondi suggerimenti
    suggestionsDiv.style.display = 'none';
    
    // Carica cascine per la selezione
    loadCascineSelectForTerreni(clienteId);
    
    console.log(`✅ Cliente selezionato per terreni: ${clienteNome} (${clienteId})`);
}

// Feedback visivo per stati di ricerca
function setSearchState(inputId, state) {
    const searchBox = document.querySelector(`#${inputId}`).closest('.search-box');
    
    // Rimuovi stati precedenti
    searchBox.classList.remove('searching', 'found', 'not-found');
    
    // Aggiungi nuovo stato
    if (state) {
        searchBox.classList.add(state);
    }
    
    // Rimuovi stato dopo un po'
    if (state !== 'searching') {
        setTimeout(() => {
            searchBox.classList.remove(state);
        }, 2000);
    }
}

// Gestione migliorata del focus per accessibilità
document.addEventListener('DOMContentLoaded', function() {
    // Aggiungi supporto per Alt + Left Arrow per tornare indietro
    document.addEventListener('keydown', function(event) {
        if (event.altKey && event.key === 'ArrowLeft') {
            event.preventDefault();
            const backButton = document.querySelector('button[onclick="resetTargetSelection()"]');
            if (backButton) {
                backButton.click();
            }
        }
    });
    
    // Focus automatico sul primo input di ricerca quando si carica un target
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                const addedNodes = Array.from(mutation.addedNodes);
                addedNodes.forEach(node => {
                    if (node.nodeType === 1 && node.querySelector) {
                        const firstSearchInput = node.querySelector('input[id*="search-"]');
                        if (firstSearchInput) {
                            setTimeout(() => {
                                firstSearchInput.focus();
                            }, 500);
                        }
                    }
                });
            }
        });
    });
    
    observer.observe(document.getElementById('target-selection-area'), {
        childList: true,
        subtree: true
    });
    
    console.log('✅ Gestione avanzata ricerca inizializzata');
});

// CSS Success State Class
const style = document.createElement('style');
style.textContent = `
    .form-control.success {
        border-color: #28a745 !important;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
        animation: successPulse 0.6s ease-out;
    }
    
    @keyframes successPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
`;
document.head.appendChild(style);

async function testCascineAPI(clienteId) {
    try {
        console.log(`🧪 Test API cascine per cliente ${clienteId}`);
        const response = await fetch(`/api/clienti/${clienteId}/cascine/`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('✅ API Response:', data);
        return data;
        
    } catch (error) {
        console.error('❌ API Error:', error);
        throw error;
    }
}

function debugDOMElements() {
    console.log('🧪 DEBUG DOM ELEMENTS:');
    console.log('cascine-selection-area:', document.getElementById('cascine-selection-area'));
    console.log('cascine-container:', document.getElementById('cascine-container'));
    console.log('search-cliente-cascine:', document.getElementById('search-cliente-cascine'));
    console.log('cliente-suggestions:', document.getElementById('cliente-suggestions'));
    
    // Verifica se i listener sono attaccati
    const searchInput = document.getElementById('search-cliente-cascine');
    if (searchInput) {
        console.log('Search input events:', {
            onkeyup: searchInput.onkeyup,
            onkeydown: searchInput.onkeydown
        });
    }
}

function showCascineError(clienteId, error) {
    const cascineArea = document.getElementById('cascine-selection-area');
    if (!cascineArea) return;
    
    cascineArea.style.display = 'block';
    cascineArea.innerHTML = `
        <div class="search-step">
            <h6><i class="fas fa-exclamation-triangle text-danger"></i>Errore Caricamento Cascine</h6>
            <div class="alert alert-danger">
                <h6>Non è stato possibile caricare le cascine</h6>
                <p><strong>Cliente ID:</strong> ${clienteId}</p>
                <p><strong>Errore:</strong> ${error.message}</p>
                
                <div class="mt-3">
                    <button class="btn btn-outline-danger btn-sm me-2" onclick="testCascineAPI(${clienteId}).then(data => console.log('Test API:', data)).catch(e => console.error('Test failed:', e))">
                        <i class="fas fa-flask me-1"></i>Test API
                    </button>
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="debugDOMElements()">
                        <i class="fas fa-bug me-1"></i>Debug DOM
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="loadCascineForCliente(${clienteId})">
                        <i class="fas fa-redo me-1"></i>Riprova
                    </button>
                </div>
            </div>
        </div>
    `;
}

document.addEventListener('DOMContentLoaded', function() {
    // Aggiungi funzioni di debug al window per accesso da console
    window.debugCascine = {
        testAPI: testCascineAPI,
        debugDOM: debugDOMElements,
        loadCascine: loadCascineForCliente,
        checkElements: () => {
            return {
                cascineArea: !!document.getElementById('cascine-selection-area'),
                cascineContainer: !!document.getElementById('cascine-container'),
                searchInput: !!document.getElementById('search-cliente-cascine'),
                suggestions: !!document.getElementById('cliente-suggestions')
            };
        }
    };
    
    console.log('✅ Debug cascine disponibile: window.debugCascine');
});

</script>

{% endblock %}