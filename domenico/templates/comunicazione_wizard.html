<!-- Salva questo file come domenico/templates/comunicazione_wizard.html -->
{% extends 'base.html' %}
{% load aziende_extras %}

{% block page_title %}Comunicazione Trattamenti - Wizard{% endblock %}
{% block page_icon %}<i class="fas fa-paper-plane"></i>{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #007bff;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --danger-color: #dc3545;
        --light-bg: #f8f9fa;
        --border-color: #dee2e6;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --gradient-warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    /* Page Header */
    .page-header {
        background: var(--gradient-primary);
        color: white;
        padding: 2rem 0;
        margin: -2rem -2rem 3rem -2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="white" opacity="0.1"><polygon points="1000,100 1000,0 0,100"/></svg>');
        background-size: cover;
    }

    .page-header-content {
        position: relative;
        z-index: 2;
    }

    .page-header h1 {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .page-header p {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 300;
    }

/* Step Indicator - Versione Migliorata */
.step-indicator {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 3rem auto;
    position: relative;
    max-width: 600px;
    padding: 1rem 0;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    flex: 1;
    z-index: 3;
}

.step-number {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.4rem;
    margin-bottom: 0.75rem;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    z-index: 5; /* Z-index molto alto per i numeri */
    border: 3px solid transparent;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.step.active .step-number {
    background: var(--primary-color);
    color: white;
    transform: scale(1.15);
    box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
    border-color: rgba(0, 123, 255, 0.2);
}

.step.completed .step-number {
    background: var(--success-color);
    color: white;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.step-label {
    font-size: 0.95rem;
    color: #6c757d;
    text-align: center;
    font-weight: 500;
    line-height: 1.3;
    transition: all 0.3s ease;
    max-width: 120px;
}

.step.active .step-label {
    color: var(--primary-color);
    font-weight: 700;
    transform: translateY(-2px);
}

.step.completed .step-label {
    color: var(--success-color);
    font-weight: 600;
}

.step-connector {
    position: absolute;
    top: 35px; /* Centrato rispetto al numero */
    left: calc(50% + 35px); /* Inizia dal bordo destro del cerchio */
    width: calc(100% - 70px); /* Larghezza fino al prossimo cerchio */
    height: 4px;
    background: linear-gradient(90deg, #e9ecef 0%, #e9ecef 100%);
    z-index: 1; /* Molto sotto i numeri */
    border-radius: 2px;
    transition: all 0.6s ease;
}

.step.completed .step-connector {
    background: linear-gradient(90deg, var(--success-color) 0%, #28a745 100%);
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

.step.active .step-connector {
    background: linear-gradient(90deg, var(--success-color) 0%, var(--primary-color) 100%);
    height: 5px;
    top: 34.5px;
}

.step:last-child .step-connector {
    display: none;
}

/* Responsive per mobile */
@media (max-width: 768px) {
    .step-indicator {
        flex-direction: column;
        max-width: 200px;
        gap: 2rem;
    }
    
    .step {
        flex: none;
        width: 100%;
    }
    
    .step-connector {
        top: calc(100% - 1rem);
        left: 50%;
        transform: translateX(-50%) rotate(90deg);
        width: 2rem;
        transform-origin: center;
    }
}

    @keyframes pulse {
        0% { box-shadow: 0 0 0 8px rgba(0, 123, 255, 0.1); }
        50% { box-shadow: 0 0 0 15px rgba(0, 123, 255, 0.05); }
        100% { box-shadow: 0 0 0 8px rgba(0, 123, 255, 0.1); }
    }

    /* Main Container */
    .wizard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0;
    }

    /* Summary Stats */
    .summary-stats {
        background: white;
        border-radius: 20px;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .summary-header {
        background: var(--gradient-success);
        color: white;
        padding: 1.5rem 2rem;
        text-align: center;
    }

    .summary-header h5 {
        margin: 0;
        font-weight: 600;
        font-size: 1.2rem;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0;
        padding: 1.5rem;
    }

    .stat-item {
        text-align: center;
        padding: 1rem;
        border-right: 1px solid var(--border-color);
    }

    .stat-item:last-child {
        border-right: none;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        display: block;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }

    /* Company Cards */
    .companies-section {
        margin-bottom: 2rem;
    }

    .company-card {
        background: white;
        border-radius: 20px;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
        overflow: hidden;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .company-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .company-card.completed {
        border-color: var(--success-color);
        opacity: 0.8;
    }

    .company-header {
        background: var(--gradient-warning);
        color: white;
        padding: 2rem;
        position: relative;
    }

    .company-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="white" opacity="0.1"><circle cx="100" cy="50" r="40"/><circle cx="200" cy="30" r="20"/><circle cx="300" cy="70" r="30"/></svg>');
        background-size: cover;
    }

    .company-header-content {
        position: relative;
        z-index: 2;
    }

    .company-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .company-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .company-stat {
        text-align: center;
        background: rgba(255, 255, 255, 0.2);
        padding: 0.8rem;
        border-radius: 10px;
        backdrop-filter: blur(10px);
    }

    .company-stat-value {
        font-size: 1.2rem;
        font-weight: 600;
        display: block;
    }

    .company-stat-label {
        font-size: 0.8rem;
        opacity: 0.9;
        margin-top: 0.2rem;
    }

    .company-body {
        padding: 2rem;
    }

    /* Treatment Items */
    .treatment-item {
        background: var(--light-bg);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .treatment-item:hover {
        box-shadow: var(--shadow);
        transform: translateY(-1px);
    }

    .treatment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .treatment-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-color);
        margin: 0;
    }

    .treatment-badge {
        background: var(--info-color);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .treatment-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .treatment-detail {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .treatment-detail i {
        color: var(--primary-color);
        width: 16px;
    }

    .terrain-list {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
        border: 1px solid var(--border-color);
    }

    .terrain-badge {
        display: inline-block;
        background: #e3f2fd;
        color: #1976d2;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.8rem;
        margin: 0.2rem;
        font-weight: 500;
    }

    .product-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 1rem;
        border: 1px solid var(--border-color);
    }

    .product-table table {
        width: 100%;
        margin: 0;
    }

    .product-table th {
        background: var(--primary-color);
        color: white;
        padding: 1rem;
        font-weight: 600;
        text-align: left;
        border: none;
    }

    .product-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        border-left: none;
        border-right: none;
    }

    .product-table tbody tr:nth-child(even) {
        background: #f8f9fa;
    }

    .product-table tbody tr:hover {
        background: #e3f2fd;
    }

    /* Custom Notes Section */
    .custom-notes {
        background: #fff3cd;
        border: 2px solid #ffeaa7;
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 2rem;
    }

    .notes-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
        color: #856404;
    }

    .notes-textarea {
        width: 100%;
        border: 2px solid #f0e68c;
        border-radius: 10px;
        padding: 1rem;
        font-size: 0.9rem;
        resize: vertical;
        min-height: 100px;
        background: white;
        transition: border-color 0.3s ease;
    }

    .notes-textarea:focus {
        outline: none;
        border-color: var(--warning-color);
        box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
    }

    .notes-help {
        font-size: 0.8rem;
        color: #856404;
        margin-top: 0.5rem;
        font-style: italic;
    }

    /* Action Buttons */
    .company-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid var(--border-color);
    }

    .btn {
        padding: 0.8rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }

    .btn-primary {
        background: var(--gradient-primary);
        color: white;
    }

    .btn-success {
        background: var(--gradient-success);
        color: white;
    }

    .btn-outline-secondary {
        background: transparent;
        color: #6c757d;
        border: 2px solid #6c757d;
    }

    .btn-outline-secondary:hover {
        background: #6c757d;
        color: white;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Global Actions */
    .global-actions {
        background: white;
        border-radius: 20px;
        box-shadow: var(--shadow);
        padding: 2rem;
        text-align: center;
        margin-bottom: 2rem;
    }

    .global-actions h6 {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        color: #333;
    }

    .global-actions small {
        color: #6c757d;
        display: block;
        margin-bottom: 2rem;
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
    }

    .loading-content {
        background: white;
        padding: 3rem;
        border-radius: 20px;
        text-align: center;
        min-width: 350px;
        box-shadow: var(--shadow-lg);
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #333;
    }

    .loading-message {
        color: #6c757d;
        font-size: 0.9rem;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state h4 {
        margin-bottom: 1rem;
        color: #495057;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .page-header {
            padding: 1.5rem 0;
            margin: -1rem -1rem 2rem -1rem;
        }

        .page-header h1 {
            font-size: 1.8rem;
        }

        .step-indicator {
            max-width: 300px;
        }

        .step-number {
            width: 50px;
            height: 50px;
            font-size: 1rem;
        }

        .summary-grid {
            grid-template-columns: repeat(2, 1fr);
            padding: 1rem;
        }

        .company-header {
            padding: 1.5rem;
        }

        .company-title {
            font-size: 1.3rem;
        }

        .company-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .treatment-details {
            grid-template-columns: 1fr;
        }

        .btn {
            padding: 0.7rem 1.5rem;
            font-size: 0.8rem;
        }
    }

    @media (max-width: 480px) {
        .summary-grid {
            grid-template-columns: 1fr;
        }

        .company-stats {
            grid-template-columns: 1fr;
        }

        .company-actions {
            flex-direction: column;
            gap: 1rem;
        }
    }



    /* Stili per il messaggio di completamento comunicazioni */
    .completion-message {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 400px;
        padding: 2rem;
    }

    .completion-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px solid #28a745;
        border-radius: 20px;
        padding: 3rem 2rem;
        text-align: center;
        box-shadow: 0 10px 30px rgba(40, 167, 69, 0.15);
        max-width: 600px;
        width: 100%;
        animation: completionSlideIn 0.8s ease-out;
    }

    .completion-icon {
        animation: completionPulse 2s ease-in-out infinite;
    }

    .completion-actions {
        margin-top: 2rem;
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    @keyframes completionSlideIn {
        from {
            opacity: 0;
            transform: translateY(-30px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @keyframes completionPulse {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.1);
            opacity: 0.8;
        }
    }

    /* Animazione per la rimozione delle aziende */
    .company-card.removing {
        animation: fadeOutSlide 0.5s ease-in-out forwards;
    }

    @keyframes fadeOutSlide {
        0% {
            opacity: 1;
            transform: translateX(0) scale(1);
            max-height: 500px;
        }
        50% {
            opacity: 0.5;
            transform: translateX(-20px) scale(0.95);
        }
        100% {
            opacity: 0;
            transform: translateX(-50px) scale(0.9);
            max-height: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
    }

    /* Evidenzia l'azienda che sta per essere processata */
    .company-card.processing {
        border: 3px solid #007bff;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        transform: scale(1.02);
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
        transition: all 0.3s ease;
    }

    .company-card.processing .company-title {
        color: #0056b3;
        font-weight: 600;
    }

    /* Stile per le comunicazioni completate con successo */
    .company-card.completed {
        border: 2px solid #28a745;
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        opacity: 0.8;
    }

    .company-card.completed .company-title {
        color: #155724;
    }

    .company-card.completed::after {
        content: '✓ Comunicato';
        position: absolute;
        top: 10px;
        right: 15px;
        background: #28a745;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    /* Responsive per mobile */
    @media (max-width: 768px) {
        .completion-card {
            padding: 2rem 1rem;
            margin: 0 1rem;
        }
        
        .completion-actions {
            flex-direction: column;
        }
        
        .completion-actions .btn {
            width: 100%;
            max-width: 300px;
        }
    }

    /* Miglioramento del messaggio di loading durante il processamento batch */
    .loading-overlay.batch-processing .loading-content {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
    }

    .loading-overlay.batch-processing .loading-spinner {
        border-top-color: white;
    }

    /* Progress bar per il processamento batch */
    .batch-progress {
        width: 100%;
        max-width: 400px;
        height: 6px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        margin-top: 1rem;
        overflow: hidden;
    }

    .batch-progress-bar {
        height: 100%;
        background: white;
        transition: width 0.3s ease;
        border-radius: 3px;
    }

</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="page-header-content">
        <h1><i class="fas fa-paper-plane me-3"></i>Comunicazione Trattamenti</h1>
        <p>Wizard di comunicazione avanzata - Verifica, personalizza e genera i PDF</p>
    </div>
</div>

<div class="wizard-container">
    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step completed">
            <div class="step-number">
                <i class="fas fa-check"></i>
            </div>
            <div class="step-label">Selezione<br>Trattamenti</div>
            <div class="step-connector"></div>
        </div>
        <div class="step active">
            <div class="step-number">2</div>
            <div class="step-label">Verifica &<br>Personalizza</div>
            <div class="step-connector"></div>
        </div>
        <div class="step">
            <div class="step-number">3</div>
            <div class="step-label">Genera<br>PDF</div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="summary-stats">
        <div class="summary-header">
            <h5><i class="fas fa-chart-bar me-2"></i>Riepilogo Comunicazione</h5>
        </div>
        <div class="summary-grid">
            <div class="stat-item">
                <span class="stat-value" id="totalTreatments">0</span>
                <div class="stat-label">Trattamenti Selezionati</div>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="totalCompanies">0</span>
                <div class="stat-label">Aziende Coinvolte</div>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="totalSurface">0 ha</span>
                <div class="stat-label">Superficie Totale</div>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="totalPdfs">0</span>
                <div class="stat-label">PDF da Generare</div>
            </div>
        </div>
    </div>

    <!-- Companies Section -->
    <div class="companies-section" id="companiesList">
        <!-- Le aziende verranno caricate dinamicamente qui -->
    </div>

    <!-- Global Actions -->
    <div class="global-actions">
        <h6>Pronti per generare i PDF?</h6>
        <small>Verifica i dati e le note personalizzate prima di procedere con la generazione</small>
        <div>
            <button class="btn btn-outline-secondary me-3" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>Torna ai Trattamenti
            </button>
            <button class="btn btn-success" onclick="generateAllPdfs()" id="generateAllBtn">
                <i class="fas fa-file-pdf"></i>Genera Tutti i PDF
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h5 class="loading-title" id="loadingTitle">Elaborazione in corso...</h5>
        <p class="loading-message" id="loadingMessage">Preparazione dei dati...</p>
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Conferma Generazione PDF
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Sei sicuro di voler procedere con la generazione del PDF per <strong id="confirmCompanyName"></strong>?</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Questa azione cambierà lo stato dei trattamenti a "Comunicato" e genererà il PDF di comunicazione.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" id="confirmGenerateBtn">
                    <i class="fas fa-download me-2"></i>Scarica PDF e Continua
                </button>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Dati globali
    let companiesData = [];
    let currentCompanyIndex = 0;
    let selectedTreatments = [];
    
    // Inizializzazione
    document.addEventListener('DOMContentLoaded', function() {
        // Recupera i dati dai parametri URL
        const urlParams = new URLSearchParams(window.location.search);
        const treatmentIds = urlParams.get('treatments');
        
        console.log('🔍 URL params raw:', treatmentIds);
        
        if (treatmentIds) {
            // CORREZIONE: Filtra valori non validi
            selectedTreatments = treatmentIds.split(',')
                .map(id => parseInt(id.trim()))
                .filter(id => !isNaN(id) && id > 0);
            
            console.log('🔍 Trattamenti processati:', selectedTreatments);
            
            if (selectedTreatments.length > 0) {
                loadTreatmentData();
            } else {
                showError('ID trattamenti non validi nei parametri URL');
            }
        } else {
            // Fallback a sessionStorage
            const storedTreatments = sessionStorage.getItem('selectedTreatments');
            if (storedTreatments) {
                try {
                    selectedTreatments = JSON.parse(storedTreatments);
                    console.log('🔍 Trattamenti da sessionStorage:', selectedTreatments);
                    if (selectedTreatments.length > 0) {
                        loadTreatmentData();
                    } else {
                        showError('Nessun trattamento valido in sessionStorage');
                    }
                } catch (e) {
                    console.error('Errore parsing sessionStorage:', e);
                    showError('Dati sessionStorage corrotti');
                }
            } else {
                showError('Nessun trattamento selezionato. Ritorna alla lista trattamenti.');
                setTimeout(() => goBack(), 3000);
            }
        }
    });
    
    async function loadTreatmentData() {
        showLoading('Caricamento dati trattamenti...', 'Preparazione dell\'interfaccia di comunicazione');
        
        try {
            console.log('🔍 Caricamento dati per trattamenti:', selectedTreatments);
            
            if (!selectedTreatments || selectedTreatments.length === 0) {
                showError('Nessun trattamento selezionato. Ritorna alla lista trattamenti.');
                setTimeout(() => goBack(), 3000);
                return;
            }
            
            const response = await fetch('/api/trattamenti/communication-preview/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    trattamenti_ids: selectedTreatments,
                    exclude_communicated: true  // NUOVO: Escludi automaticamente quelli comunicati
                })
            });
            
            console.log('📡 Risposta ricevuta:', response.status, response.statusText);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('❌ Errore HTTP:', response.status, errorText);
                showError(`Errore server (${response.status}): ${errorText.substring(0, 200)}`);
                return;
            }
            
            const data = await response.json();
            console.log('📦 Dati ricevuti:', data);
            
            if (data.success) {
                if (data.companies && Array.isArray(data.companies) && data.companies.length > 0) {
                    companiesData = data.companies;
                    console.log('✅ Caricati dati per', companiesData.length, 'aziende');
                    renderCompanies();
                    updateSummaryStats();
                } else {
                    // NUOVO: Tutti i trattamenti sono già stati comunicati
                    showAllCommunicationsCompleted();
                    showSuccess('Tutti i trattamenti selezionati sono già stati comunicati!');
                }
            } else {
                showError(data.error || 'Errore nel caricamento dei dati');
            }
        } catch (error) {
            console.error('❌ Errore nel caricamento:', error);
            showError(`Errore di connessione: ${error.message}`);
        } finally {
            hideLoading();
        }
    }
    
    function processTreatmentData(data) {
        console.log('🔧 Processamento dati trattamenti:', data);
        
        // Pulisci i dati esistenti
        companiesData = [];
        
        // Processa email_previews (che contiene i dati raggruppati per azienda)
        if (data.email_previews && Array.isArray(data.email_previews)) {
            data.email_previews.forEach(companyData => {
                console.log('🏢 Processando azienda:', companyData.cliente_nome);
                
                const company = {
                    nome: companyData.cliente_nome,
                    trattamenti: companyData.trattamenti || [],
                    superficie_totale: companyData.superficie_totale || 0,
                    note_personalizzate: ''
                };
                
                console.log('📋 Trattamenti per', company.nome, ':', company.trattamenti.length);
                companiesData.push(company);
            });
        }
        
        console.log('✅ Dati processati. Aziende totali:', companiesData.length);
        console.log('🗂️ Struttura companiesData:', companiesData);
    }
    
    function renderCompanies() {
        const container = document.getElementById('companiesList');
        container.innerHTML = '';
        
        console.log('🎨 Rendering', companiesData.length, 'aziende');
        
        if (companiesData.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-building"></i>
                    <h4>Nessuna azienda trovata</h4>
                    <p>Non sono stati trovati dati per i trattamenti selezionati.</p>
                    <button class="btn btn-primary" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> Torna ai Trattamenti
                    </button>
                </div>
            `;
            return;
        }
        
        companiesData.forEach((company, index) => {
            console.log('🏢 Creando card per:', company.nome, 'con', company.trattamenti.length, 'trattamenti');
            const companyCard = createCompanyCard(company, index);
            container.appendChild(companyCard);
        });
    }
    

    function createCompanyCard(company, index) {
        // Debug dei dati azienda
        console.log(`🏢 Creando card per ${company.nome}:`, company);
        
        let treatmentsHtml = '';
        let treatmentNumber = 1; // Numerazione progressiva indipendente
        
        // CORREZIONE: Verifica che company.trattamenti esista ed è un array
        const trattamenti = company.trattamenti || [];
        
        trattamenti.forEach((treatment) => {
            // CORREZIONE: Adatta i nomi dei campi dal backend alla struttura HTML originale
            const dataEsecuzione = treatment.data_programmata || 'N/D';
            const terrenoNome = treatment.terreni_nomi && treatment.terreni_nomi.length > 0 ? 
                            treatment.terreni_nomi.join(', ') : 
                            treatment.cascina_nome || 'N/D';
            const superficieTrattata = treatment.superficie || 0;
            
            // CORREZIONE: Gestisci prodotti con la struttura corretta
            let prodottiHtml = '';
            if (treatment.prodotti && Array.isArray(treatment.prodotti) && treatment.prodotti.length > 0) {
                prodottiHtml = treatment.prodotti.map(prodotto => `
                    <div class="product-item">
                        <strong>${prodotto.nome}</strong>
                        <small class="text-muted d-block">
                            P.A.: ${prodotto.principi_attivi || 'N/D'} | 
                            Dose: ${prodotto.dose || 0} ${prodotto.unita_misura || 'L'}/ha
                        </small>
                    </div>
                `).join('');
            }
            
            treatmentsHtml += `
                <div class="treatment-item">
                    <div class="treatment-header">
                        <div class="treatment-title-group">
                            <h6 class="treatment-title">Trattamento N. ${treatmentNumber}</h6>
                            <span class="treatment-date">${dataEsecuzione}</span>
                        </div>
                    </div>
                    <div class="treatment-details">
                        <div class="detail-item">
                            <label>Area Interessata:</label>
                            <span>${terrenoNome}</span>
                        </div>
                        <div class="detail-item">
                            <label>Superficie Interessata:</label>
                            <span>${superficieTrattata} ha</span>
                        </div>
                        <div class="detail-item">
                            <label>Stato:</label>
                            <span class="badge ${treatment.stato === 'programmato' ? 'bg-warning' : 'bg-info'}">${treatment.stato || 'N/D'}</span>
                        </div>
                    </div>
                    
                    ${treatment.prodotti && treatment.prodotti.length > 0 ? `
                    <div class="products-section">
                        <h6><i class="fas fa-flask me-2"></i>Prodotti Utilizzati</h6>
                        <div class="products-list">
                            ${prodottiHtml}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            treatmentNumber++; // Incrementa la numerazione progressiva
        });
        
        const card = document.createElement('div');
        card.className = 'company-card';
        card.innerHTML = `
            <div class="company-header">
                <div class="company-header-content">
                    <div class="company-info">
                        <h4 class="company-title">
                            <i class="fas fa-building me-2"></i>
                            ${company.nome}
                        </h4>
                    </div>
                    <div class="company-stats">
                        <div class="company-stat">
                            <span class="company-stat-value">${trattamenti.length}</span>
                            <div class="company-stat-label">Trattament${trattamenti.length !== 1 ? 'i' : 'o'}</div>
                        </div>
                        <div class="company-stat">
                            <span class="company-stat-value">${(company.superficie_totale || 0).toFixed(1)} ha</span>
                            <div class="company-stat-label">Superficie</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="company-body">
                ${treatmentsHtml}
                
                <div class="company-notes">
                    <label for="customNotes${index}" class="form-label">
                        <i class="fas fa-sticky-note me-2"></i>Note personalizzate (opzionale):
                    </label>
                    <textarea 
                        class="form-control" 
                        id="customNotes${index}" 
                        rows="3" 
                        placeholder="Aggiungi note specifiche per questa comunicazione..."
                        onchange="updateCompanyNotes(${index}, this.value)"
                    ></textarea>
                </div>
            </div>
            
            <div class="company-actions">
                <button class="btn btn-success btn-lg company-action-btn" onclick="generateSinglePdf(${index})">
                    <i class="fas fa-file-pdf me-2"></i>
                    Genera PDF per ${company.nome}
                </button>
            </div>
        `;
        
        return card;
    }

    function updateCompanyNotes(index, notes) {
        if (companiesData[index]) {
            companiesData[index].note_personalizzate = notes;
            console.log('📝 Note aggiornate per', companiesData[index].nome, ':', notes);
        }
    }
    
    // Modifica la funzione updateSummaryStats per riflettere le rimozioni
    function updateSummaryStats() {
        const totalTreatments = companiesData.reduce((sum, company) => sum + company.trattamenti.length, 0);
        const totalSurface = companiesData.reduce((sum, company) => sum + company.superficie_totale, 0);
        
        document.getElementById('totalTreatments').textContent = totalTreatments;
        document.getElementById('totalCompanies').textContent = companiesData.length;
        document.getElementById('totalSurface').textContent = `${totalSurface.toFixed(2)} ha`;
        document.getElementById('totalPdfs').textContent = companiesData.length;
    }
    
    function generateSinglePdf(companyIndex) {
        const company = companiesData[companyIndex];
        if (!company) {
            console.error('❌ Azienda non trovata per indice:', companyIndex);
            return;
        }
        
        console.log('📄 Generazione PDF per:', company.nome);
        
        // Mostra modal di conferma
        document.getElementById('confirmCompanyName').textContent = company.nome;
        
        const confirmBtn = document.getElementById('confirmGenerateBtn');
        confirmBtn.onclick = () => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
            if (modal) modal.hide();
            processSingleCompanyPdf(companyIndex);
        };
        
        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
        modal.show();
    }
    
    
    // Variabile globale per tracciare i trattamenti già comunicati
    let communicatedTreatments = [];

    // Modifica la funzione processSingleCompanyPdf esistente
    async function processSingleCompanyPdf(companyIndex) {
        const company = companiesData[companyIndex];
        
        showLoading(`Generazione PDF per ${company.nome}...`, 'Preparazione documento e aggiornamento stati');
        
        try {
            const treatmentIds = company.trattamenti.map(t => t.id);
            console.log('📄 Generazione PDF per trattamenti:', treatmentIds);
            
            const response = await fetch('/api/trattamenti/generate-company-pdf/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    trattamenti_ids: treatmentIds,
                    company_name: company.nome,
                    custom_notes: getCustomNotes(companyIndex),
                    update_status: true
                })
            });
            
            if (response.ok) {
                // Scarica il PDF
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Comunicazione_${company.nome.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // NUOVA FUNZIONALITÀ: Rimuovi l'azienda dalla lista dopo la comunicazione
                await removeCompanyFromList(companyIndex);
                
                showSuccess(`PDF generato con successo per ${company.nome}!<br>I trattamenti sono stati contrassegnati come "Comunicato".`);
                
            } else {
                const errorData = await response.json();
                showError(`Errore generazione PDF: ${errorData.error || 'Errore sconosciuto'}`);
            }
            
        } catch (error) {
            console.error('❌ Errore generazione PDF:', error);
            showError(`Errore durante la generazione del PDF: ${error.message}`);
        } finally {
            hideLoading();
        }
    }

    // NUOVA FUNZIONE: Rimuove un'azienda dalla lista dopo la comunicazione
    async function removeCompanyFromList(companyIndex) {
        const company = companiesData[companyIndex];
        
        // Aggiungi i trattamenti alla lista dei comunicati
        const treatmentIds = company.trattamenti.map(t => t.id);
        communicatedTreatments.push(...treatmentIds);
        
        // NUOVO: Rimuovi questi trattamenti anche da selectedTreatments
        selectedTreatments = selectedTreatments.filter(id => !treatmentIds.includes(id));
        console.log('🔄 selectedTreatments aggiornato:', selectedTreatments);
        
        // Rimuovi l'azienda dall'array
        companiesData.splice(companyIndex, 1);
        
        // Aggiorna l'interfaccia
        renderCompanies();
        updateSummaryStats();
        
        // Se non ci sono più aziende, mostra messaggio di completamento
        if (companiesData.length === 0) {
            showAllCommunicationsCompleted();
        }
        
        console.log('✅ Azienda rimossa dalla lista. Rimanenti:', companiesData.length);
    }

    // NUOVA FUNZIONE: Mostra messaggio quando tutte le comunicazioni sono completate
    function showAllCommunicationsCompleted() {
        const companiesContainer = document.getElementById('companiesList');
        companiesContainer.innerHTML = `
            <div class="completion-message">
                <div class="completion-card">
                    <div class="completion-icon">
                        <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                    </div>
                    <h3 class="text-success mt-3">Tutte le comunicazioni completate!</h3>
                    <p class="text-muted mb-4">
                        ${communicatedTreatments.length > 0 ? 
                            `Hai appena comunicato ${communicatedTreatments.length} trattamenti con successo.` : 
                            'Tutti i trattamenti selezionati erano già stati comunicati in precedenza.'
                        }<br>
                        I PDF sono stati generati e gli stati aggiornati nel database.
                    </p>
                    <div class="completion-actions">
                        <button class="btn btn-primary btn-lg me-3" onclick="goBack()">
                            <i class="fas fa-arrow-left me-2"></i>
                            Torna ai Trattamenti
                        </button>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Per evitare duplicazioni, i trattamenti già comunicati non vengono più mostrati.
                        </small>
                    </div>
                </div>
            </div>
        `;
        
        // Nascondi il pulsante "Genera Tutti i PDF"
        const generateAllBtn = document.getElementById('generateAllBtn');
        if (generateAllBtn) {
            generateAllBtn.style.display = 'none';
        }
    }


    async function checkValidTreatments() {
        try {
            const response = await fetch('/api/trattamenti/communication-status/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    trattamenti_ids: selectedTreatments
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    const trattamentiRimanenti = data.data.trattamenti_rimanenti.map(t => t.id);
                    
                    if (trattamentiRimanenti.length === 0) {
                        // Tutti già comunicati
                        showAllCommunicationsCompleted();
                        showSuccess('Tutti i trattamenti selezionati sono già stati comunicati!');
                        return;
                    } else if (trattamentiRimanenti.length < selectedTreatments.length) {
                        // Alcuni già comunicati
                        selectedTreatments = trattamentiRimanenti;
                        const comunicatiCount = selectedTreatments.length - trattamentiRimanenti.length;
                        showSuccess(`${comunicatiCount} trattamenti erano già stati comunicati. Mostro solo quelli rimanenti.`);
                    }
                    
                    // Procedi con il caricamento normale
                    loadTreatmentData();
                } else {
                    // Fallback al caricamento normale
                    loadTreatmentData();
                }
            } else {
                // Fallback al caricamento normale
                loadTreatmentData();
            }
        } catch (error) {
            console.error('❌ Errore verifica trattamenti:', error);
            // Fallback al caricamento normale
            loadTreatmentData();
        }
    }
    
    function markCompanyAsCompleted(index) {
        const card = document.getElementById(`company-${index}`);
        if (card) {
            card.classList.add('completed');
            
            const button = card.querySelector('.btn-primary');
            if (button) {
                button.className = 'btn btn-success';
                button.innerHTML = '<i class="fas fa-check"></i>Completato';
                button.disabled = true;
            }
            
            // Aggiungi badge di completamento
            const header = card.querySelector('.company-header-content');
            if (header && !header.querySelector('.completion-badge')) {
                const badge = document.createElement('div');
                badge.className = 'completion-badge alert alert-success mt-3 mb-0';
                badge.innerHTML = '<i class="fas fa-check-circle me-2"></i>PDF generato con successo!';
                header.appendChild(badge);
            }
        }
    }
    
    function scrollToNextCompany(index) {
        const nextCard = document.getElementById(`company-${index}`);
        if (nextCard) {
            nextCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            nextCard.style.borderColor = '#007bff';
            nextCard.style.borderWidth = '3px';
            setTimeout(() => {
                nextCard.style.borderColor = 'transparent';
                nextCard.style.borderWidth = '2px';
            }, 3000);
        }
    }
    
    // Modifica la funzione generateAllPdfs per gestire la rimozione progressiva
    async function generateAllPdfs() {
        if (companiesData.length === 0) {
            showError('Nessuna azienda da processare');
            return;
        }
        
        const totalCompanies = companiesData.length;
        let processedCompanies = 0;
        
        showLoading('Generazione PDF in corso...', `Processando azienda 1 di ${totalCompanies}`);
        
        // Processa le aziende una alla volta, partendo sempre dall'indice 0
        // perché ogni volta che ne rimuoviamo una, gli indici si riorganizzano
        while (companiesData.length > 0) {
            const currentCompany = companiesData[0];
            processedCompanies++;
            
            // Aggiorna il messaggio di loading
            document.getElementById('loadingMessage').textContent = 
                `Processando ${currentCompany.nome} (${processedCompanies} di ${totalCompanies})`;
            
            try {
                await processSingleCompanyPdfSilent(0); // Sempre indice 0 perché rimuoviamo di volta in volta
                
            } catch (error) {
                console.error(`❌ Errore processando ${currentCompany.nome}:`, error);
                showError(`Errore durante il processamento di ${currentCompany.nome}: ${error.message}`);
                // Rimuovi comunque l'azienda per evitare loop infiniti
                companiesData.splice(0, 1);
            }
            
            // Pausa breve per evitare sovraccarico
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        hideLoading();
        
        if (companiesData.length === 0) {
            showAllCommunicationsCompleted();
            showSuccess(`Processate con successo tutte le ${totalCompanies} aziende!`);
        }
    }

    // NUOVA FUNZIONE: Versione "silenziosa" di processSingleCompanyPdf per uso in batch
    async function processSingleCompanyPdfSilent(companyIndex) {
        const company = companiesData[companyIndex];
        const treatmentIds = company.trattamenti.map(t => t.id);
        
        const response = await fetch('/api/trattamenti/generate-company-pdf/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                trattamenti_ids: treatmentIds,
                company_name: company.nome,
                custom_notes: getCustomNotes(companyIndex),
                update_status: true
            })
        });
        
        if (response.ok) {
            // Scarica il PDF
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `Comunicazione_${company.nome.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Rimuovi l'azienda dalla lista
            await removeCompanyFromList(companyIndex);
            
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Errore sconosciuto');
        }
    }

    // NUOVA FUNZIONE: Ottiene le note personalizzate per un'azienda
    function getCustomNotes(companyIndex) {
        const notesTextarea = document.querySelector(`#customNotes${companyIndex}`);
        return notesTextarea ? notesTextarea.value.trim() : '';
    }
    
    // Utility functions
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
    }
    
    function showLoading(title, message) {
        document.getElementById('loadingTitle').textContent = title;
        document.getElementById('loadingMessage').textContent = message;
        document.getElementById('loadingOverlay').style.display = 'flex';
    }
    
    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
    
    function showSuccess(message) {
        const div = document.createElement('div');
        div.className = 'alert alert-success alert-dismissible fade show position-fixed';
        div.style.cssText = 'top: 20px; right: 20px; z-index: 10001; min-width: 350px; max-width: 500px;';
        div.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            <strong>Successo!</strong><br>${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        document.body.appendChild(div);
        
        // Auto-remove dopo 6 secondi
        setTimeout(() => {
            if (div.parentElement) div.remove();
        }, 6000);
    }
    
    function showError(message) {
        const div = document.createElement('div');
        div.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        div.style.cssText = 'top: 20px; right: 20px; z-index: 10001; min-width: 350px; max-width: 500px;';
        div.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Errore!</strong><br>${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        document.body.appendChild(div);
        
        // Auto-remove dopo 10 secondi per gli errori
        setTimeout(() => {
            if (div.parentElement) div.remove();
        }, 10000);
    }
    
    function goBack() {
        window.location.href = '/trattamenti/';
    }
    
    // Debug helper
    window.debugWizard = {
        companiesData: () => companiesData,
        selectedTreatments: () => selectedTreatments,
        reloadData: () => loadTreatmentData(),
        testPdfGeneration: (index) => processSingleCompanyPdf(index || 0)
    };
</script>
{% endblock %}