{% extends 'base.html' %}
{% load aziende_extras %}

{% block page_title %}{{ view_title }}{% endblock %}
{% block page_icon %}<i class="fas fa-list"></i>{% endblock %}

{% block extra_css %}
<style>
    /* Stili per selezione multipla */
    .bulk-actions {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 2px solid #e9ecef;
        display: none;
    }
    
    .bulk-actions.show {
        display: block;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .selection-counter {
        font-weight: bold;
        color: #007bff;
    }
    
    .checkbox-column {
        width: 40px;
        text-align: center;
    }
    
    .trattamento-checkbox {
        transform: scale(1.2);
        cursor: pointer;
    }
    
    .selected-row {
        background-color: #e3f2fd !important;
    }
    
    .bulk-action-btn {
        margin-right: 0.5rem;
        min-width: 120px;
    }
    
    .table-header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    /* Stili per i badge di stato */
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-programmato {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .status-comunicato {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .status-completato {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-annullato {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f1aeb5;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>{{ view_title }}</h1>
        <p class="text-muted">{{ view_description }}</p>
    </div>
    <div>
        <a href="{% url 'trattamenti' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Dashboard
        </a>
        <a href="{% url 'inserisci' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Nuovo Trattamento
        </a>
    </div>
</div>

<!-- Statistiche rapide -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">{{ stats.filtrati }}</h5>
                <p class="card-text">Visualizzati</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">{{ stats.programmati }}</h5>
                <p class="card-text">Programmati</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">{{ stats.comunicati }}</h5>
                <p class="card-text">Comunicati</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">{{ stats.completati }}</h5>
                <p class="card-text">Completati</p>
            </div>
        </div>
    </div>
</div>

<!-- Azioni in blocco -->
<div id="bulkActions" class="bulk-actions">
    <div class="d-flex align-items-center justify-content-between">
        <div>
            <i class="fas fa-check-circle text-success"></i>
            <span class="selection-counter" id="selectionCounter">0 trattamenti selezionati</span>
        </div>
        <div>
            {% if next_action == 'comunica' %}
                <button class="btn btn-primary bulk-action-btn" onclick="bulkCommunicate()">
                    <i class="fas fa-paper-plane"></i> Comunica Selezionati
                </button>
            {% elif next_action == 'completa' %}
                <button class="btn btn-success bulk-action-btn" onclick="bulkComplete()">
                    <i class="fas fa-check"></i> Completa Selezionati
                </button>
            {% endif %}
            
            <button class="btn btn-warning bulk-action-btn" onclick="bulkAnnulla()">
                <i class="fas fa-times"></i> Annulla Selezionati
            </button>
            
            <button class="btn btn-outline-secondary" onclick="clearSelection()">
                <i class="fas fa-times"></i> Deseleziona Tutto
            </button>
        </div>
    </div>
</div>

<!-- Filtri -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-filter"></i> Filtri di Ricerca
        </h5>
    </div>
    <div class="card-body">
        <form method="GET" class="row">
            <div class="col-md-3">
                <label class="form-label">Ricerca</label>
                <input type="text" class="form-control" name="search" value="{{ filters.search }}" 
                       placeholder="Cliente, cascina, note, ID...">
            </div>
            <div class="col-md-3">
                <label class="form-label">Cliente</label>
                <select class="form-select" name="cliente">
                    <option value="">Tutti i clienti</option>
                    {% for cliente in clienti %}
                    <option value="{{ cliente.id }}" {% if filters.cliente == cliente.id|stringformat:"s" %}selected{% endif %}>
                        {{ cliente.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Cascina</label>
                <select class="form-select" name="cascina">
                    <option value="">Tutte le cascine</option>
                    {% for cascina in cascine %}
                    <option value="{{ cascina.id }}" {% if filters.cascina == cascina.id|stringformat:"s" %}selected{% endif %}>
                        {{ cascina.nome }} ({{ cascina.cliente.nome }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Contoterzista</label>
                <select class="form-select" name="contoterzista">
                    <option value="">Tutti i contoterzisti</option>
                    {% for contoterzista in contoterzisti %}
                    <option value="{{ contoterzista.id }}" {% if filters.contoterzista == contoterzista.id|stringformat:"s" %}selected{% endif %}>
                        {{ contoterzista.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 mt-3">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i> Filtra
                </button>
                <a href="?" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Pulisci
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Tabella Trattamenti -->
<div class="card">
    <div class="card-header">
        <div class="table-header-actions">
            <h5 class="mb-0">
                <i class="fas fa-list"></i> 
                Elenco Trattamenti ({{ stats.filtrati }})
            </h5>
            <div>
                <button class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                    <i class="fas fa-check-square"></i> Seleziona Tutti
                </button>
            </div>
        </div>
    </div>
    
    {% if trattamenti %}
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th class="checkbox-column">
                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                    </th>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Cascina/Terreni</th>
                    <th>Superficie</th>
                    <th>Stato</th>
                    <th>Data Inserimento</th>
                    <th>Prodotti</th>
                    <th>Note</th>
                </tr>
            </thead>
            <tbody>
                {% for trattamento in trattamenti %}
                <tr id="row-{{ trattamento.id }}">
                    <td class="checkbox-column">
                        <input type="checkbox" class="trattamento-checkbox" 
                               value="{{ trattamento.id }}" 
                               onchange="updateSelection()">
                    </td>
                    <td>
                        <strong>#{{ trattamento.id }}</strong>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar me-2">
                                {{ trattamento.cliente.nome|first|upper }}
                            </div>
                            <div>
                                <strong>{{ trattamento.cliente.nome }}</strong>
                            </div>
                        </div>
                    </td>
                    <td>
                        {% if trattamento.livello_applicazione == 'cascina' and trattamento.cascina %}
                            <i class="fas fa-home text-info"></i> {{ trattamento.cascina.nome }}
                        {% elif trattamento.livello_applicazione == 'terreno' %}
                            <i class="fas fa-map text-success"></i> 
                            {{ trattamento.terreni.count }} terren{{ trattamento.terreni.count|pluralize:"o,i" }}
                        {% else %}
                            <i class="fas fa-building text-primary"></i> Intera Azienda
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ trattamento.get_superficie_interessata|floatformat:2 }} ha</strong>
                    </td>
                    <td>
                        <span class="status-badge status-{{ trattamento.stato }}">
                            <i class="{{ trattamento.stato|get_stato_icon }}"></i>
                            {{ trattamento.get_stato_display }}
                        </span>
                    </td>
                    <td>
                        <div>{{ trattamento.data_inserimento|date:"d/m/Y" }}</div>
                        <small class="text-muted">{{ trattamento.data_inserimento|date:"H:i" }}</small>
                    </td>
                    <td>
                        <span class="badge bg-info">
                            {{ trattamento.trattamentoprodotto_set.count }} prodott{{ trattamento.trattamentoprodotto_set.count|pluralize:"o,i" }}
                        </span>
                    </td>
                    <td>
                        {% if trattamento.note %}
                            <span class="text-truncate d-inline-block" style="max-width: 200px;" 
                                  title="{{ trattamento.note }}">
                                {{ trattamento.note|truncatechars:50 }}
                            </span>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Paginazione -->
    {% if trattamenti.has_other_pages %}
    <div class="card-footer">
        <nav aria-label="Paginazione trattamenti">
            <ul class="pagination justify-content-center mb-0">
                {% if trattamenti.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ trattamenti.previous_page_number }}">
                            <i class="fas fa-chevron-left"></i> Precedente
                        </a>
                    </li>
                {% endif %}
                
                {% for num in trattamenti.paginator.page_range %}
                    {% if trattamenti.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > trattamenti.number|add:'-3' and num < trattamenti.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if trattamenti.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ trattamenti.next_page_number }}">
                            Successiva <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
    
    {% else %}
    <div class="card-body text-center py-5">
        <i class="fas fa-flask fa-3x text-muted mb-3"></i>
        <h4>Nessun trattamento trovato</h4>
        <p class="text-muted">Non ci sono trattamenti che corrispondono ai filtri selezionati.</p>
        <a href="{% url 'inserisci' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Crea Nuovo Trattamento
        </a>
    </div>
    {% endif %}
</div>

<!-- Modal per conferme -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Conferma Azione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Contenuto dinamico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" id="confirmModalAction">Conferma</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Anteprima Comunicazione -->
<div class="modal fade" id="communicationPreviewModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-envelope-open-text me-2"></i>
                    Anteprima Comunicazione Email
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body">
                <!-- Loading -->
                <div id="previewLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Caricamento...</span>
                    </div>
                    <p class="mt-3">Generazione anteprima email...</p>
                </div>
                
                <!-- Preview Content -->
                <div id="previewContent" style="display: none;">
                    <!-- Email Info -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-info-circle text-info me-2"></i>
                                        Informazioni Invio
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <strong>Trattamenti selezionati:</strong> 
                                        <span id="selectedCount" class="badge bg-primary">0</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Totale destinatari:</strong> 
                                        <span id="totalRecipients" class="badge bg-info">0</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>PDF generati:</strong> 
                                        <span id="totalPdfs" class="badge bg-success">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-users text-success me-2"></i>
                                        Destinatari
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="recipientsList" class="max-height-200 overflow-auto">
                                        <!-- Lista dinamica destinatari -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Email Preview -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-envelope text-primary me-2"></i>
                                Anteprima Email (primo trattamento)
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="email-preview border rounded p-3" style="background: #f8f9fa;">
                                <div class="mb-3">
                                    <strong>Da:</strong> <span id="emailFrom"></span>
                                </div>
                                <div class="mb-3">
                                    <strong>A:</strong> <span id="emailTo"></span>
                                </div>
                                <div class="mb-3">
                                    <strong>Oggetto:</strong> <span id="emailSubject" class="text-primary"></span>
                                </div>
                                <hr>
                                <div class="mb-3">
                                    <strong>Corpo del messaggio:</strong>
                                </div>
                                <div id="emailBody" class="border rounded p-3 bg-white" style="font-family: monospace; white-space: pre-line; max-height: 300px; overflow-y: auto;">
                                    <!-- Corpo email -->
                                </div>
                                <hr>
                                <div class="mb-3">
                                    <strong>Allegati:</strong>
                                    <div id="emailAttachments">
                                        <!-- Lista allegati -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Altri trattamenti -->
                    <div id="otherTreatments" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-list text-secondary me-2"></i>
                                    Altri trattamenti da comunicare
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="otherTreatmentsList">
                                    <!-- Lista altri trattamenti -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer bg-light">
                <div class="w-100">
                    <div class="row">
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-secondary w-100" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>
                                Annulla
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-warning w-100" onclick="downloadPdfsOnly()">
                                <i class="fas fa-download me-2"></i>
                                Solo Download PDF
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-primary w-100" onclick="sendEmailsOnly()">
                                <i class="fas fa-paper-plane me-2"></i>
                                Solo Invio
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-success w-100" onclick="sendAndDownload()">
                                <i class="fas fa-paper-plane me-1"></i>
                                <i class="fas fa-download me-1"></i>
                                Invia + PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.max-height-200 {
    max-height: 200px;
}

.email-preview {
    font-size: 0.9rem;
}

#recipientsList .recipient-item {
    padding: 0.25rem 0;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

#recipientsList .recipient-item:last-child {
    border-bottom: none;
}

.treatment-item {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    background: white;
}

.modal-xl {
    max-width: 1200px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let selectedTreatments = [];

// Gestione selezione
function updateSelection() {
    selectedTreatments = [];
    document.querySelectorAll('.trattamento-checkbox:checked').forEach(checkbox => {
        selectedTreatments.push(parseInt(checkbox.value));
        document.getElementById('row-' + checkbox.value).classList.add('selected-row');
    });
    
    // Rimuovi classe da righe non selezionate
    document.querySelectorAll('.trattamento-checkbox:not(:checked)').forEach(checkbox => {
        document.getElementById('row-' + checkbox.value).classList.remove('selected-row');
    });
    
    // Aggiorna interfaccia
    updateBulkActionsVisibility();
    updateSelectionCounter();
}

function updateBulkActionsVisibility() {
    const bulkActions = document.getElementById('bulkActions');
    if (selectedTreatments.length > 0) {
        bulkActions.classList.add('show');
    } else {
        bulkActions.classList.remove('show');
    }
}

function updateSelectionCounter() {
    const counter = document.getElementById('selectionCounter');
    const count = selectedTreatments.length;
    counter.textContent = `${count} trattament${count === 1 ? 'o' : 'i'} selezionat${count === 1 ? 'o' : 'i'}`;
}

function selectAll() {
    document.querySelectorAll('.trattamento-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    document.getElementById('selectAllCheckbox').checked = true;
    updateSelection();
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    document.querySelectorAll('.trattamento-checkbox').forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    updateSelection();
}

function clearSelection() {
    document.querySelectorAll('.trattamento-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectAllCheckbox').checked = false;
    updateSelection();
}

function showConfirmModal(title, message, onConfirm) {
    document.getElementById('confirmModalTitle').textContent = title;
    document.getElementById('confirmModalBody').innerHTML = `<p>${message}</p>`;
    
    const confirmButton = document.getElementById('confirmModalAction');
    confirmButton.onclick = () => {
        onConfirm();
    };
    
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
}


// Azioni in blocco
function bulkCommunicate() {
    if (selectedTreatments.length === 0) return;
    
    showConfirmModal(
        'Comunica Trattamenti',
        `Sei sicuro di voler comunicare ${selectedTreatments.length} trattament${selectedTreatments.length === 1 ? 'o' : 'i'}? Verranno inviate le email ai contoterzisti.`,
        () => executeBulkAction('comunica')
    );
}

function bulkComplete() {
    if (selectedTreatments.length === 0) return;
    
    showConfirmModal(
        'Completa Trattamenti',
        `Sei sicuro di voler contrassegnare come completati ${selectedTreatments.length} trattament${selectedTreatments.length === 1 ? 'o' : 'i'}?`,
        () => executeBulkAction('completa')
    );
}

function bulkAnnulla() {
    if (selectedTreatments.length === 0) return;
    
    showConfirmModal(
        'Annulla Trattamenti',
        `Sei sicuro di voler annullare ${selectedTreatments.length} trattament${selectedTreatments.length === 1 ? 'o' : 'i'}?`,
        () => executeBulkAction('annulla')
    );
}

function executeBulkAction(action) {
    // Mostra loading
    const loadingHtml = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Elaborazione in corso...</p>
        </div>
    `;
    
    document.getElementById('confirmModalBody').innerHTML = loadingHtml;
    
    // Prepara i dati per l'invio
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCsrfToken());
    formData.append('action', action);
    formData.append('trattamenti_ids', JSON.stringify(selectedTreatments));
    
    // Invia richiesta
    fetch('/api/trattamenti/bulk-action/', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Successo - ricarica la pagina dopo 2 secondi
            document.getElementById('confirmModalBody').innerHTML = `
                <div class="text-center text-success">
                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                    <h5>Operazione completata!</h5>
                    <p>${data.message}</p>
                    <p><small>La pagina si ricaricherà automaticamente...</small></p>
                </div>
            `;
            
            setTimeout(() => {
                location.reload();
            }, 2000);
            
        } else {
            // Errore
            document.getElementById('confirmModalBody').innerHTML = `
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h5>Errore!</h5>
                    <p>${data.error || 'Errore sconosciuto'}</p>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Errore:', error);
        document.getElementById('confirmModalBody').innerHTML = `
            <div class="text-center text-danger">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h5>Errore di connessione!</h5>
                <p>Si è verificato un errore durante l'elaborazione della richiesta.</p>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        `;
    });
}

// JavaScript per gestione anteprima comunicazione - aggiungi a trattamenti_table.html

let currentCommunicationData = null;

// Modifica la funzione bulkCommunicate esistente
function bulkCommunicate() {
    if (selectedTreatments.length === 0) return;
    
    // Invece di mostrare subito il modal di conferma, mostra l'anteprima
    showCommunicationPreview();
}

function showCommunicationPreview() {
    // Mostra il modal di anteprima
    const modal = new bootstrap.Modal(document.getElementById('communicationPreviewModal'));
    modal.show();
    
    // Mostra loading
    document.getElementById('previewLoading').style.display = 'block';
    document.getElementById('previewContent').style.display = 'none';
    
    // Carica anteprima
    loadCommunicationPreview();
}

function loadCommunicationPreview() {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCsrfToken());
    formData.append('trattamenti_ids', JSON.stringify(selectedTreatments));
    
    fetch('/api/trattamenti/communication-preview/', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentCommunicationData = data;
            displayCommunicationPreview(data);
        } else {
            showPreviewError(data.error || 'Errore nel caricamento anteprima');
        }
    })
    .catch(error => {
        console.error('Errore:', error);
        showPreviewError('Errore di connessione durante il caricamento anteprima');
    });
}

function displayCommunicationPreview(data) {
    // Nascondi loading
    document.getElementById('previewLoading').style.display = 'none';
    document.getElementById('previewContent').style.display = 'block';
    
    // Aggiorna informazioni generali
    document.getElementById('selectedCount').textContent = data.trattamenti_count;
    document.getElementById('totalRecipients').textContent = data.total_recipients;
    document.getElementById('totalPdfs').textContent = data.trattamenti_count;
    
    // Mostra destinatari
    const recipientsList = document.getElementById('recipientsList');
    recipientsList.innerHTML = '';
    
    const uniqueRecipients = [...new Set(data.all_recipients.map(r => r.email))];
    uniqueRecipients.forEach(email => {
        const recipients = data.all_recipients.filter(r => r.email === email);
        const recipient = recipients[0];
        
        const item = document.createElement('div');
        item.className = 'recipient-item';
        item.innerHTML = `
            <i class="fas fa-envelope text-primary"></i>
            <div class="flex-grow-1">
                <strong>${recipient.nome}</strong> (${recipient.email})
                <br><small class="text-muted">${recipient.ruolo || 'Contatto'} - ${recipients.length} trattament${recipients.length === 1 ? 'o' : 'i'}</small>
            </div>
        `;
        recipientsList.appendChild(item);
    });
    
    // Mostra anteprima email (primo trattamento)
    const firstEmail = data.email_previews[0];
    if (firstEmail) {
        document.getElementById('emailFrom').textContent = firstEmail.from_email;
        document.getElementById('emailTo').textContent = firstEmail.recipients.join(', ');
        document.getElementById('emailSubject').textContent = firstEmail.subject;
        document.getElementById('emailBody').textContent = firstEmail.body;
        
        // Mostra allegati
        const attachmentsDiv = document.getElementById('emailAttachments');
        attachmentsDiv.innerHTML = '';
        firstEmail.attachments.forEach(attachment => {
            const attachmentItem = document.createElement('div');
            attachmentItem.className = 'd-inline-block me-2 mb-1';
            attachmentItem.innerHTML = `
                <span class="badge bg-secondary">
                    <i class="fas fa-file-pdf me-1"></i>${attachment}
                </span>
            `;
            attachmentsDiv.appendChild(attachmentItem);
        });
    }
    
    // Mostra altri trattamenti se ce ne sono più di uno
    if (data.trattamenti_count > 1) {
        document.getElementById('otherTreatments').style.display = 'block';
        const otherList = document.getElementById('otherTreatmentsList');
        otherList.innerHTML = '';
        
        data.email_previews.slice(1).forEach((email, index) => {
            const item = document.createElement('div');
            item.className = 'treatment-item';
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>Trattamento #${email.trattamento_id}</strong> - ${email.cliente_nome}
                        <br><small class="text-muted">${email.recipients.length} destinatar${email.recipients.length === 1 ? 'io' : 'i'}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="showEmailDetails(${index + 1})">
                        <i class="fas fa-eye"></i> Dettagli
                    </button>
                </div>
            `;
            otherList.appendChild(item);
        });
    }
}

function showPreviewError(message) {
    document.getElementById('previewLoading').innerHTML = `
        <div class="text-center text-danger py-5">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h5>Errore nel caricamento</h5>
            <p>${message}</p>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
        </div>
    `;
}

function showEmailDetails(index) {
    if (!currentCommunicationData || !currentCommunicationData.email_previews[index]) return;
    
    const email = currentCommunicationData.email_previews[index];
    
    // Aggiorna l'anteprima con i dettagli di questo trattamento
    document.getElementById('emailFrom').textContent = email.from_email;
    document.getElementById('emailTo').textContent = email.recipients.join(', ');
    document.getElementById('emailSubject').textContent = email.subject;
    document.getElementById('emailBody').textContent = email.body;
    
    // Aggiorna allegati
    const attachmentsDiv = document.getElementById('emailAttachments');
    attachmentsDiv.innerHTML = '';
    email.attachments.forEach(attachment => {
        const attachmentItem = document.createElement('div');
        attachmentItem.className = 'd-inline-block me-2 mb-1';
        attachmentItem.innerHTML = `
            <span class="badge bg-secondary">
                <i class="fas fa-file-pdf me-1"></i>${attachment}
            </span>
        `;
        attachmentsDiv.appendChild(attachmentItem);
    });
    
    // Scroll to email preview
    document.querySelector('.email-preview').scrollIntoView({ behavior: 'smooth' });
}

// Funzioni per le azioni finali
function downloadPdfsOnly() {
    if (!currentCommunicationData) return;
    
    bootstrap.Modal.getInstance(document.getElementById('communicationPreviewModal')).hide();
    
    // Mostra loading
    showLoadingModal('Download PDF in corso...');
    
    executeCommunicationAction('download_only');
}

function sendEmailsOnly() {
    if (!currentCommunicationData) return;
    
    bootstrap.Modal.getInstance(document.getElementById('communicationPreviewModal')).hide();
    
    // Mostra loading
    showLoadingModal('Invio email in corso...');
    
    executeCommunicationAction('send_only');
}

function sendAndDownload() {
    if (!currentCommunicationData) return;
    
    bootstrap.Modal.getInstance(document.getElementById('communicationPreviewModal')).hide();
    
    // Mostra loading
    showLoadingModal('Invio email e download PDF in corso...');
    
    executeCommunicationAction('send_and_download');
}

function executeCommunicationAction(action) {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCsrfToken());
    formData.append('action', 'comunica');  // Azione base
    formData.append('communication_mode', action);  // Modalità specifica
    formData.append('trattamenti_ids', JSON.stringify(selectedTreatments));
    
    fetch('/api/trattamenti/bulk-action/', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        hideLoadingModal();
        
        if (data.success) {
            // Gestisci download se richiesto
            if (action === 'download_only' || action === 'send_and_download') {
                handlePdfDownloads(data.pdf_downloads || []);
            }
            
            // Mostra messaggio di successo
            showSuccessModal(data.message, () => {
                location.reload();
            });
            
        } else {
            showErrorModal(data.error || 'Errore sconosciuto');
        }
    })
    .catch(error => {
        hideLoadingModal();
        console.error('Errore:', error);
        showErrorModal('Errore di connessione durante l\'elaborazione');
    });
}

function handlePdfDownloads(downloads) {
    if (!downloads || downloads.length === 0) return;
    
    // Download multipli con pausa tra uno e l'altro
    downloads.forEach((download, index) => {
        setTimeout(() => {
            const link = document.createElement('a');
            link.href = download.url;
            link.download = download.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }, index * 500); // Pausa di 500ms tra i download
    });
}

// Funzioni di utilità per i modal
function showLoadingModal(message) {
    const modal = document.getElementById('loadingModal') || createLoadingModal();
    modal.querySelector('.loading p').textContent = message;
    new bootstrap.Modal(modal).show();
}

function hideLoadingModal() {
    const modal = document.getElementById('loadingModal');
    if (modal) {
        const instance = bootstrap.Modal.getInstance(modal);
        if (instance) instance.hide();
    }
}

function showSuccessModal(message, onClose) {
    const modal = createResultModal('Operazione Completata!', message, 'success', onClose);
    new bootstrap.Modal(modal).show();
}

function showErrorModal(message) {
    const modal = createResultModal('Errore!', message, 'error');
    new bootstrap.Modal(modal).show();
}

function createLoadingModal() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'loadingModal';
    modal.setAttribute('data-bs-backdrop', 'static');
    modal.innerHTML = `
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center loading">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Elaborazione in corso...</p>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    return modal;
}

function createResultModal(title, message, type, onClose) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header ${type === 'success' ? 'bg-success' : 'bg-danger'} text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                        ${title}
                    </h5>
                </div>
                <div class="modal-body">
                    <p style="white-space: pre-line;">${message}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                </div>
            </div>
        </div>
    `;
    
    if (onClose) {
        modal.addEventListener('hidden.bs.modal', onClose);
    }
    
    // Auto-remove modal after hiding
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
    
    document.body.appendChild(modal);
    return modal;
}

</script>

{% endblock %}