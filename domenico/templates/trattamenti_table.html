{% extends 'base.html' %}
{% load aziende_extras %}

{% block page_title %}{{ view_title }}{% endblock %}
{% block page_icon %}<i class="fas fa-list"></i>{% endblock %}

{% block extra_css %}
<style>
    /* Stili per selezione multipla */
    .bulk-actions {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 2px solid #e9ecef;
        display: none;
    }
    
    .bulk-actions.show {
        display: block;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .selection-counter {
        font-weight: bold;
        color: #007bff;
    }
    
    .checkbox-column {
        width: 40px;
        text-align: center;
        padding: 8px !important;
    }
    
    .trattamento-checkbox {
        transform: scale(1.2);
        cursor: pointer;
        pointer-events: none; /* Disabilita il click diretto sul checkbox */
    }
    
    /* Stili per righe selezionabili */
    .selectable-row {
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }
    
    .selectable-row:hover {
        background-color: #f8f9fa !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .selectable-row.selected-row {
        background-color: #e3f2fd !important;
        border-left: 4px solid #2196f3;
    }
    
    .selectable-row.selected-row:hover {
        background-color: #bbdefb !important;
    }
    
    /* Indicatore visivo di selezione */
    .selection-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 2px;
        background: #ddd;
        margin-right: 8px;
        transition: all 0.2s ease;
    }
    
    .selected-row .selection-indicator {
        background: #2196f3;
    }
    
    .bulk-action-btn {
        margin-right: 0.5rem;
        min-width: 120px;
    }
    
    .table-header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    /* Stili per i badge di stato */
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-programmato {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .status-comunicato {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .status-completato {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-annullato {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f1aeb5;
    }
    
    /* Tooltip per istruzioni */
    .selection-help {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: #f8f9fa;
        border-left: 3px solid #007bff;
        border-radius: 4px;
    }
    
    /* Evidenziamento header quando in modalit√† selezione */
    .selection-mode .table thead th {
        background-color: #e3f2fd !important;
    }
    
    /* Animazione contatore selezione */
    .selection-counter {
        transition: all 0.3s ease;
    }
    
    .selection-counter.updated {
        transform: scale(1.1);
        color: #28a745;
    }

     .prodotti-cell {
        max-width: 300px;
        padding: 0.5rem !important;
    }
    
    .prodotti-list {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .prodotto-item {
        background: #f8f9fa;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        border-left: 3px solid #007bff;
        font-size: 0.85rem;
    }
    
    .prodotto-nome {
        font-weight: 600;
        color: #495057;
        display: block;
    }
    
    .prodotto-quantita {
        color: #007bff;
        font-weight: 500;
        font-size: 0.8rem;
    }
    
    .prodotto-totale {
        display: block;
        font-size: 0.75rem;
        margin-top: 0.125rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .prodotti-cell {
            max-width: 200px;
        }
        
        .prodotto-item {
            padding: 0.2rem 0.4rem;
        }
    }

</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>{{ view_title }}</h1>
        <p class="text-muted">{{ view_description }}</p>
    </div>
    <div>
        <a href="{% url 'trattamenti' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Dashboard
        </a>
        <a href="{% url 'inserisci' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Nuovo Trattamento
        </a>
    </div>
</div>

<!-- Statistiche rapide -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">{{ stats.filtrati }}</h5>
                <p class="card-text">Visualizzati</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">{{ stats.programmati }}</h5>
                <p class="card-text">Programmati</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">{{ stats.comunicati }}</h5>
                <p class="card-text">Comunicati</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">{{ stats.completati }}</h5>
                <p class="card-text">Completati</p>
            </div>
        </div>
    </div>
</div>

<!-- Azioni in blocco -->
<div id="bulkActions" class="bulk-actions">
    <div class="d-flex align-items-center justify-content-between">
        <div>
            <i class="fas fa-check-circle text-success"></i>
            <span class="selection-counter" id="selectionCounter">0 trattamenti selezionati</span>
        </div>
        <div>
            {% if next_action == 'comunica' %}
                <button class="btn btn-primary bulk-action-btn" onclick="bulkCommunicate()">
                    <i class="fas fa-paper-plane"></i> Comunica Selezionati
                </button>
            {% elif next_action == 'completa' %}
                <button class="btn btn-success bulk-action-btn" onclick="bulkComplete()">
                    <i class="fas fa-check"></i> Completa Selezionati
                </button>
            {% endif %}
            
            <button class="btn btn-warning bulk-action-btn" onclick="bulkAnnulla()">
                <i class="fas fa-times"></i> Annulla Selezionati
            </button>
            
            <button class="btn btn-outline-secondary" onclick="clearSelection()">
                <i class="fas fa-times"></i> Deseleziona Tutto
            </button>
        </div>
    </div>
</div>

<!-- Filtri -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-filter"></i> Filtri di Ricerca
        </h5>
    </div>
    <div class="card-body">
        <form method="GET" class="row">
            <!-- Campo nascosto per preservare il parametro view -->
            {% if view_type and view_type != 'dashboard' %}
                <input type="hidden" name="view" value="{{ view_type }}">
            {% endif %}
            
            <div class="col-md-3">
                <label class="form-label">Ricerca</label>
                <input type="text" class="form-control" name="search" value="{{ filters.search }}" 
                       placeholder="Cliente, cascina, note, ID...">
            </div>
            <div class="col-md-3">
                <label class="form-label">Cliente</label>
                <select class="form-select" name="cliente">
                    <option value="">Tutti i clienti</option>
                    {% for cliente in clienti %}
                    <option value="{{ cliente.id }}" {% if filters.cliente == cliente.id|stringformat:"s" %}selected{% endif %}>
                        {{ cliente.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Cascina</label>
                <select class="form-select" name="cascina">
                    <option value="">Tutte le cascine</option>
                    {% for cascina in cascine %}
                    <option value="{{ cascina.id }}" {% if filters.cascina == cascina.id|stringformat:"s" %}selected{% endif %}>
                        {{ cascina.nome }} ({{ cascina.cliente.nome }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Contoterzista</label>
                <select class="form-select" name="contoterzista">
                    <option value="">Tutti i contoterzisti</option>
                    {% for contoterzista in contoterzisti %}
                    <option value="{{ contoterzista.id }}" {% if filters.contoterzista == contoterzista.id|stringformat:"s" %}selected{% endif %}>
                        {{ contoterzista.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 mt-3">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i> Filtra
                </button>
                <a href="?{% if view_type and view_type != 'dashboard' %}view={{ view_type }}{% endif %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Pulisci
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Tabella Trattamenti -->
<div class="card">
    <div class="card-header">
        <div class="table-header-actions">
            <h5 class="mb-0">
                <i class="fas fa-list"></i> 
                Elenco Trattamenti ({{ stats.filtrati }})
            </h5>
            <div>
                <button class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                    <i class="fas fa-check-square"></i> Seleziona Tutti
                </button>
            </div>
        </div>
        <div class="selection-help">
            <i class="fas fa-info-circle"></i> 
            <strong>Tip:</strong> Clicca su una riga qualsiasi per selezionare/deselezionare un trattamento. 
            Usa Ctrl+Click per selezione multipla.
        </div>
    </div>
    
    {% if trattamenti %}
    <div class="table-responsive">
        <table class="table table-hover mb-0" id="trattamentiTable">
            <thead class="table-light">
                <tr>
                    <th class="checkbox-column">
                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                    </th>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Cascina/Terreni</th>
                    <th>Superficie</th>
                    <th>Stato</th>
                    <th>Data Inserimento</th>
                    <th>Prodotti</th>
                    <th>Note</th>
                </tr>
            </thead>
            <tbody>
                {% for trattamento in trattamenti %}
                <tr id="row-{{ trattamento.id }}" 
                    class="selectable-row" 
                    data-treatment-id="{{ trattamento.id }}"
                    onclick="toggleRowSelection({{ trattamento.id }}, event)">
                    
                    <td class="checkbox-column">
                        <span class="selection-indicator"></span>
                        <input type="checkbox" 
                               class="trattamento-checkbox" 
                               value="{{ trattamento.id }}" 
                               onchange="updateSelection()">
                    </td>
                    
                    <td><strong>#{{ trattamento.id }}</strong></td>
                    
                    <td>
                        <strong>{{ trattamento.cliente.nome }}</strong>
                        {% if trattamento.cascina.contoterzista %}
                            <br><small class="text-muted">
                                <i class="fas fa-user-tie"></i> {{ trattamento.cascina.contoterzista.nome }}
                            </small>
                        {% endif %}
                    </td>
                    
                    <td>
                        {% if trattamento.livello_applicazione == 'cliente' %}
                            <span class="badge bg-secondary">Tutto il cliente</span>
                        {% elif trattamento.livello_applicazione == 'cascina' %}
                            <i class="fas fa-home text-primary"></i> {{ trattamento.cascina.nome }}
                        {% else %}
                            <i class="fas fa-seedling text-success"></i>
                            {% for terreno in trattamento.terreni.all %}
                                {{ terreno.nome }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                            <br><small class="text-muted">{{ trattamento.cascina.nome }}</small>
                        {% endif %}
                    </td>
                    
                    <td>
                        <strong>{{ trattamento.get_superficie_interessata|floatformat:2 }} ha</strong>
                    </td>
                    
                    <td>
                        <span class="status-badge status-{{ trattamento.stato }}">
                            {{ trattamento.get_stato_display }}
                        </span>
                    </td>
                    
                    <td>
                        {{ trattamento.data_inserimento|date:"d/m/Y" }}
                        <br><small class="text-muted">{{ trattamento.data_inserimento|date:"H:i" }}</small>
                    </td>
                    
                    <td class="prodotti-cell">
                        {% if trattamento.trattamentoprodotto_set.all %}
                            <div class="prodotti-list">
                                {% for tp in trattamento.trattamentoprodotto_set.all %}
                                    <div class="prodotto-item">
                                        <span class="prodotto-nome">{{ tp.prodotto.nome }}</span>
                                        <span class="prodotto-quantita">
                                            {{ tp.quantita_per_ettaro|floatformat:2 }} {{ tp.prodotto.unita_misura }}/ha
                                        </span>
                                        <small class="prodotto-totale text-muted">
                                            (Tot: {{ tp.quantita_totale|floatformat:3 }} {{ tp.prodotto.unita_misura }})
                                        </small>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="text-muted">
                                <i class="fas fa-exclamation-triangle"></i>
                                Nessun prodotto associato
                            </span>
                        {% endif %}
                    </td>
                    
                    <td>
                        {% if trattamento.note %}
                            <span class="text-truncate" style="max-width: 150px;" title="{{ trattamento.note }}">
                                {{ trattamento.note|truncatechars:50 }}
                            </span>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="card-body text-center py-5">
        <div class="text-muted">
            <i class="fas fa-search fa-3x mb-3"></i>
            <h5>Nessun trattamento trovato</h5>
            <p>Prova a modificare i filtri di ricerca o <a href="{% url 'inserisci' %}">crea un nuovo trattamento</a>.</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Paginazione -->
{% if is_paginated %}
<nav aria-label="Paginazione trattamenti" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?{% if view_type and view_type != 'dashboard' %}view={{ view_type }}&{% endif %}{% for key, value in request.GET.items %}{% if key != 'page' and key != 'view' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">Prima</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?{% if view_type and view_type != 'dashboard' %}view={{ view_type }}&{% endif %}{% for key, value in request.GET.items %}{% if key != 'page' and key != 'view' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">Precedente</a>
            </li>
        {% endif %}
        
        <li class="page-item active">
            <span class="page-link">
                Pagina {{ page_obj.number }} di {{ page_obj.paginator.num_pages }}
            </span>
        </li>
        
        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?{% if view_type and view_type != 'dashboard' %}view={{ view_type }}&{% endif %}{% for key, value in request.GET.items %}{% if key != 'page' and key != 'view' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">Successiva</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?{% if view_type and view_type != 'dashboard' %}view={{ view_type }}&{% endif %}{% for key, value in request.GET.items %}{% if key != 'page' and key != 'view' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">Ultima</a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Modali di conferma -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Conferma Azione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Contenuto dinamico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" id="confirmModalAction">Conferma</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedTreatments = [];

// Funzione principale per la selezione delle righe
function toggleRowSelection(treatmentId, event) {
    // Previeni la propagazione se si clicca direttamente su un elemento interattivo
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'BUTTON' || event.target.tagName === 'A') {
        return;
    }
    
    const checkbox = document.querySelector(`input[value="${treatmentId}"]`);
    const row = document.getElementById(`row-${treatmentId}`);
    
    // Toggle della selezione
    checkbox.checked = !checkbox.checked;
    
    // Aggiorna visivamente la riga
    if (checkbox.checked) {
        row.classList.add('selected-row');
    } else {
        row.classList.remove('selected-row');
    }
    
    // Aggiorna la selezione globale
    updateSelection();
    
    // Effetto visivo
    animateRowSelection(row, checkbox.checked);
}

function animateRowSelection(row, isSelected) {
    if (isSelected) {
        row.style.transform = 'scale(1.02)';
        setTimeout(() => {
            row.style.transform = '';
        }, 200);
    }
}

// Gestione selezione
function updateSelection() {
    selectedTreatments = [];
    const table = document.getElementById('trattamentiTable');
    
    document.querySelectorAll('.trattamento-checkbox:checked').forEach(checkbox => {
        selectedTreatments.push(parseInt(checkbox.value));
        document.getElementById('row-' + checkbox.value).classList.add('selected-row');
    });
    
    // Rimuovi classe da righe non selezionate
    document.querySelectorAll('.trattamento-checkbox:not(:checked)').forEach(checkbox => {
        document.getElementById('row-' + checkbox.value).classList.remove('selected-row');
    });
    
    // Aggiorna interfaccia
    updateBulkActionsVisibility();
    updateSelectionCounter();
    
    // Aggiungi/rimuovi classe di modalit√† selezione
    if (selectedTreatments.length > 0) {
        table.classList.add('selection-mode');
    } else {
        table.classList.remove('selection-mode');
    }
}

function updateBulkActionsVisibility() {
    const bulkActions = document.getElementById('bulkActions');
    if (selectedTreatments.length > 0) {
        bulkActions.classList.add('show');
    } else {
        bulkActions.classList.remove('show');
    }
}

function updateSelectionCounter() {
    const counter = document.getElementById('selectionCounter');
    const count = selectedTreatments.length;
    counter.textContent = `${count} trattament${count === 1 ? 'o' : 'i'} selezionat${count === 1 ? 'o' : 'i'}`;
    
    // Animazione del contatore
    counter.classList.add('updated');
    setTimeout(() => {
        counter.classList.remove('updated');
    }, 300);
}

function selectAll() {
    document.querySelectorAll('.trattamento-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    document.getElementById('selectAllCheckbox').checked = true;
    updateSelection();
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    document.querySelectorAll('.trattamento-checkbox').forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    updateSelection();
}

function clearSelection() {
    document.querySelectorAll('.trattamento-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectAllCheckbox').checked = false;
    updateSelection();
}

function showConfirmModal(title, message, onConfirm) {
    document.getElementById('confirmModalTitle').textContent = title;
    document.getElementById('confirmModalBody').innerHTML = `<p>${message}</p>`;
    
    const confirmButton = document.getElementById('confirmModalAction');
    confirmButton.onclick = () => {
        bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
        onConfirm();
    };
    
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
}

// Azioni in blocco
function bulkCommunicate() {
    if (selectedTreatments.length === 0) return;
    
    showConfirmModal(
        'Comunica Trattamenti',
        `Sei sicuro di voler comunicare ${selectedTreatments.length} trattament${selectedTreatments.length === 1 ? 'o' : 'i'}? Verranno inviate le email ai contoterzisti.`,
        () => executeBulkAction('comunica')
    );
}

function bulkComplete() {
    if (selectedTreatments.length === 0) return;
    
    showConfirmModal(
        'Completa Trattamenti',
        `Sei sicuro di voler contrassegnare come completati ${selectedTreatments.length} trattament${selectedTreatments.length === 1 ? 'o' : 'i'}?`,
        () => executeBulkAction('completa')
    );
}

function bulkAnnulla() {
    if (selectedTreatments.length === 0) return;
    
    showConfirmModal(
        'Annulla Trattamenti',
        `Sei sicuro di voler annullare ${selectedTreatments.length} trattament${selectedTreatments.length === 1 ? 'o' : 'i'}?`,
        () => executeBulkAction('annulla')
    );
}

function executeBulkAction(action) {
    // Implementa le azioni in blocco qui
    console.log(`Executing ${action} on treatments:`, selectedTreatments);
    
    // Simula azione
    alert(`Azione "${action}" eseguita su ${selectedTreatments.length} trattamenti`);
    
    // Pulisci selezione dopo l'azione
    clearSelection();
}

// Inizializzazione
document.addEventListener('DOMContentLoaded', function() {
    // Gestione keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'a') {
            e.preventDefault();
            selectAll();
        }
        if (e.key === 'Escape') {
            clearSelection();
        }
    });
    
    console.log('‚úÖ Sistema di selezione trattamenti inizializzato');
});
</script>
{% endblock %}