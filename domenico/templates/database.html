{% extends 'base.html' %}

{% block page_title %}Gestione Database{% endblock %}
{% block page_icon %}<i class="fas fa-database"></i>{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #007bff;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --danger-color: #dc3545;
        --purple-color: #6f42c1;
        --light-bg: #f8f9fa;
        --border-color: #dee2e6;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-success: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    /* Stili delle statistiche */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-card .icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        opacity: 0.8;
    }

    .stat-card .number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-card .label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    /* Azioni Rapide */
    .quick-add-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
    }

    .quick-add-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
    }

    .quick-add-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
    }

    .quick-add-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: var(--gradient-success);
        color: white;
        text-decoration: none;
        border-radius: 10px;
        transition: all 0.3s ease;
        min-height: 100px;
        border: none;
        cursor: pointer;
    }

    .quick-add-btn:hover {
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        text-decoration: none;
    }

    .quick-add-btn i {
        font-size: 2rem;
        margin-bottom: 8px;
    }

    /* Sezioni di Gestione */
    .management-sections {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .section-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: var(--shadow);
        transition: transform 0.3s ease;
    }

    .section-card:hover {
        transform: translateY(-3px);
    }

    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .section-header i {
        font-size: 1.5rem;
        color: var(--primary-color);
        margin-right: 10px;
    }

    .section-header h3 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
    }

    .section-description {
        color: #666;
        margin-bottom: 20px;
        line-height: 1.5;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }

    .btn-primary-action {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary-action:hover {
        background: #0056b3;
        color: white;
        text-decoration: none;
    }

    .btn-secondary-action {
        background: #6c757d;
        color: white;
    }

    .btn-secondary-action:hover {
        background: #545b62;
        color: white;
        text-decoration: none;
    }

    /* Stili Modal */
    .modal-header {
        background: var(--gradient-primary);
        color: white;
        border-bottom: none;
    }

    .modal-header .btn-close {
        filter: invert(1);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 10px 15px;
        transition: border-color 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .btn-success {
        background: var(--gradient-success);
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #218838 0%, #1da688 100%);
    }

    /* Loading spinner */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Toast personalizzati */
    .toast-container {
        z-index: 9999;
    }

    /* Stili per contatti dinamici */
    .contatto-item {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        position: relative;
    }

    .contatto-item .btn-remove {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .contatto-item .btn-remove:hover {
        background: #c82333;
    }

    .form-row-inline {
        display: flex;
        gap: 15px;
        align-items: end;
    }

    .form-row-inline .form-group {
        flex: 1;
    }

    /* Modal size fix */
    .modal-lg {
        max-width: 800px;
    }

    /* Responsività */
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .quick-add-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .management-sections {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            flex-direction: column;
        }

        .form-row-inline {
            flex-direction: column;
            gap: 0;
        }

        .modal-lg {
            max-width: 95%;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Statistiche -->
<div class="stats-grid">
    <div class="stat-card">
        <i class="fas fa-building icon"></i>
        <div class="number">{{ stats.clienti|default:0 }}</div>
        <div class="label">Clienti</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-home icon"></i>
        <div class="number">{{ stats.cascine|default:0 }}</div>
        <div class="label">Cascine</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-seedling icon"></i>
        <div class="number">{{ stats.terreni|default:0 }}</div>
        <div class="label">Terreni</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-user-tie icon"></i>
        <div class="number">{{ stats.contoterzisti|default:0 }}</div>
        <div class="label">Contoterzisti</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-flask icon"></i>
        <div class="number">{{ stats.prodotti|default:0 }}</div>
        <div class="label">Prodotti</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-chart-line icon"></i>
        <div class="number">{{ stats.trattamenti|default:0 }}</div>
        <div class="label">Trattamenti</div>
    </div>
</div>

<!-- Azioni Rapide -->
<div class="quick-add-section">
    <h2 class="quick-add-title">
        <i class="fas fa-plus-circle text-primary me-2"></i>
        Aggiungi Rapidamente
    </h2>
    
    <div class="quick-add-grid">
        <button class="quick-add-btn" onclick="openModal('clienteModal')">
            <i class="fas fa-building"></i>
            <strong>Nuovo Cliente</strong>
        </button>
        
        <button class="quick-add-btn" onclick="openModal('cascinaModal')">
            <i class="fas fa-home"></i>
            <strong>Nuova Cascina</strong>
        </button>
        
        <button class="quick-add-btn" onclick="openModal('terrenoModal')">
            <i class="fas fa-seedling"></i>
            <strong>Nuovo Terreno</strong>
        </button>
        
        <button class="quick-add-btn" onclick="openModal('contoterzastaModal')">
            <i class="fas fa-user-tie"></i>
            <strong>Nuovo Contoterzista</strong>
        </button>
        
        <button class="quick-add-btn" onclick="openModal('prodottoModal')">
            <i class="fas fa-flask"></i>
            <strong>Nuovo Prodotto</strong>
        </button>
        
        <button class="quick-add-btn" onclick="openModal('contattoModal')">
            <i class="fas fa-address-book"></i>
            <strong>Nuovo Contatto</strong>
        </button>
    </div>
</div>

<!-- Sezioni di Gestione -->
<div class="management-sections">
    <!-- Gestione Clienti -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-building"></i>
            <h3>Gestione Clienti</h3>
        </div>
        <div class="section-content">
            <p class="section-description">
                Gestisci le aziende agricole, modifica le informazioni di contatto e visualizza la struttura aziendale.
            </p>
            <div class="action-buttons">
                <button class="btn-action btn-primary-action" onclick="viewClients()">
                    <i class="fas fa-eye me-1"></i> Visualizza
                </button>
                <button class="btn-action btn-secondary-action" onclick="openModal('clienteModal')">
                    <i class="fas fa-plus me-1"></i> Aggiungi
                </button>
            </div>
        </div>
    </div>
    
    <!-- Gestione Cascine -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-home"></i>
            <h3>Gestione Cascine</h3>
        </div>
        <div class="section-content">
            <p class="section-description">
                Amministra le cascine, assegna contoterzisti e gestisci la struttura territoriale delle aziende.
            </p>
            <div class="action-buttons">
                <button class="btn-action btn-primary-action" onclick="viewCascine()">
                    <i class="fas fa-eye me-1"></i> Visualizza
                </button>
                <button class="btn-action btn-secondary-action" onclick="openModal('cascinaModal')">
                    <i class="fas fa-plus me-1"></i> Aggiungi
                </button>
            </div>
        </div>
    </div>
    
    <!-- Gestione Terreni -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-seedling"></i>
            <h3>Gestione Terreni</h3>
        </div>
        <div class="section-content">
            <p class="section-description">
                Configura i terreni, specifica le superfici e gestisci le tipologie di coltivazione.
            </p>
            <div class="action-buttons">
                <button class="btn-action btn-primary-action" onclick="viewTerreni()">
                    <i class="fas fa-eye me-1"></i> Visualizza
                </button>
                <button class="btn-action btn-secondary-action" onclick="openModal('terrenoModal')">
                    <i class="fas fa-plus me-1"></i> Aggiungi
                </button>
            </div>
        </div>
    </div>
    
    <!-- Gestione Contoterzisti -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-user-tie"></i>
            <h3>Gestione Contoterzisti</h3>
        </div>
        <div class="section-content">
            <p class="section-description">
                Amministra i contoterzisti, gestisci i contatti e le assegnazioni alle cascine.
            </p>
            <div class="action-buttons">
                <button class="btn-action btn-primary-action" onclick="viewContoterzisti()">
                    <i class="fas fa-eye me-1"></i> Visualizza
                </button>
                <button class="btn-action btn-secondary-action" onclick="openModal('contoterzastaModal')">
                    <i class="fas fa-plus me-1"></i> Aggiungi
                </button>
            </div>
        </div>
    </div>
    
    <!-- Gestione Prodotti -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-flask"></i>
            <h3>Gestione Prodotti</h3>
        </div>
        <div class="section-content">
            <p class="section-description">
                Configura i prodotti fitosanitari, principi attivi e specifiche tecniche per i trattamenti.
            </p>
            <div class="action-buttons">
                <button class="btn-action btn-primary-action" onclick="viewProdotti()">
                    <i class="fas fa-eye me-1"></i> Visualizza
                </button>
                <button class="btn-action btn-secondary-action" onclick="openModal('prodottoModal')">
                    <i class="fas fa-plus me-1"></i> Aggiungi
                </button>
            </div>
        </div>
    </div>
    
    <!-- Gestione Contatti -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-address-book"></i>
            <h3>Gestione Contatti</h3>
        </div>
        <div class="section-content">
            <p class="section-description">
                Gestisci i contatti email per le comunicazioni, configura priorità e ruoli.
            </p>
            <div class="action-buttons">
                <button class="btn-action btn-primary-action" onclick="viewContatti()">
                    <i class="fas fa-eye me-1"></i> Visualizza
                </button>
                <button class="btn-action btn-secondary-action" onclick="openModal('contattoModal')">
                    <i class="fas fa-plus me-1"></i> Aggiungi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cliente Semplificato -->
<div class="modal fade" id="clienteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-building me-2"></i>Nuovo Cliente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="clienteForm">
                    {% csrf_token %}
                    
                    <!-- Nome Azienda -->
                    <div class="form-group">
                        <label class="form-label">Nome Azienda *</label>
                        <input type="text" class="form-control" id="cliente-nome" required
                               placeholder="es. Azienda Agricola Rossi">
                    </div>
                    
                    <!-- Contatti Email -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-muted mb-0">CONTATTI EMAIL</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="aggiungiContatto()">
                                <i class="fas fa-plus me-1"></i> Aggiungi Contatto
                            </button>
                        </div>
                        <div id="contattiList">
                            <!-- I contatti verranno aggiunti dinamicamente qui -->
                        </div>
                        <small class="text-muted">I contatti email riceveranno le comunicazioni sui trattamenti</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-success" onclick="saveCliente()" id="saveClienteBtn">
                    <i class="fas fa-save me-2"></i>Salva Cliente
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cascina Semplificato -->
<div class="modal fade" id="cascinaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-home me-2"></i>Nuova Cascina
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cascinaForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label class="form-label">Cliente *</label>
                        <select class="form-select" id="cascina-cliente" required>
                            <option value="">Seleziona cliente...</option>
                            <!-- Popolato dinamicamente da JavaScript -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nome Cascina *</label>
                        <input type="text" class="form-control" id="cascina-nome" required
                               placeholder="es. Cascina del Monte">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Contoterzista</label>
                        <select class="form-select" id="cascina-contoterzista">
                            <option value="">Seleziona contoterzista...</option>
                            <!-- Popolato dinamicamente da JavaScript -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-success" onclick="saveCascina()" id="saveCascinaBtn">
                    <i class="fas fa-save me-2"></i>Salva Cascina
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-check-circle text-success me-2"></i>
            <strong class="me-auto">Sistema</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            <!-- Messaggio dinamico -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    console.log('Inizializzazione Database Management...');
    
    // Variabili globali per la gestione dei contatti
    let contattiCounter = 0;
    let clients = [];
    let contoterzisti = [];
    
    // Fix per il problema dei modal Bootstrap
    function openModal(modalType) {
        console.log('Apertura modal:', modalType);
        try {
            const modalElement = document.getElementById(modalType);
            if (!modalElement) {
                console.error('Modal non trovato:', modalType);
                alert(`Modal ${modalType} non trovato.`);
                return;
            }
            
            // Metodo alternativo per aprire il modal che evita l'errore Bootstrap
            modalElement.style.display = 'block';
            modalElement.classList.add('show');
            modalElement.setAttribute('aria-modal', 'true');
            modalElement.setAttribute('role', 'dialog');
            modalElement.removeAttribute('aria-hidden');
            
            // Aggiungi backdrop manualmente
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.id = `${modalType}-backdrop`;
            document.body.appendChild(backdrop);
            document.body.classList.add('modal-open');
            
            // Reset form quando si apre il modal
            if (modalType === 'clienteModal') {
                resetClienteForm();
            }
            
            // Gestione chiusura con ESC
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    closeModal(modalType);
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
            
            // Gestione chiusura con click sul backdrop
            backdrop.addEventListener('click', () => closeModal(modalType));
            
            // Gestione chiusura con bottone X
            const closeBtn = modalElement.querySelector('.btn-close');
            if (closeBtn) {
                closeBtn.onclick = () => closeModal(modalType);
            }
            
        } catch (error) {
            console.error('Errore apertura modal:', error);
            alert(`Errore nell'apertura del modal ${modalType}`);
        }
    }
    
    function closeModal(modalType) {
        console.log('Chiusura modal:', modalType);
        try {
            const modalElement = document.getElementById(modalType);
            const backdrop = document.getElementById(`${modalType}-backdrop`);
            
            if (modalElement) {
                modalElement.style.display = 'none';
                modalElement.classList.remove('show');
                modalElement.setAttribute('aria-hidden', 'true');
                modalElement.removeAttribute('aria-modal');
                modalElement.removeAttribute('role');
            }
            
            if (backdrop) {
                backdrop.remove();
            }
            
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
            
        } catch (error) {
            console.error('Errore chiusura modal:', error);
        }
    }
    
    // Gestione contatti dinamici per il cliente
    function aggiungiContatto() {
        contattiCounter++;
        const contattiList = document.getElementById('contattiList');
        
        const contattoDiv = document.createElement('div');
        contattoDiv.className = 'contatto-item';
        contattoDiv.id = `contatto-${contattiCounter}`;
        
        contattoDiv.innerHTML = `
            <button type="button" class="btn-remove" onclick="rimuoviContatto(${contattiCounter})">
                <i class="fas fa-times"></i>
            </button>
            <div class="form-row-inline mb-2">
                <div class="form-group">
                    <label class="form-label">Nome</label>
                    <input type="text" class="form-control" id="contatto-nome-${contattiCounter}" 
                           placeholder="es. Mario Rossi" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="contatto-email-${contattiCounter}" 
                           placeholder="mario.rossi@esempio.it" required>
                </div>
            </div>
            <div class="form-row-inline">
                <div class="form-group">
                    <label class="form-label">Ruolo</label>
                    <input type="text" class="form-control" id="contatto-ruolo-${contattiCounter}" 
                           placeholder="es. Responsabile, Agronomo">
                </div>
                <div class="form-group">
                    <label class="form-label">Telefono</label>
                    <input type="tel" class="form-control" id="contatto-telefono-${contattiCounter}" 
                           placeholder="+39 123 456 7890">
                </div>
                <div class="form-group">
                    <label class="form-label">Priorità</label>
                    <select class="form-select" id="contatto-priorita-${contattiCounter}">
                        <option value="1">Alta</option>
                        <option value="2" selected>Media</option>
                        <option value="3">Bassa</option>
                    </select>
                </div>
            </div>
        `;
        
        contattiList.appendChild(contattoDiv);
    }
    
    function rimuoviContatto(id) {
        const elemento = document.getElementById(`contatto-${id}`);
        if (elemento) {
            elemento.remove();
        }
    }
    
    function resetClienteForm() {
        // Reset form base
        const form = document.getElementById('clienteForm');
        if (form) {
            form.reset();
        }
        
        // Reset contatti
        const contattiList = document.getElementById('contattiList');
        if (contattiList) {
            contattiList.innerHTML = '';
        }
        contattiCounter = 0;
        
        // Aggiungi un contatto di default
        aggiungiContatto();
    }
    
    // Funzione per salvare cliente con contatti
    function saveCliente() {
        const nome = document.getElementById('cliente-nome')?.value?.trim();
        
        if (!nome) {
            showToast('Il nome del cliente è obbligatorio', 'error');
            return;
        }
        
        // Raccogli i dati del cliente
        const clienteData = {
            nome: nome,
            codice_fiscale: document.getElementById('cliente-cf')?.value?.trim() || '',
            telefono: document.getElementById('cliente-telefono')?.value?.trim() || '',
            indirizzo: document.getElementById('cliente-indirizzo')?.value?.trim() || '',
            note: document.getElementById('cliente-note')?.value?.trim() || ''
        };
        
        // Raccogli i contatti
        const contatti = [];
        const contattiItems = document.querySelectorAll('.contatto-item');
        
        contattiItems.forEach(item => {
            const id = item.id.split('-')[1];
            const nome = document.getElementById(`contatto-nome-${id}`)?.value?.trim();
            const email = document.getElementById(`contatto-email-${id}`)?.value?.trim();
            
            if (nome && email) {
                contatti.push({
                    nome: nome,
                    email: email,
                    ruolo: document.getElementById(`contatto-ruolo-${id}`)?.value?.trim() || '',
                    telefono: document.getElementById(`contatto-telefono-${id}`)?.value?.trim() || '',
                    priorita: parseInt(document.getElementById(`contatto-priorita-${id}`)?.value) || 2
                });
            }
        });
        
        console.log('Dati cliente:', clienteData);
        console.log('Contatti:', contatti);
        
        // Simula il salvataggio
        showToast(`Cliente "${nome}" salvato con successo! ${contatti.length} contatti aggiunti.`, 'success');
        
        // Chiudi il modal
        closeModal('clienteModal');
        
        // TODO: Implementare chiamata API reale
        // saveClienteWithContacts(clienteData, contatti);
    }
    
    // Funzione per salvare cascina
    function saveCascina() {
        const clienteId = document.getElementById('cascina-cliente')?.value;
        const nome = document.getElementById('cascina-nome')?.value?.trim();
        
        if (!clienteId || !nome) {
            showToast('Cliente e nome cascina sono obbligatori', 'error');
            return;
        }
        
        showToast(`Cascina "${nome}" salvata con successo!`, 'success');
        closeModal('cascinaModal');
    }
    
    // Funzioni di visualizzazione - compatibili con template esistente
    function viewClients() {
        console.log('Reindirizzamento a aziende...');
        window.location.href = '{% url "aziende" %}';
    }
    
    function viewCascine() {
        console.log('Reindirizzamento a aziende per cascine...');
        window.location.href = '{% url "aziende" %}';
    }
    
    function viewTerreni() {
        console.log('Reindirizzamento a aziende per terreni...');
        window.location.href = '{% url "aziende" %}';
    }
    
    function viewContoterzisti() {
        console.log('Vista contoterzisti non implementata');
        showToast('Lista contoterzisti non ancora implementata. Funzionalità in sviluppo.', 'info');
    }
    
    function viewProdotti() {
        console.log('Vista prodotti non implementata');
        showToast('Lista prodotti non ancora implementata. Funzionalità in sviluppo.', 'info');
    }
    
    function viewContatti() {
        console.log('Reindirizzamento a contatti email...');
        try {
            window.location.href = '{% url "contatti_email" %}';
        } catch (error) {
            console.error('Errore reindirizzamento contatti:', error);
            showToast('Pagina contatti non disponibile', 'error');
        }
    }
    
    // Funzioni aggiuntive per compatibilità
    function generateReports() {
        showToast('Generazione report non ancora implementata. Funzionalità in sviluppo.', 'info');
    }
    
    function viewAnalytics() {
        showToast('Analisi dati non ancora implementata. Funzionalità in sviluppo.', 'info');
    }
    
    // Sistema toast
    function showToast(message, type = 'success') {
        try {
            const toastElement = document.getElementById('liveToast');
            const toastHeader = toastElement.querySelector('.toast-header');
            const toastBody = document.getElementById('toastMessage');
            
            // Configura icona e colore in base al tipo
            let icon, textClass;
            switch(type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle text-success me-2"></i>';
                    textClass = 'text-success';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-triangle text-danger me-2"></i>';
                    textClass = 'text-danger';
                    break;
                case 'info':
                    icon = '<i class="fas fa-info-circle text-info me-2"></i>';
                    textClass = 'text-info';
                    break;
                default:
                    icon = '<i class="fas fa-bell text-primary me-2"></i>';
                    textClass = 'text-primary';
            }
            
            // Aggiorna contenuto
            toastHeader.innerHTML = `
                ${icon}
                <strong class="me-auto ${textClass}">Sistema</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            `;
            toastBody.textContent = message;
            
            // Mostra toast
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        } catch (error) {
            console.error('Errore toast:', error);
            // Fallback con alert
            alert(message);
        }
    }
    
    // Animazione delle statistiche
    function animateStatistics() {
        try {
            const numbers = document.querySelectorAll('.stat-card .number');
            
            numbers.forEach(number => {
                const finalValue = parseInt(number.textContent) || 0;
                let currentValue = 0;
                const increment = Math.ceil(finalValue / 30);
                
                const timer = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= finalValue) {
                        currentValue = finalValue;
                        clearInterval(timer);
                    }
                    number.textContent = currentValue;
                }, 50);
            });
        } catch (error) {
            console.error('Errore animazione statistiche:', error);
        }
    }
    
    // Inizializzazione al caricamento della pagina
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM caricato, inizializzazione...');
        
        try {
            // Anima le statistiche
            animateStatistics();
            
            // Carica dati dal database
            loadInitialData();
            
            // Aggiungi event listeners per i bottoni di chiusura dei modal
            document.querySelectorAll('.modal .btn-secondary').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        closeModal(modal.id);
                    }
                });
            });
            
            console.log('Database Management Interface inizializzata con successo');
            
        } catch (error) {
            console.error('Errore durante l\'inizializzazione:', error);
        }
    });
    
    // Caricamento dati iniziali dal database
    async function loadInitialData() {
        try {
            await Promise.all([
                loadClienti(),
                loadContoterzisti()
            ]);
            console.log('Dati dal database caricati con successo');
        } catch (error) {
            console.error('Errore nel caricamento dati dal database:', error);
        }
    }
    
    // Carica clienti dal database
    async function loadClienti() {
        try {
            const response = await fetch('/api/clienti/list/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    clients = result.clienti;
                    
                    // Popola il select delle cascine
                    const select = document.getElementById('cascina-cliente');
                    if (select) {
                        select.innerHTML = '<option value="">Seleziona cliente...</option>';
                        clients.forEach(client => {
                            select.innerHTML += `<option value="${client.id}">${client.nome}</option>`;
                        });
                    }
                    
                    console.log(`Caricati ${clients.length} clienti dal database`);
                } else {
                    throw new Error(result.error);
                }
            } else {
                throw new Error('Errore nel caricamento clienti');
            }
        } catch (error) {
            console.error('Errore caricamento clienti:', error);
            showToast('Errore nel caricamento dei clienti dal database', 'error');
        }
    }
    
    // Carica contoterzisti dal database
    async function loadContoterzisti() {
        try {
            const response = await fetch('/api/contoterzisti/list/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    contoterzisti = result.contoterzisti;
                    
                    // Popola il select delle cascine
                    const select = document.getElementById('cascina-contoterzista');
                    if (select) {
                        select.innerHTML = '<option value="">Seleziona contoterzista...</option>';
                        contoterzisti.forEach(cont => {
                            select.innerHTML += `<option value="${cont.id}">${cont.nome}</option>`;
                        });
                    }
                    
                    console.log(`Caricati ${contoterzisti.length} contoterzisti dal database`);
                } else {
                    throw new Error(result.error);
                }
            } else {
                throw new Error('Errore nel caricamento contoterzisti');
            }
        } catch (error) {
            console.error('Errore caricamento contoterzisti:', error);
            showToast('Errore nel caricamento dei contoterzisti dal database', 'error');
        }
    }
    
    // Funzione per salvare cliente nel database
    async function saveCliente() {
        const nome = document.getElementById('cliente-nome')?.value?.trim();
        
        if (!nome) {
            showToast('Il nome del cliente è obbligatorio', 'error');
            return;
        }
        
        // Disabilita il bottone durante il salvataggio
        const saveBtn = document.getElementById('saveClienteBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvataggio...';
        
        // Raccogli i contatti
        const contatti = [];
        const contattiItems = document.querySelectorAll('.contatto-item');
        
        contattiItems.forEach(item => {
            const id = item.id.split('-')[1];
            const nome = document.getElementById(`contatto-nome-${id}`)?.value?.trim();
            const email = document.getElementById(`contatto-email-${id}`)?.value?.trim();
            
            if (nome && email) {
                contatti.push({
                    nome: nome,
                    email: email,
                    ruolo: document.getElementById(`contatto-ruolo-${id}`)?.value?.trim() || '',
                    telefono: document.getElementById(`contatto-telefono-${id}`)?.value?.trim() || '',
                    priorita: parseInt(document.getElementById(`contatto-priorita-${id}`)?.value) || 2
                });
            }
        });
        
        const clienteData = {
            nome: nome,
            contatti: contatti
        };
        
        try {
            const response = await fetch('/api/clienti/create/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(clienteData)
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                showToast(result.message + (result.contatti_creati > 0 ? ` con ${result.contatti_creati} contatti` : ''), 'success');
                closeModal('clienteModal');
                
                // Ricarica i dati e le statistiche
                await loadClienti();
                setTimeout(() => window.location.reload(), 1500); // Ricarica pagina per aggiornare statistiche
                
            } else {
                showToast(result.error || 'Errore nel salvataggio del cliente', 'error');
            }
            
        } catch (error) {
            console.error('Errore nel salvataggio cliente:', error);
            showToast('Errore di connessione durante il salvataggio', 'error');
        } finally {
            // Riabilita il bottone
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }
    
    // Funzione per salvare cascina nel database
    async function saveCascina() {
        const clienteId = document.getElementById('cascina-cliente')?.value;
        const nome = document.getElementById('cascina-nome')?.value?.trim();
        
        if (!clienteId || !nome) {
            showToast('Cliente e nome cascina sono obbligatori', 'error');
            return;
        }
        
        // Disabilita il bottone durante il salvataggio
        const saveBtn = document.getElementById('saveCascinaBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvataggio...';
        
        const cascinaData = {
            cliente_id: parseInt(clienteId),
            nome: nome,
            contoterzista_id: document.getElementById('cascina-contoterzista')?.value || null
        };
        
        try {
            const response = await fetch('/api/cascine/create/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(cascinaData)
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                showToast(result.message, 'success');
                closeModal('cascinaModal');
                
                // Ricarica le statistiche
                setTimeout(() => window.location.reload(), 1500);
                
            } else {
                showToast(result.error || 'Errore nel salvataggio della cascina', 'error');
            }
            
        } catch (error) {
            console.error('Errore nel salvataggio cascina:', error);
            showToast('Errore di connessione durante il salvataggio', 'error');
        } finally {
            // Riabilita il bottone
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }
    
    // Funzione per ottenere CSRF token
    function getCsrfToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        
        // Fallback: cerca il token nel DOM
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            return csrfInput.value;
        }
        
        return '';
    } 
    
    // Gestione errori globale per debugging
    window.addEventListener('error', function(e) {
        console.error('Errore JavaScript globale:', {
            message: e.message,
            filename: e.filename,
            lineno: e.lineno,
            colno: e.colno,
            error: e.error
        });
    });
    
    // Test funzione per verificare che tutto funzioni
    function testFunctions() {
        console.log('=== TEST FUNZIONI ===');
        console.log('viewClients:', typeof viewClients);
        console.log('viewCascine:', typeof viewCascine);
        console.log('viewTerreni:', typeof viewTerreni);
        console.log('viewContoterzisti:', typeof viewContoterzisti);
        console.log('viewProdotti:', typeof viewProdotti);
        console.log('openModal:', typeof openModal);
        console.log('showToast:', typeof showToast);
        console.log('aggiungiContatto:', typeof aggiungiContatto);
        console.log('==================');
    }
    
    // Esegui test dopo 1 secondo per essere sicuri che tutto sia caricato
    setTimeout(testFunctions, 1000);
    
</script>
{% endblock %}