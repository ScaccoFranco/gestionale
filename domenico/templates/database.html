{% extends 'base.html' %}

{% block page_title %}Gestione Database{% endblock %}
{% block page_icon %}<i class="fas fa-database"></i>{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #007bff;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --danger-color: #dc3545;
        --purple-color: #6f42c1;
        --light-bg: #f8f9fa;
        --border-color: #dee2e6;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-success: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    /* Stili delle statistiche */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-card .icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        opacity: 0.8;
    }

    .stat-card .number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-card .label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    /* Azioni Rapide */
    .quick-add-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
    }

    .quick-add-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
    }

    .quick-add-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
    }

    .quick-add-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: var(--gradient-success);
        color: white;
        text-decoration: none;
        border-radius: 10px;
        transition: all 0.3s ease;
        min-height: 100px;
        border: none;
        cursor: pointer;
    }

    .quick-add-btn:hover {
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        text-decoration: none;
    }

    .quick-add-btn i {
        font-size: 2rem;
        margin-bottom: 8px;
    }

    /* Sezioni di Gestione */
    .management-sections {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .section-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: var(--shadow);
        transition: transform 0.3s ease;
    }

    .section-card:hover {
        transform: translateY(-3px);
    }

    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .section-header i {
        font-size: 1.5rem;
        color: var(--primary-color);
        margin-right: 10px;
    }

    .section-header h3 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
    }

    .section-description {
        color: #666;
        margin-bottom: 20px;
        line-height: 1.5;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }

    .btn-primary-action {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary-action:hover {
        background: #0056b3;
        color: white;
        text-decoration: none;
    }

    .btn-secondary-action {
        background: #6c757d;
        color: white;
    }

    .btn-secondary-action:hover {
        background: #545b62;
        color: white;
        text-decoration: none;
    }

    /* Stili Modal */
    .modal-header {
        background: var(--gradient-primary);
        color: white;
        border-bottom: none;
    }

    .modal-header .btn-close {
        filter: invert(1);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 10px 15px;
        transition: border-color 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .btn-success {
        background: var(--gradient-success);
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #218838 0%, #1da688 100%);
    }

    /* Loading spinner */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Toast personalizzati */
    .toast-container {
        z-index: 9999;
    }

    /* Stili per contatti dinamici */
    .contatto-item {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        position: relative;
    }

    .contatto-item .btn-remove {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .contatto-item .btn-remove:hover {
        background: #c82333;
    }

    .form-row-inline {
        display: flex;
        gap: 15px;
        align-items: end;
    }

    .form-row-inline .form-group {
        flex: 1;
    }

    /* Modal size fix */
    .modal-lg {
        max-width: 800px;
    }

    /* Responsività */
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .quick-add-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .management-sections {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            flex-direction: column;
        }

        .form-row-inline {
            flex-direction: column;
            gap: 0;
        }

        .modal-lg {
            max-width: 95%;
        }
    }

    .principio-attivo-item {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        position: relative;
    }

    .principio-attivo-item .btn-remove {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: none;
        border: none;
        color: #dc3545;
        font-size: 1rem;
        cursor: pointer;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .principio-attivo-item .btn-remove:hover {
        background-color: #dc3545;
        color: white;
    }

    /* Input group per unità di misura */
    .input-group-text {
        background-color: #e9ecef;
        border-color: #ced4da;
        font-weight: 500;
    }

    /* Preview boxes */
    .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }

    .preview-item {
        margin-bottom: 0.5rem;
    }

    .preview-item strong {
        color: #0c5460;
    }

    /* Form enhancements */
    .form-text {
        font-size: 0.875rem;
        color: #6c757d;
    }

    /* Modal size adjustments */
    .modal-lg {
        max-width: 800px;
    }

    /* Button enhancements */
    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
    }

    .btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }

    /* Loading state for buttons */
    .saving {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .saving .spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Statistiche -->
<div class="stats-grid">
    <div class="stat-card">
        <i class="fas fa-building icon"></i>
        <div class="number">{{ stats.clienti|default:0 }}</div>
        <div class="label">Clienti</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-home icon"></i>
        <div class="number">{{ stats.cascine|default:0 }}</div>
        <div class="label">Cascine</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-seedling icon"></i>
        <div class="number">{{ stats.terreni|default:0 }}</div>
        <div class="label">Terreni</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-user-tie icon"></i>
        <div class="number">{{ stats.contoterzisti|default:0 }}</div>
        <div class="label">Contoterzisti</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-flask icon"></i>
        <div class="number">{{ stats.prodotti|default:0 }}</div>
        <div class="label">Prodotti</div>
    </div>
    <div class="stat-card">
        <i class="fas fa-chart-line icon"></i>
        <div class="number">{{ stats.trattamenti|default:0 }}</div>
        <div class="label">Trattamenti</div>
    </div>
</div>

<!-- Azioni Rapide -->
<div class="quick-add-section">
    <h2 class="quick-add-title">
        <i class="fas fa-plus-circle text-primary me-2"></i>
        Aggiungi Rapidamente
    </h2>
    
    <div class="quick-add-grid">
        <button class="quick-add-btn" onclick="openModal('clienteModal')">
            <i class="fas fa-building"></i>
            <strong>Nuovo Cliente</strong>
        </button>
        
        <button class="quick-add-btn" onclick="openModal('cascinaModal')">
            <i class="fas fa-home"></i>
            <strong>Nuova Cascina</strong>
        </button>
        
        <button class="quick-add-btn" onclick="openModal('terrenoModal')">
            <i class="fas fa-seedling"></i>
            <strong>Nuovo Terreno</strong>
        </button>
        
        <button class="quick-add-btn" onclick="openModal('contoterzastaModal')">
            <i class="fas fa-user-tie"></i>
            <strong>Nuovo Contoterzista</strong>
        </button>
        
        <button class="quick-add-btn" onclick="openModal('prodottoModal')">
            <i class="fas fa-flask"></i>
            <strong>Nuovo Prodotto</strong>
        </button>
    </div>
</div>

<!-- Sezioni di Gestione -->
<div class="management-sections">
    <!-- Gestione Clienti -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-building"></i>
            <h3>Gestione Clienti</h3>
        </div>
        <div class="section-content">
            <p class="section-description">
                Gestisci le aziende agricole, modifica le informazioni di contatto e visualizza la struttura aziendale.
            </p>
            <div class="action-buttons">
                <button class="btn-action btn-primary-action" onclick="viewClients()">
                    <i class="fas fa-eye me-1"></i> Visualizza
                </button>
                <button class="btn-action btn-secondary-action" onclick="openModal('clienteModal')">
                    <i class="fas fa-plus me-1"></i> Aggiungi
                </button>
            </div>
        </div>
    </div>
    
    <!-- Gestione Cascine -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-home"></i>
            <h3>Gestione Cascine</h3>
        </div>
        <div class="section-content">
            <p class="section-description">
                Amministra le cascine, assegna contoterzisti e gestisci la struttura territoriale delle aziende.
            </p>
            <div class="action-buttons">
                <button class="btn-action btn-primary-action" onclick="viewCascine()">
                    <i class="fas fa-eye me-1"></i> Visualizza
                </button>
                <button class="btn-action btn-secondary-action" onclick="openModal('cascinaModal')">
                    <i class="fas fa-plus me-1"></i> Aggiungi
                </button>
            </div>
        </div>
    </div>
    
    <!-- Gestione Terreni -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-seedling"></i>
            <h3>Gestione Terreni</h3>
        </div>
        <div class="section-content">
            <p class="section-description">
                Configura i terreni, specifica le superfici e gestisci le tipologie di coltivazione.
            </p>
            <div class="action-buttons">
                <button class="btn-action btn-primary-action" onclick="viewTerreni()">
                    <i class="fas fa-eye me-1"></i> Visualizza
                </button>
                <button class="btn-action btn-secondary-action" onclick="openModal('terrenoModal')">
                    <i class="fas fa-plus me-1"></i> Aggiungi
                </button>
            </div>
        </div>
    </div>
    
    <!-- Gestione Contoterzisti -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-user-tie"></i>
            <h3>Gestione Contoterzisti</h3>
        </div>
        <div class="section-content">
            <p class="section-description">
                Amministra i contoterzisti, gestisci i contatti e le assegnazioni alle cascine.
            </p>
            <div class="action-buttons">
                <button class="btn-action btn-primary-action" onclick="viewContoterzisti()">
                    <i class="fas fa-eye me-1"></i> Visualizza
                </button>
                <button class="btn-action btn-secondary-action" onclick="openModal('contoterzastaModal')">
                    <i class="fas fa-plus me-1"></i> Aggiungi
                </button>
            </div>
        </div>
    </div>
    
    <!-- Gestione Prodotti -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-flask"></i>
            <h3>Gestione Prodotti</h3>
        </div>
        <div class="section-content">
            <p class="section-description">
                Configura i prodotti fitosanitari, principi attivi e specifiche tecniche per i trattamenti.
            </p>
            <div class="action-buttons">
                <button class="btn-action btn-primary-action" onclick="viewProdotti()">
                    <i class="fas fa-eye me-1"></i> Visualizza
                </button>
                <button class="btn-action btn-secondary-action" onclick="openModal('prodottoModal')">
                    <i class="fas fa-plus me-1"></i> Aggiungi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Contoterzista Semplificato -->
<div class="modal fade" id="contoterzastaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-tie me-2"></i>Nuovo Contoterzista
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="contoterzastaForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label class="form-label">Nome Contoterzista *</label>
                        <input type="text" class="form-control" id="contoterzista-nome" required
                               placeholder="es. Mario Rossi">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" id="contoterzista-email" required
                               placeholder="mario.rossi@esempio.it">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-success" onclick="saveContoterzista()" id="saveContoterzastaBtn">
                    <i class="fas fa-save me-2"></i>Salva Contoterzista
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cliente Semplificato -->
<div class="modal fade" id="clienteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-building me-2"></i>Nuovo Cliente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="clienteForm">
                    {% csrf_token %}
                    
                    <!-- Nome Azienda -->
                    <div class="form-group">
                        <label class="form-label">Nome Azienda *</label>
                        <input type="text" class="form-control" id="cliente-nome" required
                               placeholder="es. Azienda Agricola Rossi">
                    </div>
                    
                    <!-- Contatti Email -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-muted mb-0">CONTATTI EMAIL</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="aggiungiContatto()">
                                <i class="fas fa-plus me-1"></i> Aggiungi Contatto
                            </button>
                        </div>
                        <div id="contattiList">
                            <!-- I contatti verranno aggiunti dinamicamente qui -->
                        </div>
                        <small class="text-muted">I contatti email riceveranno le comunicazioni sui trattamenti</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-success" onclick="saveCliente()" id="saveClienteBtn">
                    <i class="fas fa-save me-2"></i>Salva Cliente
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cascina Semplificato -->
<div class="modal fade" id="cascinaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-home me-2"></i>Nuova Cascina
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cascinaForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label class="form-label">Cliente *</label>
                        <select class="form-select" id="cascina-cliente" required>
                            <option value="">Seleziona cliente...</option>
                            <!-- Popolato dinamicamente da JavaScript -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nome Cascina *</label>
                        <input type="text" class="form-control" id="cascina-nome" required
                               placeholder="es. Cascina del Monte">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Contoterzista</label>
                        <select class="form-select" id="cascina-contoterzista">
                            <option value="">Seleziona contoterzista...</option>
                            <!-- Popolato dinamicamente da JavaScript -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-success" onclick="saveCascina()" id="saveCascinaBtn">
                    <i class="fas fa-save me-2"></i>Salva Cascina
                </button>
            </div>
        </div>
    </div>
</div>


<!-- MODAL TERRENO -->
<div class="modal fade" id="terrenoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-seedling me-2"></i>Nuovo Terreno
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="terrenoForm">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label class="form-label">Cliente *</label>
                        <select class="form-select" id="terreno-cliente" required onchange="loadCascineForTerreno()">
                            <option value="">Seleziona cliente...</option>
                            <!-- Popolato dinamicamente da JavaScript -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Cascina *</label>
                        <select class="form-select" id="terreno-cascina" required>
                            <option value="">Seleziona prima un cliente...</option>
                        </select>
                        <small class="form-text text-muted">Il terreno sarà associato alla cascina selezionata</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nome Terreno *</label>
                        <input type="text" class="form-control" id="terreno-nome" required
                               placeholder="es. Campo Sud, Vigna delle Rose, Terreno 1">
                        <small class="form-text text-muted">Inserisci un nome identificativo per il terreno</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Superficie (ettari) *</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="terreno-superficie" 
                                   required min="0.01" max="1000" step="0.01"
                                   placeholder="es. 2.50">
                            <span class="input-group-text">ha</span>
                        </div>
                        <small class="form-text text-muted">Superficie in ettari (min. 0.01 ha)</small>
                    </div>
                    
                    <!-- Anteprima riepilogo -->
                    <div class="alert alert-info mt-3" id="terrenoPreview" style="display: none;">
                        <h6><i class="fas fa-info-circle me-2"></i>Riepilogo</h6>
                        <div id="terrenoPreviewContent"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-success" onclick="saveTerreno()" id="saveTerrenoBtn">
                    <i class="fas fa-save me-2"></i>Salva Terreno
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PRODOTTO -->
<div class="modal fade" id="prodottoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-flask me-2"></i>Nuovo Prodotto Fitosanitario
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="prodottoForm">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label class="form-label">Nome Prodotto *</label>
                        <input type="text" class="form-control" id="prodotto-nome" required
                               placeholder="es. Roundup, Copper, Zolfo Bagnabile">
                        <small class="form-text text-muted">Nome commerciale del prodotto fitosanitario</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Unità di Misura *</label>
                        <select class="form-select" id="prodotto-unita" required>
                            <option value="">Seleziona unità...</option>
                            <option value="L">Litri (L)</option>
                            <option value="Kg">Chilogrammi (Kg)</option>
                            <option value="g">Grammi (g)</option>
                            <option value="ml">Millilitri (ml)</option>
                            <option value="mg">Milligrammi (mg)</option>
                        </select>
                        <small class="form-text text-muted">Unità di misura per la quantità del prodotto</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Descrizione</label>
                        <textarea class="form-control" id="prodotto-descrizione" rows="3"
                                  placeholder="Descrizione del prodotto, modalità d'uso, caratteristiche..."></textarea>
                    </div>
                    
                    <!-- Principi Attivi -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-muted mb-0">PRINCIPI ATTIVI</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="aggiungiPrincipioAttivo()">
                                <i class="fas fa-plus me-1"></i> Aggiungi Principio Attivo
                            </button>
                        </div>
                        <div id="principiAttiviList">
                            <!-- I principi attivi verranno aggiunti dinamicamente qui -->
                        </div>
                        <small class="text-muted">I principi attivi definiscono la composizione chimica del prodotto</small>
                    </div>
                    
                    <!-- Anteprima riepilogo -->
                    <div class="alert alert-info mt-3" id="prodottoPreview" style="display: none;">
                        <h6><i class="fas fa-info-circle me-2"></i>Riepilogo Prodotto</h6>
                        <div id="prodottoPreviewContent"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-success" onclick="saveProdotto()" id="saveProdottoBtn">
                    <i class="fas fa-save me-2"></i>Salva Prodotto
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-check-circle text-success me-2"></i>
            <strong class="me-auto">Sistema</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            <!-- Messaggio dinamico -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    console.log('Inizializzazione Database Management...');
    
    // Variabili globali per la gestione dei contatti
    let contattiCounter = 0;
    let clients = [];
    let contoterzisti = [];
    
    // Fix per il problema dei modal Bootstrap
    function openModal(modalType) {
        console.log('Apertura modal:', modalType);
        try {
            const modalElement = document.getElementById(modalType);
            if (!modalElement) {
                console.error('Modal non trovato:', modalType);
                alert(`Modal ${modalType} non trovato.`);
                return;
            }
            
            // Metodo alternativo per aprire il modal che evita l'errore Bootstrap
            modalElement.style.display = 'block';
            modalElement.classList.add('show');
            modalElement.setAttribute('aria-modal', 'true');
            modalElement.setAttribute('role', 'dialog');
            modalElement.removeAttribute('aria-hidden');
            
            // Aggiungi backdrop manualmente
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.id = `${modalType}-backdrop`;
            document.body.appendChild(backdrop);
            document.body.classList.add('modal-open');
            
            // Reset form quando si apre il modal
            if (modalType === 'clienteModal') {
                resetClienteForm();
            } else if (modalType === 'contoterzastaModal') {
                resetContoterzastaForm();
            }
            
            // Gestione chiusura con ESC
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    closeModal(modalType);
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
            
            // Gestione chiusura con click sul backdrop
            backdrop.addEventListener('click', () => closeModal(modalType));
            
            // Gestione chiusura con bottone X
            const closeBtn = modalElement.querySelector('.btn-close');
            if (closeBtn) {
                closeBtn.onclick = () => closeModal(modalType);
            }
            
        } catch (error) {
            console.error('Errore apertura modal:', error);
            alert(`Errore nell'apertura del modal ${modalType}`);
        }
    }
    
    function closeModal(modalType) {
        console.log('Chiusura modal:', modalType);
        try {
            const modalElement = document.getElementById(modalType);
            const backdrop = document.getElementById(`${modalType}-backdrop`);
            
            if (modalElement) {
                modalElement.style.display = 'none';
                modalElement.classList.remove('show');
                modalElement.setAttribute('aria-hidden', 'true');
                modalElement.removeAttribute('aria-modal');
                modalElement.removeAttribute('role');
            }
            
            if (backdrop) {
                backdrop.remove();
            }
            
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
            
        } catch (error) {
            console.error('Errore chiusura modal:', error);
        }
    }
    
    // Gestione contatti dinamici semplificati per il cliente (solo email)
    function aggiungiContatto() {
        contattiCounter++;
        const contattiList = document.getElementById('contattiList');
        
        const contattoDiv = document.createElement('div');
        contattoDiv.className = 'contatto-item';
        contattoDiv.id = `contatto-${contattiCounter}`;
        
        contattoDiv.innerHTML = `
            <button type="button" class="btn-remove" onclick="rimuoviContatto(${contattiCounter})">
                <i class="fas fa-times"></i>
            </button>
            <div class="form-group">
                <label class="form-label">Email Contatto</label>
                <input type="email" class="form-control" id="contatto-email-${contattiCounter}" 
                       placeholder="contatto@esempio.it" required>
                <small class="text-muted">Inserisci l'email del referente per questo cliente</small>
            </div>
        `;
        
        contattiList.appendChild(contattoDiv);
    }
    
    function rimuoviContatto(id) {
        const elemento = document.getElementById(`contatto-${id}`);
        if (elemento) {
            elemento.remove();
        }
    }
    
    function resetContoterzastaForm() {
        // Reset form contoterzista
        const form = document.getElementById('contoterzastaForm');
        if (form) {
            form.reset();
        }
    }
    
    function resetClienteForm() {
        // Reset form base
        const form = document.getElementById('clienteForm');
        if (form) {
            form.reset();
        }
        
        // Reset contatti
        const contattiList = document.getElementById('contattiList');
        if (contattiList) {
            contattiList.innerHTML = '';
        }
        contattiCounter = 0;
        
        // Aggiungi un contatto di default
        aggiungiContatto();
    }
    
    // Funzione per salvare cliente con contatti
    function saveCliente() {
        const nome = document.getElementById('cliente-nome')?.value?.trim();
        
        if (!nome) {
            showToast('Il nome del cliente è obbligatorio', 'error');
            return;
        }
        
        // Raccogli i dati del cliente
        const clienteData = {
            nome: nome,
            codice_fiscale: document.getElementById('cliente-cf')?.value?.trim() || '',
            telefono: document.getElementById('cliente-telefono')?.value?.trim() || '',
            indirizzo: document.getElementById('cliente-indirizzo')?.value?.trim() || '',
            note: document.getElementById('cliente-note')?.value?.trim() || ''
        };
        
        // Raccogli i contatti (solo email)
        const contatti = [];
        const contattiItems = document.querySelectorAll('.contatto-item');
        
        contattiItems.forEach(item => {
            const id = item.id.split('-')[1];
            const email = document.getElementById(`contatto-email-${id}`)?.value?.trim();
            
            if (email) {
                contatti.push({
                    email: email
                });
            }
        });
        
        console.log('Dati cliente:', clienteData);
        console.log('Contatti:', contatti);
        
        // Simula il salvataggio
        showToast(`Cliente "${nome}" salvato con successo! ${contatti.length} contatti aggiunti.`, 'success');
        
        // Chiudi il modal
        closeModal('clienteModal');
        
        // TODO: Implementare chiamata API reale
        // saveClienteWithContacts(clienteData, contatti);
    }
    
    // Funzione per salvare cascina
    function saveCascina() {
        const clienteId = document.getElementById('cascina-cliente')?.value;
        const nome = document.getElementById('cascina-nome')?.value?.trim();
        
        if (!clienteId || !nome) {
            showToast('Cliente e nome cascina sono obbligatori', 'error');
            return;
        }
        
        showToast(`Cascina "${nome}" salvata con successo!`, 'success');
        closeModal('cascinaModal');
    }
    
    // Funzioni di visualizzazione - compatibili con template esistente
    function viewClients() {
        console.log('Reindirizzamento a aziende...');
        window.location.href = '{% url "aziende" %}';
    }
    
    function viewCascine() {
        console.log('Reindirizzamento a aziende per cascine...');
        window.location.href = '{% url "aziende" %}';
    }
    
    function viewTerreni() {
        console.log('Reindirizzamento a aziende per terreni...');
        window.location.href = '{% url "aziende" %}';
    }
    
    function viewContoterzisti() {
        console.log('Vista contoterzisti non implementata');
        showToast('Lista contoterzisti non ancora implementata. Funzionalità in sviluppo.', 'info');
    }
    
    function viewProdotti() {
        console.log('Vista prodotti non implementata');
        showToast('Lista prodotti non ancora implementata. Funzionalità in sviluppo.', 'info');
    }
    
    function viewContatti() {
        console.log('Reindirizzamento a contatti email...');
        try {
            window.location.href = '{% url "contatti_email" %}';
        } catch (error) {
            console.error('Errore reindirizzamento contatti:', error);
            showToast('Pagina contatti non disponibile', 'error');
        }
    }
    
    // Funzioni aggiuntive per compatibilità
    function generateReports() {
        showToast('Generazione report non ancora implementata. Funzionalità in sviluppo.', 'info');
    }
    
    function viewAnalytics() {
        showToast('Analisi dati non ancora implementata. Funzionalità in sviluppo.', 'info');
    }
    
    // Sistema toast
    function showToast(message, type = 'success') {
        try {
            const toastElement = document.getElementById('liveToast');
            const toastHeader = toastElement.querySelector('.toast-header');
            const toastBody = document.getElementById('toastMessage');
            
            // Configura icona e colore in base al tipo
            let icon, textClass;
            switch(type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle text-success me-2"></i>';
                    textClass = 'text-success';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-triangle text-danger me-2"></i>';
                    textClass = 'text-danger';
                    break;
                case 'info':
                    icon = '<i class="fas fa-info-circle text-info me-2"></i>';
                    textClass = 'text-info';
                    break;
                default:
                    icon = '<i class="fas fa-bell text-primary me-2"></i>';
                    textClass = 'text-primary';
            }
            
            // Aggiorna contenuto
            toastHeader.innerHTML = `
                ${icon}
                <strong class="me-auto ${textClass}">Sistema</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            `;
            toastBody.textContent = message;
            
            // Mostra toast
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        } catch (error) {
            console.error('Errore toast:', error);
            // Fallback con alert
            alert(message);
        }
    }
    
    // Animazione delle statistiche
    function animateStatistics() {
        try {
            const numbers = document.querySelectorAll('.stat-card .number');
            
            numbers.forEach(number => {
                const finalValue = parseInt(number.textContent) || 0;
                let currentValue = 0;
                const increment = Math.ceil(finalValue / 30);
                
                const timer = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= finalValue) {
                        currentValue = finalValue;
                        clearInterval(timer);
                    }
                    number.textContent = currentValue;
                }, 50);
            });
        } catch (error) {
            console.error('Errore animazione statistiche:', error);
        }
    }
    
    // Inizializzazione al caricamento della pagina
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM caricato, inizializzazione...');
        
        try {
            // Anima le statistiche
            animateStatistics();
            
            // Carica dati dal database
            loadInitialData();
            
            // Aggiungi event listeners per i bottoni di chiusura dei modal
            document.querySelectorAll('.modal .btn-secondary').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        closeModal(modal.id);
                    }
                });
            });
            
            console.log('Database Management Interface inizializzata con successo');
            
        } catch (error) {
            console.error('Errore durante l\'inizializzazione:', error);
        }
    });
    
    // Caricamento dati iniziali dal database
    async function loadInitialData() {
        try {
            await Promise.all([
                loadClienti(),
                loadContoterzisti()
            ]);
            console.log('Dati dal database caricati con successo');
        } catch (error) {
            console.error('Errore nel caricamento dati dal database:', error);
        }
    }
    
    // Carica clienti dal database
    async function loadClienti() {
        try {
            const response = await fetch('/api/clienti/list/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    clients = result.clienti;
                    
                    // Popola il select delle cascine
                    const select = document.getElementById('cascina-cliente');
                    if (select) {
                        select.innerHTML = '<option value="">Seleziona cliente...</option>';
                        clients.forEach(client => {
                            select.innerHTML += `<option value="${client.id}">${client.nome}</option>`;
                        });
                    }
                    
                    console.log(`Caricati ${clients.length} clienti dal database`);
                } else {
                    throw new Error(result.error);
                }
            } else {
                throw new Error('Errore nel caricamento clienti');
            }
        } catch (error) {
            console.error('Errore caricamento clienti:', error);
            showToast('Errore nel caricamento dei clienti dal database', 'error');
        }
    }
    
    // Carica contoterzisti dal database
    async function loadContoterzisti() {
        try {
            const response = await fetch('/api/contoterzisti/list/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    contoterzisti = result.contoterzisti;
                    
                    // Popola il select delle cascine
                    const select = document.getElementById('cascina-contoterzista');
                    if (select) {
                        select.innerHTML = '<option value="">Seleziona contoterzista...</option>';
                        contoterzisti.forEach(cont => {
                            select.innerHTML += `<option value="${cont.id}">${cont.nome}</option>`;
                        });
                    }
                    
                    console.log(`Caricati ${contoterzisti.length} contoterzisti dal database`);
                } else {
                    throw new Error(result.error);
                }
            } else {
                throw new Error('Errore nel caricamento contoterzisti');
            }
        } catch (error) {
            console.error('Errore caricamento contoterzisti:', error);
            showToast('Errore nel caricamento dei contoterzisti dal database', 'error');
        }
    }
    
    // Funzione per salvare cliente nel database
    async function saveCliente() {
        const nome = document.getElementById('cliente-nome')?.value?.trim();
        
        if (!nome) {
            showToast('Il nome del cliente è obbligatorio', 'error');
            return;
        }
        
        // Disabilita il bottone durante il salvataggio
        const saveBtn = document.getElementById('saveClienteBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvataggio...';
        
        // Raccogli i contatti
        const contatti = [];
        const contattiItems = document.querySelectorAll('.contatto-item');
        
        contattiItems.forEach(item => {
            const id = item.id.split('-')[1];
            const nome = document.getElementById(`contatto-nome-${id}`)?.value?.trim();
            const email = document.getElementById(`contatto-email-${id}`)?.value?.trim();
            
            if (nome && email) {
                contatti.push({
                    nome: nome,
                    email: email
                });
            }
        });
        
        const clienteData = {
            nome: nome,
            contatti: contatti
        };
        
        try {
            const response = await fetch('/api/clienti/create/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(clienteData)
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                showToast(result.message + (result.contatti_creati > 0 ? ` con ${result.contatti_creati} contatti` : ''), 'success');
                closeModal('clienteModal');
                
                // Ricarica i dati e le statistiche
                await loadClienti();
                setTimeout(() => window.location.reload(), 1500); // Ricarica pagina per aggiornare statistiche
                
            } else {
                showToast(result.error || 'Errore nel salvataggio del cliente', 'error');
            }
            
        } catch (error) {
            console.error('Errore nel salvataggio cliente:', error);
            showToast('Errore di connessione durante il salvataggio', 'error');
        } finally {
            // Riabilita il bottone
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }
    
    // Funzione per salvare cascina nel database
    async function saveCascina() {
        const clienteId = document.getElementById('cascina-cliente')?.value;
        const nome = document.getElementById('cascina-nome')?.value?.trim();
        
        if (!clienteId || !nome) {
            showToast('Cliente e nome cascina sono obbligatori', 'error');
            return;
        }
        
        // Disabilita il bottone durante il salvataggio
        const saveBtn = document.getElementById('saveCascinaBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvataggio...';
        
        const cascinaData = {
            cliente_id: parseInt(clienteId),
            nome: nome,
            contoterzista_id: document.getElementById('cascina-contoterzista')?.value || null
        };
        
        try {
            const response = await fetch('/api/cascine/create/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(cascinaData)
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                showToast(result.message, 'success');
                closeModal('cascinaModal');
                
                // Ricarica le statistiche
                setTimeout(() => window.location.reload(), 1500);
                
            } else {
                showToast(result.error || 'Errore nel salvataggio della cascina', 'error');
            }
            
        } catch (error) {
            console.error('Errore nel salvataggio cascina:', error);
            showToast('Errore di connessione durante il salvataggio', 'error');
        } finally {
            // Riabilita il bottone
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }

        
     // Funzione per salvare contoterzista nel database
    async function saveContoterzista() {
        const nome = document.getElementById('contoterzista-nome')?.value?.trim();
        const email = document.getElementById('contoterzista-email')?.value?.trim();
        
        if (!nome) {
            showToast('Il nome del contoterzista è obbligatorio', 'error');
            return;
        }
        
        if (!email) {
            showToast('L\'email è obbligatoria', 'error');
            return;
        }
        
        // Disabilita il bottone durante il salvataggio
        const saveBtn = document.getElementById('saveContoterzastaBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvataggio...';
        
        const contoterzastaData = {
            nome: nome,
            email: email
        };
        
        try {
            const response = await fetch('/api/contoterzisti/create/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(contoterzastaData)
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                showToast(result.message, 'success');
                closeModal('contoterzastaModal');
                
                // Ricarica i contoterzisti e le statistiche
                await loadContoterzisti();
                setTimeout(() => window.location.reload(), 1500);
                
            } else {
                showToast(result.error || 'Errore nel salvataggio del contoterzista', 'error');
            }
            
        } catch (error) {
            console.error('Errore nel salvataggio contoterzista:', error);
            showToast('Errore di connessione durante il salvataggio', 'error');
        } finally {
            // Riabilita il bottone
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }
    
    // Funzione per ottenere CSRF token
    function getCsrfToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        
        // Fallback: cerca il token nel DOM
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            return csrfInput.value;
        }
        
        return '';
    } 
    
    // Gestione errori globale per debugging
    window.addEventListener('error', function(e) {
        console.error('Errore JavaScript globale:', {
            message: e.message,
            filename: e.filename,
            lineno: e.lineno,
            colno: e.colno,
            error: e.error
        });
    });
    
    // Test funzione per verificare che tutto funzioni
    function testFunctions() {
        console.log('=== TEST FUNZIONI ===');
        console.log('viewClients:', typeof viewClients);
        console.log('viewCascine:', typeof viewCascine);
        console.log('viewTerreni:', typeof viewTerreni);
        console.log('viewContoterzisti:', typeof viewContoterzisti);
        console.log('viewProdotti:', typeof viewProdotti);
        console.log('openModal:', typeof openModal);
        console.log('showToast:', typeof showToast);
        console.log('aggiungiContatto:', typeof aggiungiContatto);
        console.log('==================');
    }
    
    // Esegui test dopo 1 secondo per essere sicuri che tutto sia caricato
    setTimeout(testFunctions, 1000);

    // FUNZIONI PER GESTIONE MODAL TERRENI E PRODOTTI

    // Variabili globali
    let principiAttiviCounter = 0;
    let clientiData = [];
    let cascineData = [];

    // Inizializza i dati quando la pagina è caricata
    document.addEventListener('DOMContentLoaded', function() {
        loadClientiData();
    });

    // ============ FUNZIONI TERRENI ============

    function loadClientiData() {
        console.log('🔄 Caricamento dati clienti...');
        
        // Simula caricamento clienti (sostituisci con API reale se disponibile)
        fetch('/api/clienti/')
            .then(response => response.json())
            .then(data => {
                clientiData = data;
                populateClienteSelects();
                console.log('✅ Clienti caricati:', data.length);
            })
            .catch(error => {
                console.error('❌ Errore caricamento clienti:', error);
                // Fallback: usa dati del template se disponibili
                clientiData = {{ clienti|default:"[]"|safe }};
                populateClienteSelects();
            });
    }

    function populateClienteSelects() {
        const selects = ['terreno-cliente', 'cascina-cliente'];
        
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select && clientiData.length > 0) {
                select.innerHTML = '<option value="">Seleziona cliente...</option>';
                clientiData.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nome;
                    select.appendChild(option);
                });
            }
        });
    }

    function loadCascineForTerreno() {
        const clienteId = document.getElementById('terreno-cliente').value;
        const cascinaSelect = document.getElementById('terreno-cascina');
        
        console.log('🔄 Caricamento cascine per cliente:', clienteId);
        
        cascinaSelect.innerHTML = '<option value="">Caricamento...</option>';
        
        if (clienteId) {
            fetch(`/api/cascine/${clienteId}/`)
                .then(response => response.json())
                .then(data => {
                    cascinaSelect.innerHTML = '<option value="">Seleziona cascina...</option>';
                    
                    data.forEach(cascina => {
                        const option = document.createElement('option');
                        option.value = cascina.id;
                        option.textContent = `${cascina.nome} (${cascina.superficie_totale || 0} ha totali)`;
                        cascinaSelect.appendChild(option);
                    });
                    
                    console.log('✅ Cascine caricate:', data.length);
                    updateTerrenoPreview();
                })
                .catch(error => {
                    console.error('❌ Errore caricamento cascine:', error);
                    cascinaSelect.innerHTML = '<option value="">Errore nel caricamento</option>';
                });
        } else {
            cascinaSelect.innerHTML = '<option value="">Seleziona prima un cliente...</option>';
        }
        
        updateTerrenoPreview();
    }

    function updateTerrenoPreview() {
        const clienteSelect = document.getElementById('terreno-cliente');
        const cascinaSelect = document.getElementById('terreno-cascina');
        const nomeInput = document.getElementById('terreno-nome');
        const superficieInput = document.getElementById('terreno-superficie');
        const preview = document.getElementById('terrenoPreview');
        const previewContent = document.getElementById('terrenoPreviewContent');
        
        const clienteNome = clienteSelect.options[clienteSelect.selectedIndex]?.textContent || '';
        const cascinaText = cascinaSelect.options[cascinaSelect.selectedIndex]?.textContent || '';
        const nome = nomeInput.value.trim();
        const superficie = superficieInput.value;
        
        if (clienteNome && cascinaText && nome && superficie) {
            previewContent.innerHTML = `
                <div class="preview-item"><strong>Cliente:</strong> ${clienteNome}</div>
                <div class="preview-item"><strong>Cascina:</strong> ${cascinaText}</div>
                <div class="preview-item"><strong>Nome Terreno:</strong> ${nome}</div>
                <div class="preview-item"><strong>Superficie:</strong> ${superficie} ettari</div>
            `;
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }

    // Event listeners per anteprima terreno
    document.addEventListener('DOMContentLoaded', function() {
        const terrenoInputs = ['terreno-cliente', 'terreno-cascina', 'terreno-nome', 'terreno-superficie'];
        terrenoInputs.forEach(inputId => {
            const element = document.getElementById(inputId);
            if (element) {
                element.addEventListener('change', updateTerrenoPreview);
                element.addEventListener('input', updateTerrenoPreview);
            }
        });
    });

    function saveTerreno() {
        console.log('💾 Salvataggio terreno...');
        
        // Validazione
        const clienteId = document.getElementById('terreno-cliente').value;
        const cascinaId = document.getElementById('terreno-cascina').value;
        const nome = document.getElementById('terreno-nome').value.trim();
        const superficie = document.getElementById('terreno-superficie').value;
        
        if (!clienteId) {
            alert('Seleziona un cliente');
            return;
        }
        
        if (!cascinaId) {
            alert('Seleziona una cascina');
            return;
        }
        
        if (!nome) {
            alert('Inserisci il nome del terreno');
            return;
        }
        
        if (!superficie || parseFloat(superficie) <= 0) {
            alert('Inserisci una superficie valida');
            return;
        }
        
        // Mostra loading
        const saveBtn = document.getElementById('saveTerrenoBtn');
        saveBtn.innerHTML = '<span class="spinner"></span>Salvando...';
        saveBtn.classList.add('saving');
        
        // Prepara dati
        const formData = new FormData();
        formData.append('cascina_id', cascinaId);
        formData.append('nome', nome);
        formData.append('superficie', superficie);
        formData.append('csrfmiddlewaretoken', getCsrfToken());
        
        // Debug
        console.log('📤 Dati terreno:', {
            cascina_id: cascinaId,
            nome: nome,
            superficie: superficie
        });
        
        // Chiamata API (da implementare)
        fetch('/api/terreni/create/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('✅ Terreno salvato:', data);
                alert('✅ Terreno creato con successo!');
                
                // Reset form
                document.getElementById('terrenoForm').reset();
                document.getElementById('terrenoPreview').style.display = 'none';
                
                // Chiudi modal
                closeModal('terrenoModal');
                
                // Opzionale: ricarica pagina o aggiorna stats
                setTimeout(() => location.reload(), 1000);
                
            } else {
                console.error('❌ Errore dal server:', data.error);
                alert('Errore nel salvataggio: ' + (data.error || 'Errore sconosciuto'));
            }
        })
        .catch(error => {
            console.error('❌ Errore di connessione:', error);
            alert('Errore di connessione: ' + error.message);
        })
        .finally(() => {
            // Reset pulsante
            saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Salva Terreno';
            saveBtn.classList.remove('saving');
        });
    }

    // ============ FUNZIONI PRODOTTI ============

    function aggiungiPrincipioAttivo() {
        principiAttiviCounter++;
        const principiList = document.getElementById('principiAttiviList');
        
        const principioDiv = document.createElement('div');
        principioDiv.className = 'principio-attivo-item';
        principioDiv.id = `principio-${principiAttiviCounter}`;
        
        principioDiv.innerHTML = `
            <button type="button" class="btn-remove" onclick="rimuoviPrincipioAttivo(${principiAttiviCounter})">
                <i class="fas fa-times"></i>
            </button>
            <div class="form-group mb-0">
                <label class="form-label">Nome Principio Attivo *</label>
                <input type="text" class="form-control" id="principio-nome-${principiAttiviCounter}" 
                    placeholder="es. Glifosate, Rame, Zolfo" required
                    onchange="updateProdottoPreview()">
                <small class="form-text text-muted">Nome del principio attivo contenuto nel prodotto</small>
            </div>
        `;
        
        principiList.appendChild(principioDiv);
        
        console.log('➕ Principio attivo aggiunto:', principiAttiviCounter);
        updateProdottoPreview();
    }

    function rimuoviPrincipioAttivo(id) {
        const principioDiv = document.getElementById(`principio-${id}`);
        if (principioDiv) {
            principioDiv.remove();
            console.log('➖ Principio attivo rimosso:', id);
            updateProdottoPreview();
        }
    }

    function updateProdottoPreview() {
        const nome = document.getElementById('prodotto-nome').value.trim();
        const unita = document.getElementById('prodotto-unita').value;
        const descrizione = document.getElementById('prodotto-descrizione').value.trim();
        const preview = document.getElementById('prodottoPreview');
        const previewContent = document.getElementById('prodottoPreviewContent');
        
        // Raccogli principi attivi
        const principiAttivi = [];
        const principiInputs = document.querySelectorAll('[id^="principio-nome-"]');
        principiInputs.forEach(input => {
            if (input.value.trim()) {
                principiAttivi.push(input.value.trim());
            }
        });
        
        if (nome && unita) {
            let previewHTML = `
                <div class="preview-item"><strong>Nome:</strong> ${nome}</div>
                <div class="preview-item"><strong>Unità di Misura:</strong> ${unita}</div>
            `;
            
            if (descrizione) {
                previewHTML += `<div class="preview-item"><strong>Descrizione:</strong> ${descrizione.substring(0, 100)}${descrizione.length > 100 ? '...' : ''}</div>`;
            }
            
            if (principiAttivi.length > 0) {
                previewHTML += `<div class="preview-item"><strong>Principi Attivi:</strong> ${principiAttivi.join(', ')}</div>`;
            }
            
            previewContent.innerHTML = previewHTML;
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }

    // Event listeners per anteprima prodotto
    document.addEventListener('DOMContentLoaded', function() {
        const prodottoInputs = ['prodotto-nome', 'prodotto-unita', 'prodotto-descrizione'];
        prodottoInputs.forEach(inputId => {
            const element = document.getElementById(inputId);
            if (element) {
                element.addEventListener('change', updateProdottoPreview);
                element.addEventListener('input', updateProdottoPreview);
            }
        });
    });

    function saveProdotto() {
        console.log('💾 Salvataggio prodotto...');
        
        // Validazione
        const nome = document.getElementById('prodotto-nome').value.trim();
        const unita = document.getElementById('prodotto-unita').value;
        const descrizione = document.getElementById('prodotto-descrizione').value.trim();
        
        if (!nome) {
            alert('Inserisci il nome del prodotto');
            return;
        }
        
        if (!unita) {
            alert('Seleziona l\'unità di misura');
            return;
        }
        
        // Raccogli principi attivi
        const principiAttivi = [];
        const principiInputs = document.querySelectorAll('[id^="principio-nome-"]');
        principiInputs.forEach(input => {
            const value = input.value.trim();
            if (value) {
                principiAttivi.push(value);
            }
        });
        
        if (principiAttivi.length === 0) {
            alert('Aggiungi almeno un principio attivo');
            return;
        }
        
        // Mostra loading
        const saveBtn = document.getElementById('saveProdottoBtn');
        saveBtn.innerHTML = '<span class="spinner"></span>Salvando...';
        saveBtn.classList.add('saving');
        
        // Prepara dati
        const formData = new FormData();
        formData.append('nome', nome);
        formData.append('unita_misura', unita);
        formData.append('descrizione', descrizione);
        formData.append('principi_attivi', JSON.stringify(principiAttivi));
        formData.append('csrfmiddlewaretoken', getCsrfToken());
        
        // Debug
        console.log('📤 Dati prodotto:', {
            nome: nome,
            unita_misura: unita,
            descrizione: descrizione,
            principi_attivi: principiAttivi
        });
        
        // Chiamata API (da implementare)
        fetch('/api/prodotti/create/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('✅ Prodotto salvato:', data);
                alert('✅ Prodotto creato con successo!');
                
                // Reset form
                document.getElementById('prodottoForm').reset();
                document.getElementById('principiAttiviList').innerHTML = '';
                document.getElementById('prodottoPreview').style.display = 'none';
                principiAttiviCounter = 0;
                
                // Chiudi modal
                closeModal('prodottoModal');
                
                // Opzionale: ricarica pagina o aggiorna stats
                setTimeout(() => location.reload(), 1000);
                
            } else {
                console.error('❌ Errore dal server:', data.error);
                alert('Errore nel salvataggio: ' + (data.error || 'Errore sconosciuto'));
            }
        })
        .catch(error => {
            console.error('❌ Errore di connessione:', error);
            alert('Errore di connessione: ' + error.message);
        })
        .finally(() => {
            // Reset pulsante
            saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Salva Prodotto';
            saveBtn.classList.remove('saving');
        });
    }

    // ============ FUNZIONI DI UTILITÀ ============

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function resetAllForms() {
        // Reset form terreno
        const terrenoForm = document.getElementById('terrenoForm');
        if (terrenoForm) {
            terrenoForm.reset();
            document.getElementById('terrenoPreview').style.display = 'none';
        }
        
        // Reset form prodotto
        const prodottoForm = document.getElementById('prodottoForm');
        if (prodottoForm) {
            prodottoForm.reset();
            document.getElementById('principiAttiviList').innerHTML = '';
            document.getElementById('prodottoPreview').style.display = 'none';
            principiAttiviCounter = 0;
        }
        
        // Reset form contoterzista
        const contoterzastaForm = document.getElementById('contoterzastaForm');
        if (contoterzastaForm) {
            contoterzastaForm.reset();
        }
    }

    // Event listeners per reset automatico quando si chiudono i modal
    document.addEventListener('DOMContentLoaded', function() {
        const modals = ['terrenoModal', 'prodottoModal', 'contoterzastaModal'];
        
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.addEventListener('hidden.bs.modal', function() {
                    console.log(`🔄 Reset form per modal: ${modalId}`);
                    resetAllForms();
                });
            }
        });
    });

    // ============ INIZIALIZZAZIONE MODAL ============

    // Aggiungi principio attivo di default quando si apre il modal prodotto
    document.addEventListener('DOMContentLoaded', function() {
        const prodottoModal = document.getElementById('prodottoModal');
        if (prodottoModal) {
            prodottoModal.addEventListener('shown.bs.modal', function() {
                console.log('📱 Modal prodotto aperto');
                
                // Aggiungi un principio attivo di default se la lista è vuota
                if (document.getElementById('principiAttiviList').children.length === 0) {
                    setTimeout(() => aggiungiPrincipioAttivo(), 200);
                }
            });
        }
    });

    function updateStats() {
    console.log('📊 Aggiornamento statistiche...');
    
    fetch('/api/database/stats/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.stats;
                
                // Aggiorna i numeri nelle card statistiche
                updateStatCard('clienti', stats.clienti);
                updateStatCard('cascine', stats.cascine);
                updateStatCard('terreni', stats.terreni);
                updateStatCard('contoterzisti', stats.contoterzisti);
                updateStatCard('prodotti', stats.prodotti);
                updateStatCard('principi_attivi', stats.principi_attivi);
                
                // Aggiorna superficie totale se presente
                if (stats.superficie_totale !== undefined) {
                    updateSuperficieTotale(stats.superficie_totale);
                }
                
                console.log('✅ Statistiche aggiornate:', stats);
            }
        })
        .catch(error => {
            console.error('❌ Errore aggiornamento statistiche:', error);
        });
}

function updateStatCard(type, value) {
    // Cerca la card delle statistiche per tipo
    const possibleSelectors = [
        `.stat-card:has(.icon.fa-${getIconClass(type)}) .number`,
        `[data-stat="${type}"] .number`,
        `.${type}-stat .number`
    ];
    
    for (const selector of possibleSelectors) {
        try {
            const element = document.querySelector(selector);
            if (element) {
                // Animazione del cambio numero
                animateNumberChange(element, value);
                return;
            }
        } catch (e) {
            // Ignora errori di selezione CSS
        }
    }
    
    console.log(`⚠️ Card statistica non trovata per: ${type}`);
}

function getIconClass(type) {
    const iconMap = {
        'clienti': 'building',
        'cascine': 'home',
        'terreni': 'seedling',
        'contoterzisti': 'user-tie',
        'prodotti': 'flask',
        'principi_attivi': 'atom'
    };
    return iconMap[type] || 'circle';
}

function animateNumberChange(element, newValue) {
    const currentValue = parseInt(element.textContent) || 0;
    
    if (currentValue === newValue) return;
    
    // Aggiungi classe di animazione
    element.classList.add('updating');
    
    // Animazione conteggio
    const duration = 800;
    const steps = 20;
    const increment = (newValue - currentValue) / steps;
    let current = currentValue;
    let step = 0;
    
    const timer = setInterval(() => {
        step++;
        current += increment;
        
        if (step >= steps) {
            element.textContent = newValue;
            clearInterval(timer);
            element.classList.remove('updating');
        } else {
            element.textContent = Math.round(current);
        }
    }, duration / steps);
}

function updateSuperficieTotale(superficie) {
    // Cerca elemento superficie totale
    const superficieElement = document.querySelector('.superficie-totale, [data-superficie-totale]');
    if (superficieElement) {
        superficieElement.textContent = `${superficie.toFixed(2)} ha`;
    }
}

// ============ AUTO-REFRESH STATISTICHE ============

// Aggiorna statistiche dopo ogni operazione di salvataggio
function scheduleStatsUpdate() {
    // Ritarda l'aggiornamento per dare tempo al server di processare
    setTimeout(updateStats, 1500);
}

// Override delle funzioni di salvataggio per includere aggiornamento stats
const originalSaveTerreno = window.saveTerreno;
if (originalSaveTerreno) {
    window.saveTerreno = function() {
        const result = originalSaveTerreno.apply(this, arguments);
        scheduleStatsUpdate();
        return result;
    };
}

const originalSaveProdotto = window.saveProdotto;
if (originalSaveProdotto) {
    window.saveProdotto = function() {
        const result = originalSaveProdotto.apply(this, arguments);
        scheduleStatsUpdate();
        return result;
    };
}

const originalSaveContoterzasta = window.saveContoterzasta;
if (originalSaveContoterzasta) {
    window.saveContoterzasta = function() {
        const result = originalSaveContoterzasta.apply(this, arguments);
        scheduleStatsUpdate();
        return result;
    };
}

</script>
{% endblock %}